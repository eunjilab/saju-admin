# 사주 MD 생성 에이전트 시스템 계획

## 전체 흐름 (간단 버전)

```
스텝5                    스텝6
┌─────────┐             ┌────────────────────────────────────────┐
│ 프롬프트 │ ──────────▶│  에이전트1    에이전트2                 │
│ 생성기  │             │  (MD 생성) ─▶ (검증/수정) ─▶ 완성 MD   │
└─────────┘             └────────────────────────────────────────┘
```

---

## 핵심 아이디어: 섹션별 분할 생성

- **문제**: 단일 API 호출로 42-46페이지 생성 불가 (max_tokens, Netlify 10초 제한)
- **해결**: 7개 섹션으로 나눠서 순차 생성

```
프롬프트
   │
   ▼
┌──────────────────────────────────────────────────────────────┐
│                      에이전트1: MD 생성                       │
│                                                              │
│   섹션1        섹션2        섹션3        섹션4                │
│  ┌─────┐     ┌─────┐     ┌─────┐     ┌─────┐               │
│  │표지 │ ──▶ │오행 │ ──▶ │신살 │ ──▶ │올해 │ ──▶ ...      │
│  │기본 │     │십성 │     │격국 │     │운세 │               │
│  └─────┘     └─────┘     └─────┘     └─────┘               │
│     │           │           │           │                    │
│     └───────────┴───────────┴───────────┘                    │
│                      │                                        │
│                      ▼                                        │
│              전체 MD 합치기                                    │
└──────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌──────────────────────────────────────────────────────────────┐
│                    에이전트2: 검증/수정                        │
│                                                              │
│   원본 프롬프트의 계산값  vs  MD 파일의 계산값                 │
│          │                         │                          │
│          └─────────┬───────────────┘                          │
│                    │                                          │
│              불일치 발견?                                      │
│              YES → 자동 수정                                   │
│              NO  → 통과                                        │
└──────────────────────────────────────────────────────────────┘
                          │
                          ▼
                    ✅ 완성된 MD
```

---

## 섹션 구성 (총 7개)

| 섹션 | 내용 | 페이지 (프리미엄) |
|------|------|------------------|
| 1. 표지+기본정보 | 표지, 고객정보, 사주 명식, 일간 분석 | 1~5 |
| 2. 오행+십성 | 오행 분포, 십성 분석, 성격/기질 | 6~12 |
| 3. 신살+격국 | 신살 분석, 격국용신, 대운 흐름 | 13~20 |
| 4. 올해운세 | 2025/2026년 세운, 월별 운세 | 21~28 |
| 5. 분야별운세 | 연애/결혼, 직업/재물, 건강 | 29~35 |
| 6. 인연상 | 배우자상, 인연수, 만남시기 | 36~40 |
| 7. 맞춤답변+마무리 | 질문 답변, 행운 포인트, 마무리 | 41~46 |

---

## 에이전트1: MD 생성

### 동작 방식

```
입력: 프롬프트 (고객정보 + 사주계산 + 인연상계산 + 질문)

for each 섹션 in [1, 2, 3, 4, 5, 6, 7]:

  1. 해당 섹션 프롬프트 준비
     - 시스템 프롬프트: 섹션별 전용 프롬프트
     - 사용자 프롬프트: 고객정보 + 이전 섹션 요약

  2. Claude API 호출
     model: claude-sonnet-4
     max_tokens: 6000

  3. 응답 확인
     - 완료 마커 있음? → 다음 섹션
     - 없음? → 이어쓰기 요청 (최대 3회)

  4. 결과 저장

출력: 전체 MD 파일 (7개 섹션 합침)
```

### 가이드 활용

```
⚠️ 전체 가이드를 API에 넣으면 너무 길어서
→ 핵심 요약본(guide-summaries.js)을 시스템 프롬프트에 삽입

섹션별로 필요한 가이드만 선택:

섹션2 (오행+십성)
  └─ 참조: 02_십성_해석.md 요약, 오행-건강 연결표

섹션3 (신살+격국)
  └─ 참조: 05_신살_48종.md 요약, 07_격국용신.md 요약

섹션6 (인연상)
  └─ 참조: 배우자상 해석 기준

📌 핵심 규칙:
- 해석 방법 = 가이드 참조
- 계산값 = 프롬프트의 계산기 결과만 사용 (절대 창작 금지!)
```

### 출력 형식

```markdown
<!-- META
이름: 신은지
생년월일: 1995년 3월 15일
시간: 14시 30분
성별: 여성
패키지: 프리미엄
총 페이지: 44
-->

<!-- 페이지 1: 표지 -->
(표지 내용)

---

<!-- 페이지 2: 목차 -->
(목차 내용)

---

... (계속)

<!-- 소름 -->
소름 돋는 내용
<!-- /소름 -->

[인연상_이미지_삽입]

<!-- 마무리멘트 -->
마무리 메시지
<!-- /마무리멘트 -->
```

---

## 에이전트2: 검증/수정

### 검증 항목 체크리스트

```
📋 기본 정보
├─ [ ] 이름 일치
├─ [ ] 생년월일 일치
├─ [ ] 성별 일치
└─ [ ] 패키지 일치

📋 사주 팔자 (가장 중요!)
├─ [ ] 연주 (예: 乙亥) 일치
├─ [ ] 월주 (예: 己卯) 일치
├─ [ ] 일주 (예: 壬寅) 일치
└─ [ ] 시주 (예: 丙午) 일치

📋 십성
├─ [ ] 천간 십성 4개 일치 (연간, 월간, 일간, 시간)
└─ [ ] 지지 십성 4개 일치 (연지, 월지, 일지, 시지)

📋 오행
├─ [ ] 木 개수 일치
├─ [ ] 火 개수 일치
├─ [ ] 土 개수 일치
├─ [ ] 金 개수 일치
└─ [ ] 水 개수 일치

📋 신살 (⚠️ 특히 주의!)
├─ [ ] 계산기 결과에 있는 신살만 언급됨
├─ [ ] 추가로 창작된 신살 없음
└─ [ ] 각 신살의 위치(연/월/일/시) 정확

📋 대운/세운
├─ [ ] 대운 시작 나이 일치
├─ [ ] 대운 순서 일치
├─ [ ] 현재 대운 정확
└─ [ ] 2026년 세운 = 병오(丙午)

📋 인연상 (프리미엄만)
├─ [ ] 배우자 띠 일치
├─ [ ] 배우자 오행 일치
└─ [ ] 상성 결과 일치

📋 형식
├─ [ ] META 블록 있음
├─ [ ] 페이지 구분 태그 있음
└─ [ ] [인연상_이미지_삽입] 태그 있음 (프리미엄)
```

### 검증 동작 방식

```
입력:
- 원본 프롬프트 (계산기 결과 포함)
- 생성된 MD 파일

STEP 1: 원본 프롬프트에서 계산값 추출
────────────────────────────────────────
정규식으로 파싱:
- 사주 팔자: /연주:\s*(\S+)/
- 십성: /연간십성:\s*(\S+)/
- 오행: /木:\s*(\d+)개/
- 신살 목록: /신살.*?:\s*(.+)/
- 대운: /대운.*?:\s*(.+)/

결과: { saju, sipsung, oheng, sinsal, daeun, ... }

STEP 2: MD 파일에서 같은 값 추출
────────────────────────────────────
정규식으로 파싱 (다양한 패턴 고려):
- "사주: 乙亥 己卯 壬寅 丙午"
- "木이 3개"
- "천을귀인이 있어서..."

STEP 3: 비교 & 오류 탐지
────────────────────────────────────
for each 항목:
  if (원본값 !== MD값):
    오류목록.push({
      type: '오행_불일치',
      위치: '페이지 5',
      원본: '木3',
      MD값: '木4'
    })

STEP 4: 자동 수정
────────────────────────────────────
for each 오류 in 오류목록:
  MD내용 = MD내용.replace(오류.MD값, 오류.원본)

⚠️ 주의: 단순 치환이 위험한 경우
- "木4개" vs "4명" 등 다른 맥락
- 해결: 주변 컨텍스트 포함해서 치환

출력:
- 수정된 MD 파일
- 검증 결과 리포트 (어떤 항목이 수정됐는지)
```

---

## 스텝6 UI 변경

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        새로운 스텝6 UI                                  │
│                                                                         │
│   [프롬프트 입력 (스텝5에서 복사)]                                      │
│   ┌───────────────────────────────────────────────────────────────┐    │
│   │   (스텝5에서 생성된 프롬프트 붙여넣기)                         │    │
│   └───────────────────────────────────────────────────────────────┘    │
│                                                                         │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                      │
│   │ 1. MD 생성  │ │ 2. 검증    │ │ 3. 다운로드 │                      │
│   └─────────────┘ └─────────────┘ └─────────────┘                      │
│                                                                         │
│   ┌───────────────────────────────────────────────────────────────┐    │
│   │ 📊 진행 상황                                                   │    │
│   │ ████████████░░░░░░░░  섹션 3/7: 신살+격국 생성 중...          │    │
│   └───────────────────────────────────────────────────────────────┘    │
│                                                                         │
│   ┌───────────────────────────────────────────────────────────────┐    │
│   │ ✅ 검증 결과                                                   │    │
│   │                                                               │    │
│   │ ✅ 기본 정보: 일치                                            │    │
│   │ ✅ 사주 팔자: 일치                                            │    │
│   │ ⚠️ 오행: 木 개수 불일치 (4→3으로 수정됨)                      │    │
│   │ ✅ 십성: 일치                                                 │    │
│   │ ✅ 신살: 일치 (추가된 신살 없음)                              │    │
│   │ ✅ 대운/세운: 일치                                            │    │
│   │                                                               │    │
│   │ 📝 총 1개 항목 자동 수정됨                                    │    │
│   └───────────────────────────────────────────────────────────────┘    │
│                                                                         │
│   [미리보기 영역]                                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 추가 요구사항 (2026-01-16)

### 1. 백그라운드 생성
- 화면 나가도 서버에서 계속 생성
- Netlify Background Functions 사용 (최대 15분)

### 2. 자동 순차 실행
- 버튼 1개만 누르면: 생성 → 검증 → 저장 자동 진행
- 수동 개입 불필요

### 3. 자동 저장
- 생성 완료 시 자동으로:
  - Google Sheets `mdResult` 컬럼 업데이트
  - Supabase `md_result` 필드 업데이트

### 4. UI 버튼
- 📋 복사: MD 내용 클립보드 복사
- 💾 다운로드: .md 파일 저장
- 👁️ 미리보기: 새 창에서 확인

---

## 새로운 흐름

```
[MD 생성하기] 버튼 클릭
       │
       ▼
┌──────────────────────────────────────────────────────┐
│  Netlify Background Function (서버)                  │
│                                                      │
│  1. 섹션 1~7 순차 생성                               │
│  2. 검증 (계산값 비교)                               │
│  3. 자동 수정 (불일치 시)                            │
│  4. Google Sheets 저장                              │
│  5. Supabase 저장                                   │
│                                                      │
└──────────────────────────────────────────────────────┘
       │
       ▼ (완료 시)
  관리자페이지에서 결과 확인 (새로고침 또는 폴링)
```

---

## 구현 순서 (실제 작업)

### Step 1: 검증 함수 구현
- [ ] `verify-md.js` - 프롬프트 vs MD 비교 및 자동수정

### Step 2: Background Function 구현
- [ ] `generate-md-background.js` - 백그라운드 생성 함수
- [ ] 생성 → 검증 → 저장 한번에 처리

### Step 3: 저장 로직 추가
- [ ] Google Sheets API 연동 (`mdResult` 컬럼)
- [ ] Supabase 업데이트 (`md_result` 필드)

### Step 4: 스텝6 UI 수정
- [ ] 버튼 1개 (MD 생성하기)
- [ ] 진행 상황 폴링 표시
- [ ] 복사/다운로드/미리보기 버튼

### Step 5: 테스트
- [ ] 프리미엄 패키지 전체 플로우 테스트
- [ ] 백그라운드 생성 테스트 (화면 닫고 확인)

---

## 핵심 요약

```
🎯 목표: 프롬프트의 계산값을 정확하게 MD에 반영

에이전트1 (생성)
───────────────────────
- 7개 섹션 순차 생성
- 각 섹션 10초 이내 (Netlify 제한)
- 가이드 요약본 참조해서 해석 작성
- 계산값은 프롬프트 것 그대로 사용

에이전트2 (검증/수정)
───────────────────────
- 프롬프트 vs MD 계산값 비교
- 불일치 시 자동 수정
- 수정 내역 리포트

⚠️ 가장 중요한 규칙:
"계산값(사주, 십성, 오행, 신살, 대운)은 절대 변경하지 말고
 프롬프트에 있는 값을 그대로 사용!"
```

---

## 파일 구조

```
사주/배포/
├── 에이전트/
│   ├── 에이전트_시스템_계획.md  ← 이 파일
│   └── MD생성_개선_계획.md     ← 기존 계획
├── netlify-functions/
│   ├── generate-md.js              (기존, 수정 필요)
│   ├── prompts/
│   │   ├── section-prompts.js      (기존)
│   │   └── guide-summaries.js      (기존)
│   └── utils/
│       ├── section-generator.js    (기존)
│       ├── extract-from-prompt.js  (NEW)
│       ├── extract-from-md.js      (NEW)
│       └── verify-and-fix.js       (NEW)
└── input-form/
    └── index.html

사주/테스트/
└── 결과물/                     ← 테스트 결과물 저장
    └── (MD 파일들)
```
