<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>사주 서비스 관리자</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 추가 스타일 (분리되지 않은 부분) */
        /* ========== CONFIG 기반 CSS 변수 ========== */
        :root {
            --point-gold: #d4af82;
            --point-gold-dark: #b8956a;
            --point-gold-light: #e8d4b8;
            --bg-light: #fffef9;
            --bg-base: #f8f6f1;
            --text-dark: #2d2418;
            --text-mid: #4a3d30;
            --text-light: #8b7a60;
            --cover-dark: #1a1612;
            --cover-mid: #2d2418;
            --cover-light: #3d3225;
            --border: #e5dccb;
            --wood: #2d5016;
            --fire: #c41e1e;
            --earth: #8b6914;
            --metal: #71717a;
            --water: #1e3a5f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nanum Myeongjo', serif;
            background: var(--bg-base);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* ========== 헤더 ========== */
        .header {
            background: linear-gradient(135deg, var(--cover-dark) 0%, var(--cover-mid) 100%);
            color: #e8dcc8;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-symbol {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(168, 144, 104, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: var(--point-gold);
        }

        .header h1 {
            font-size: 18px;
            font-weight: 700;
            color: #f5efe3;
        }

        .header-right {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            padding: 10px 20px;
            background: transparent;
            color: var(--point-gold);
            border: 1px solid var(--point-gold);
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-btn .btn-icon {
            font-size: 14px;
        }

        .header-btn .btn-text {
            font-size: 13px;
        }

        .header-btn:hover {
            background: var(--point-gold);
            color: var(--cover-dark);
        }

        .header-btn.primary {
            background: var(--point-gold);
            color: var(--cover-dark);
        }

        .header-btn.logout {
            background: #fee;
            color: #c00;
            border-color: #fcc;
        }

        .header-btn.logout:hover {
            background: #c00;
            color: #fff;
        }

        .logged-in-user {
            font-size: 13px;
            color: var(--point-gold);
            margin-left: 10px;
        }

        /* ========== 메인 레이아웃 ========== */
        .main {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* ========== 사이드바 (고객 목록) ========== */
        .sidebar {
            width: 350px;
            background: var(--bg-light);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 16px;
            font-weight: 700;
        }

        .customer-count {
            font-size: 12px;
            color: var(--text-light);
            background: rgba(212, 175, 130, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .sidebar-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .matching-filter-btn {
            font-size: 13px;
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid #e8b4b8;
            background: #fff5f5;
            color: #c62828;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .matching-filter-btn:hover {
            background: #fce4ec;
        }

        .matching-filter-btn.active {
            background: #c62828;
            color: #fff;
            border-color: #c62828;
        }

        /* 검색창 */
        .search-box {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-light);
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 10px 35px 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            background: #fff;
            color: var(--text-dark);
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--point-gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 130, 0.2);
        }

        .search-input::placeholder {
            color: var(--text-light);
        }

        .search-clear-btn {
            position: absolute;
            right: 8px;
            background: none;
            border: none;
            font-size: 16px;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            display: none;
        }

        .search-clear-btn.show {
            display: block;
        }

        .search-clear-btn:hover {
            color: var(--text-dark);
        }

        /* 패키지 필터 */
        .package-filter {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .package-filter-btn {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: #fff;
            font-family: inherit;
            font-size: 11px;
            color: var(--text-mid);
            cursor: pointer;
            transition: all 0.2s;
        }

        .package-filter-btn:hover {
            background: var(--bg-base);
        }

        .package-filter-btn.active {
            border-color: var(--point-gold);
            background: rgba(212, 175, 130, 0.15);
            color: var(--point-gold-dark);
            font-weight: 600;
        }

        .package-filter-btn.light.active { border-color: #7c9a5e; background: rgba(124, 154, 94, 0.15); color: #5a7a3e; }
        .package-filter-btn.standard.active { border-color: var(--point-gold); background: rgba(212, 175, 130, 0.15); color: var(--point-gold-dark); }
        .package-filter-btn.premium.active { border-color: #9b6b4a; background: rgba(155, 107, 74, 0.15); color: #7b4b2a; }

        /* 필터 탭 */
        .filter-tabs {
            display: flex;
            padding: 10px;
            gap: 5px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-base);
            flex-wrap: wrap;
        }

        .filter-tab {
            flex: 1;
            min-width: 50px;
            padding: 8px 4px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 12px;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .filter-tab:hover {
            background: rgba(212, 175, 130, 0.1);
        }

        .filter-tab.active {
            background: var(--point-gold);
            color: var(--cover-dark);
            font-weight: 600;
        }

        .filter-tab .count {
            font-size: 14px;
            font-weight: 700;
        }

        .customer-list {
            flex: 1;
            overflow-y: auto;
        }

        .customer-item {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .customer-item:hover {
            background: rgba(212, 175, 130, 0.1);
        }

        .customer-item.selected {
            background: rgba(212, 175, 130, 0.2);
            border-left: 3px solid var(--point-gold);
        }

        .customer-item .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .customer-item .name {
            font-size: 15px;
            font-weight: 700;
        }

        .customer-item .package {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 10px;
            background: var(--point-gold);
            color: #fff;
        }

        .customer-item .package.light { background: #7c9a5e; }
        .customer-item .package.standard { background: var(--point-gold); }
        .customer-item .package.premium { background: #9b6b4a; }

        .customer-item .info {
            font-size: 12px;
            color: var(--text-light);
        }

        .customer-item .status {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 8px;
            margin-top: 8px;
        }

        .customer-item .status.new { background: #e8f5e9; color: #2e7d32; }
        .customer-item .status.paid { background: #e3f2fd; color: #1565c0; }
        .customer-item .status.done { background: #f3e5f5; color: #7b1fa2; }

        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: var(--text-light);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* ========== 컨텐츠 영역 ========== */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .content-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-light);
        }

        .content-empty .icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* ========== 고객 상세 정보 ========== */
        .customer-detail {
            display: none;
        }

        .customer-detail.show {
            display: block;
        }

        .detail-header {
            background: linear-gradient(135deg, var(--cover-mid) 0%, var(--cover-light) 100%);
            color: #e8dcc8;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .detail-header .top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .detail-header .name {
            font-size: 28px;
            font-weight: 800;
            color: #f5efe3;
            margin-bottom: 8px;
        }

        .detail-header .birth {
            font-size: 14px;
            color: #c4b49a;
        }

        .detail-header .package-badge {
            background: var(--point-gold);
            color: var(--cover-dark);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
        }

        .detail-header .saju-display {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .saju-pillar {
            text-align: center;
            flex: 1;
        }

        .saju-pillar .label {
            font-size: 11px;
            color: #a89068;
            margin-bottom: 8px;
        }

        .saju-pillar .chars {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .saju-pillar .char {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 22px;
            font-weight: 700;
            margin: 0 auto;
        }

        .saju-pillar .char.cheongan {
            background: rgba(255,255,255,0.15);
            color: #f5efe3;
        }

        .saju-pillar .char.jiji {
            background: rgba(212, 175, 130, 0.3);
            color: var(--point-gold-light);
        }

        /* ========== 카드 섹션 ========== */
        .card {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, #f9f6ef 0%, #f0ebe0 100%);
            padding: 15px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-header .icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--point-gold) 0%, var(--point-gold-dark) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 14px;
        }

        .card-header h3 {
            font-size: 15px;
            font-weight: 700;
        }

        .card-body {
            padding: 18px;
        }

        /* ========== 오행 분포 ========== */
        .oheng-bars {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .oheng-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .oheng-bar .label {
            width: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .oheng-bar .label .char {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 12px;
            font-weight: 700;
        }

        .oheng-bar .label .char.wood { background: var(--wood); }
        .oheng-bar .label .char.fire { background: var(--fire); }
        .oheng-bar .label .char.earth { background: var(--earth); }
        .oheng-bar .label .char.metal { background: var(--metal); }
        .oheng-bar .label .char.water { background: var(--water); }

        .oheng-bar .track {
            flex: 1;
            height: 24px;
            background: #f0ebe0;
            border-radius: 12px;
            overflow: hidden;
        }

        .oheng-bar .fill {
            height: 100%;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            transition: width 0.5s;
        }

        .oheng-bar .fill.wood { background: var(--wood); }
        .oheng-bar .fill.fire { background: var(--fire); }
        .oheng-bar .fill.earth { background: var(--earth); }
        .oheng-bar .fill.metal { background: var(--metal); }
        .oheng-bar .fill.water { background: var(--water); }

        .oheng-bar .count {
            width: 30px;
            text-align: right;
            font-weight: 700;
            font-size: 14px;
        }

        /* ========== 질문지 답변 ========== */
        .question-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .question-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .question-item .q {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        .question-item .a {
            font-size: 14px;
            color: var(--text-dark);
            line-height: 1.8;
        }

        /* ========== 포함 항목 ========== */
        .includes-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .includes-item {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 15px;
            background: rgba(212, 175, 130, 0.15);
            color: var(--text-mid);
        }

        .includes-item.selected {
            background: var(--point-gold);
            color: #fff;
        }

        /* ========== 액션 버튼 ========== */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .action-btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid var(--border);
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .action-btn:hover {
            border-color: var(--point-gold);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--cover-mid) 0%, var(--cover-dark) 100%);
            color: var(--point-gold);
            border-color: var(--point-gold);
        }

        .action-btn.primary:hover {
            background: var(--point-gold);
            color: var(--cover-dark);
        }

        /* ========== 주문코드 ========== */
        .order-code-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(168, 144, 104, 0.3);
        }

        .order-code-label {
            font-size: 12px;
            color: #a89068;
        }

        .order-code-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--point-gold);
            letter-spacing: 2px;
            background: rgba(0,0,0,0.2);
            padding: 8px 15px;
            border-radius: 8px;
        }

        .order-code-copy {
            padding: 8px 14px;
            background: transparent;
            border: 1px solid #a89068;
            color: #a89068;
            border-radius: 6px;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .order-code-copy:hover {
            background: var(--point-gold);
            color: var(--cover-dark);
            border-color: var(--point-gold);
        }

        /* ========== 현재 상태 정보 ========== */
        .status-info-row {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .status-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-light);
            border-radius: 20px;
            font-size: 13px;
        }

        .status-info-label {
            color: var(--text-light);
        }

        .status-info-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        .status-info-value.submitted {
            color: #2d7d32;
        }

        .status-info-value.not-submitted {
            color: var(--text-light);
        }

        /* ========== 상태 변경 ========== */
        .status-manage-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .status-manage-row:last-child {
            border-bottom: none;
        }

        .status-manage-label {
            font-size: 14px;
            color: var(--text-mid);
        }

        .status-manage-value {
            font-size: 14px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 15px;
            background: var(--bg-base);
        }

        .status-manage-value.submitted {
            background: #e8f5e9;
            color: #2d7d32;
        }

        .status-manage-value.not-submitted {
            background: #fff3e0;
            color: #e65100;
        }

        .status-select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            background: #fff;
            cursor: pointer;
        }

        /* ========== 로딩 ========== */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loading.show {
            display: flex;
        }

        .loading-content {
            background: var(--bg-light);
            padding: 40px;
            border-radius: 16px;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--point-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== 모바일 최적화 ========== */
        @media (max-width: 768px) {
            /* 헤더 */
            .header {
                padding: 15px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .header-left {
                flex-wrap: wrap;
                gap: 8px;
            }

            .header-left h1 {
                font-size: 16px;
            }

            .logged-in-user {
                font-size: 12px;
                margin-left: 0;
            }

            .header-right {
                width: 100%;
                justify-content: center;
                gap: 8px;
            }

            .header-btn {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 10px 12px;
                font-size: 12px;
                gap: 4px;
                min-width: 60px;
            }

            .header-btn .btn-icon {
                font-size: 18px;
                display: block;
            }

            .header-btn .btn-text {
                font-size: 11px;
                display: block;
            }

            /* 메인 레이아웃 */
            .main {
                flex-direction: column;
            }

            /* 사이드바 (목록) */
            .sidebar {
                width: 100%;
                height: auto;
                max-height: none;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .sidebar.mobile-hidden {
                display: none;
            }

            /* 필터 탭 */
            .filter-tabs {
                display: flex;
                flex-wrap: nowrap;
                padding: 8px;
                gap: 4px;
                overflow-x: auto;
            }

            .filter-tab {
                flex: 1;
                min-width: 45px;
                flex-direction: column;
                padding: 8px 2px;
                font-size: 10px;
                gap: 3px;
            }

            .filter-tab .count {
                font-size: 13px;
                font-weight: 700;
            }

            /* 고객 목록 */
            .customer-list {
                max-height: calc(100vh - 250px);
            }

            .customer-item {
                padding: 15px;
            }

            .customer-item .package {
                font-size: 12px;
            }

            .customer-item .info {
                font-size: 13px;
            }

            .customer-item .status {
                font-size: 12px;
            }

            /* 컨텐츠 (상세) */
            .content {
                display: none;
                width: 100%;
            }

            .content.mobile-show {
                display: block;
            }

            .content-empty {
                display: none !important;
            }

            /* 뒤로가기 버튼 */
            .mobile-back-btn {
                display: flex !important;
                align-items: center;
                justify-content: center;
                padding: 8px 12px;
                background: var(--bg-base);
                border: 1px solid var(--border);
                border-radius: 8px;
                font-family: inherit;
                font-size: 14px;
                color: var(--text-mid);
                cursor: pointer;
                min-width: 40px;
            }

            .mobile-back-btn:active {
                background: var(--border);
            }

            /* 상세 정보 */
            .customer-detail {
                padding: 5px;
            }

            .detail-header {
                padding: 12px;
                margin-bottom: 10px;
                border-radius: 12px;
            }

            .detail-header .name {
                font-size: 20px;
            }

            .status-info-row {
                flex-wrap: wrap;
                gap: 8px;
            }

            .status-info-item {
                padding: 6px 10px;
                font-size: 13px;
            }

            /* 카드 */
            .card {
                margin-bottom: 10px;
                border-radius: 10px;
            }

            .card-header {
                padding: 10px 12px;
            }

            .card-header h3 {
                font-size: 14px;
            }

            .card-body {
                padding: 10px 12px;
                line-height: 1.6;
            }

            /* 상태 관리 */
            .status-manage-row {
                padding: 12px 0;
            }

            /* 사주 표시 */
            .saju-display {
                gap: 8px;
            }

            .saju-pillar {
                padding: 8px;
                min-width: 55px;
            }

            .saju-pillar .label {
                font-size: 11px;
            }

            .saju-pillar .char {
                font-size: 18px;
            }
            
            /* 액션 버튼 - 모바일 */
            .action-buttons {
                display: flex !important;
                margin-top: 20px;
                padding: 10px;
            }
        }

        /* PC에서 뒤로가기 버튼 숨김 */
        .mobile-back-btn {
            display: none;
        }

        /* ========== 고객 정보 수정 버튼 ========== */
        .edit-customer-btn {
            width: 100%;
            margin-top: 15px;
            padding: 12px;
            background: linear-gradient(135deg, var(--point-gold) 0%, var(--point-gold-dark) 100%);
            color: var(--cover-dark);
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .edit-customer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 130, 0.4);
        }

        /* ========== 고객 정보 수정 모달 ========== */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .edit-modal.show {
            display: flex;
        }

        .edit-modal-content {
            background: var(--bg-light);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--cover-dark) 0%, var(--cover-mid) 100%);
            color: #e8dcc8;
        }

        .edit-modal-header h2 {
            font-size: 18px;
            margin: 0;
        }

        .edit-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #e8dcc8;
            cursor: pointer;
            line-height: 1;
        }

        .edit-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .edit-section {
            margin-bottom: 25px;
        }

        .edit-section h3 {
            font-size: 14px;
            color: var(--point-gold-dark);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .edit-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .edit-row label {
            width: 80px;
            font-size: 13px;
            color: var(--text-mid);
            flex-shrink: 0;
        }

        .edit-row input,
        .edit-row select,
        .edit-row textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            background: #fff;
        }

        .edit-row textarea {
            resize: vertical;
        }

        .edit-row input:focus,
        .edit-row select:focus,
        .edit-row textarea:focus {
            outline: none;
            border-color: var(--point-gold);
        }

        .edit-modal-footer {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-base);
        }

        .edit-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .edit-btn.cancel {
            background: var(--bg-light);
            color: var(--text-mid);
            border: 1px solid var(--border);
        }

        .edit-btn.save {
            background: linear-gradient(135deg, var(--point-gold) 0%, var(--point-gold-dark) 100%);
            color: var(--cover-dark);
        }

        .edit-btn.save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 130, 0.4);
        }

        /* ========== 로그인 화면 ========== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--cover-dark) 0%, var(--cover-mid) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-box {
            background: var(--bg-light);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 360px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        .login-logo {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .login-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--cover-dark);
            margin-bottom: 30px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            margin-bottom: 12px;
            box-sizing: border-box;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--point-gold);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--point-gold) 0%, var(--point-gold-dark) 100%);
            color: var(--cover-dark);
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 130, 0.4);
        }

        .login-error {
            color: #c00;
            font-size: 13px;
            margin-top: 15px;
            display: none;
        }

        .signup-link {
            margin-top: 20px;
            font-size: 13px;
            color: #888;
            cursor: pointer;
        }
        .signup-link span {
            color: #8b6914;
            font-weight: 600;
            text-decoration: underline;
        }
        .signup-link:hover span {
            color: #a67c00;
        }

        .login-screen.hidden {
            display: none;
        }

        /* ========== 회원가입 모달 ========== */
        .signup-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .signup-modal.show {
            display: flex;
        }
        .signup-modal-content {
            background: #fffef8;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        .signup-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #e5dccb;
            background: linear-gradient(135deg, #f9f6ef 0%, #f0ebe0 100%);
        }
        .signup-modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: #2d2418;
        }
        .signup-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .signup-modal-body {
            padding: 25px;
        }
        .signup-form-row {
            margin-bottom: 18px;
        }
        .signup-form-row label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #2d2418;
            margin-bottom: 6px;
        }
        .signup-form-row input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d4c8b0;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .signup-form-row input:focus {
            outline: none;
            border-color: #8b6914;
        }
        .signup-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #8b6914 0%, #a67c00 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .signup-btn:hover {
            background: linear-gradient(135deg, #a67c00 0%, #c49400 100%);
        }
        .signup-error {
            color: #c00;
            font-size: 13px;
            margin-bottom: 10px;
            display: none;
        }
        .signup-success {
            color: #0a0;
            font-size: 13px;
            margin-bottom: 10px;
            display: none;
        }
        .signup-notice {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-top: 15px;
        }

        /* ========== 관리자 관리 모달 ========== */
        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1002;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .admin-modal.show {
            display: flex;
        }

        .admin-modal-content {
            background: var(--bg-light);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .admin-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--cover-dark) 0%, var(--cover-mid) 100%);
            color: #e8dcc8;
        }

        .admin-modal-header h2 {
            font-size: 18px;
            margin: 0;
        }

        .admin-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #e8dcc8;
            cursor: pointer;
        }

        .admin-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .admin-list {
            margin-bottom: 20px;
        }

        .admin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .admin-item.super {
            background: linear-gradient(135deg, #fff9e6 0%, #fff5d6 100%);
            border-color: var(--point-gold);
        }

        .admin-info {
            flex: 1;
        }

        .admin-name {
            font-weight: 600;
            color: var(--cover-dark);
            margin-bottom: 4px;
        }

        .admin-id {
            font-size: 12px;
            color: var(--text-mid);
        }

        .admin-perms {
            font-size: 11px;
            color: var(--point-gold-dark);
            margin-top: 5px;
        }

        .admin-actions {
            display: flex;
            gap: 8px;
        }

        .admin-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .admin-actions .edit-btn {
            background: var(--bg-base);
            color: var(--text-mid);
        }

        .admin-actions .delete-btn {
            background: #fee;
            color: #c00;
        }

        .add-admin-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--point-gold) 0%, var(--point-gold-dark) 100%);
            color: var(--cover-dark);
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* 관리자 추가/수정 폼 */
        .admin-form {
            display: none;
            padding: 20px;
            background: var(--bg-base);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .admin-form.show {
            display: block;
        }

        .admin-form h3 {
            font-size: 15px;
            margin-bottom: 15px;
            color: var(--cover-dark);
        }

        .admin-form-row {
            margin-bottom: 12px;
        }

        .admin-form-row label {
            display: block;
            font-size: 13px;
            color: var(--text-mid);
            margin-bottom: 5px;
        }

        .admin-form-row input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            box-sizing: border-box;
        }

        .perm-checkboxes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .perm-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-dark);
        }

        .perm-checkbox input {
            width: 16px;
            height: 16px;
        }

        .admin-form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .admin-form-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .admin-form-actions .cancel {
            background: var(--bg-light);
            color: var(--text-mid);
            border: 1px solid var(--border);
        }

        .admin-form-actions .save {
            background: linear-gradient(135deg, var(--point-gold) 0%, var(--point-gold-dark) 100%);
            color: var(--cover-dark);
        }

        /* 관리자 모달 탭 */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5dccb;
            padding-bottom: 15px;
        }
        .admin-tab {
            padding: 10px 18px;
            border: 1px solid #d4c8b0;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            position: relative;
        }
        .admin-tab.active {
            background: linear-gradient(135deg, #8b6914 0%, #a67c00 100%);
            color: white;
            border-color: #8b6914;
        }
        .admin-tab:hover:not(.active) {
            border-color: #8b6914;
            color: #8b6914;
        }
        .admin-tab .badge {
            display: inline-block;
            background: #e74c3c;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }
        .admin-tab.active .badge {
            background: white;
            color: #e74c3c;
        }

        /* 헤더 알림 뱃지 */
        .header-badge {
            display: inline-block;
            background: #e74c3c;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 8px;
            margin-left: 4px;
            vertical-align: middle;
        }

        /* 로그인 사용자 표시 */
        .logged-in-user {
            font-size: 13px;
            color: #d4c8b0;
            margin-right: 15px;
        }
        .logged-in-user strong {
            color: #f0e6d3;
        }

        /* 승인 대기 목록 */
        .pending-list {
            display: none;
        }
        .pending-list.show {
            display: block;
        }
        .pending-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #fff9e6;
            border: 1px solid #f0e6c8;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .pending-info {
            flex: 1;
        }
        .pending-name {
            font-weight: 600;
            color: #2d2418;
            margin-bottom: 4px;
        }
        .pending-id {
            font-size: 12px;
            color: #888;
        }
        .pending-date {
            font-size: 11px;
            color: #aaa;
            margin-top: 4px;
        }
        .pending-actions {
            display: flex;
            gap: 8px;
        }
        .pending-actions button {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .pending-actions .approve-btn {
            background: #27ae60;
            color: white;
        }
        .pending-actions .reject-btn {
            background: #e74c3c;
            color: white;
        }
        .pending-empty {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 14px;
        }
        .upload-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f9a825;
            border-top-color: transparent;
            border-radius: 50%;
            animation: upload-spin 0.8s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        @keyframes upload-spin {
            to { transform: rotate(360deg); }
        }

        /* 업로드 완료 토스트 */
        .upload-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: #fff;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 9999;
        }
        .upload-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* 동기화 실패 토스트 */
        .sync-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
            color: #fff;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 9999;
        }
        .sync-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
    <!-- iframe 방식으로 사주계산기, 프롬프트생성기 연동 -->
</head>
<body>
    <!-- 로그인 화면 -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">命</div>
            <div class="login-title">운명을 듣다 · 관리자</div>
            <input type="text" class="login-input" id="loginId" placeholder="아이디">
            <input type="password" class="login-input" id="loginPw" placeholder="비밀번호" onkeypress="if(event.keyCode===13) doLogin()">
            <button class="login-btn" onclick="doLogin()">로그인</button>
            <div class="login-error" id="loginError">아이디 또는 비밀번호가 틀렸습니다</div>
            <div class="signup-link" onclick="showSignupModal()">계정이 없으신가요? <span>회원가입</span></div>
        </div>
    </div>

    <!-- 헤더 -->
    <div class="header">
        <div class="header-left">
            <div class="header-symbol">命</div>
            <h1>운명을 듣다 · 관리자</h1>
            <span class="logged-in-user" id="loggedInUser" style="display:none;"><strong></strong> 님</span>
        </div>
        <div class="header-right">
            <button class="header-btn" id="headerBackBtn" onclick="backToList()" style="display:none; background:#4a7c59; color:#fff;"><span class="btn-icon">←</span><span class="btn-text">목록</span></button>
            <button class="header-btn" id="adminManageBtn" onclick="showAdminModal()" style="display:none;"><span class="btn-icon">👤</span><span class="btn-text">관리자</span></button>
            <button class="header-btn primary" onclick="showWorkflowModal()"><span class="btn-icon">🔧</span><span class="btn-text">워크플로우</span></button>
            <button class="header-btn" onclick="forceRefresh()"><span class="btn-icon">🔄</span><span class="btn-text">새로고침</span></button>
            <button class="header-btn logout" onclick="doLogout()"><span class="btn-icon">🚪</span><span class="btn-text">로그아웃</span></button>
        </div>
    </div>

    <!-- 회원가입 모달 -->
    <div class="signup-modal" id="signupModal">
        <div class="signup-modal-content">
            <div class="signup-modal-header">
                <h2>📝 회원가입</h2>
                <button class="signup-modal-close" onclick="closeSignupModal()">×</button>
            </div>
            <div class="signup-modal-body">
                <div class="signup-form">
                    <div class="signup-form-row">
                        <label>아이디 <span style="color:#c00">*</span></label>
                        <input type="text" id="signupId" placeholder="영문, 숫자 조합">
                    </div>
                    <div class="signup-form-row">
                        <label>비밀번호 <span style="color:#c00">*</span></label>
                        <input type="password" id="signupPw" placeholder="비밀번호">
                    </div>
                    <div class="signup-form-row">
                        <label>비밀번호 확인 <span style="color:#c00">*</span></label>
                        <input type="password" id="signupPwConfirm" placeholder="비밀번호 확인">
                    </div>
                    <div class="signup-form-row">
                        <label>이름 <span style="color:#c00">*</span></label>
                        <input type="text" id="signupName" placeholder="이름">
                    </div>
                    <div class="signup-form-row">
                        <label>이메일 <span style="color:#c00">*</span></label>
                        <input type="email" id="signupEmail" placeholder="example@email.com">
                    </div>
                    <div class="signup-error" id="signupError"></div>
                    <div class="signup-success" id="signupSuccess"></div>
                    <button class="signup-btn" onclick="doSignup()">가입 신청</button>
                    <div class="signup-notice">※ 가입 신청 후 관리자 승인이 필요합니다</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 관리자 관리 모달 -->
    <div class="admin-modal" id="adminModal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2>👤 관리자 관리</h2>
                <button class="admin-modal-close" onclick="closeAdminModal()">×</button>
            </div>
            <div class="admin-modal-body">
                <!-- 탭 버튼 -->
                <div class="admin-tabs">
                    <div class="admin-tab active" id="tabApproved" onclick="switchAdminTab('approved')">✓ 승인된 관리자</div>
                    <div class="admin-tab" id="tabPending" onclick="switchAdminTab('pending')">승인 대기 <span class="badge" id="pendingBadge" style="display:none;">0</span></div>
                </div>
                
                <!-- 추가/수정 폼 -->
                <div class="admin-form" id="adminForm">
                    <h3 id="adminFormTitle">새 관리자 추가</h3>
                    <input type="hidden" id="adminFormMode" value="add">
                    <div class="admin-form-row">
                        <label>이름</label>
                        <input type="text" id="adminFormName" placeholder="예: 알바1">
                    </div>
                    <div class="admin-form-row">
                        <label>아이디</label>
                        <input type="text" id="adminFormId" placeholder="영문/숫자">
                    </div>
                    <div class="admin-form-row" id="currentPwRow" style="display:none;">
                        <label>현재 비밀번호</label>
                        <input type="text" id="adminFormCurrentPw" readonly style="background:#f0f0f0; color:#666;">
                    </div>
                    <div class="admin-form-row">
                        <label id="pwLabel">비밀번호</label>
                        <input type="password" id="adminFormPw" placeholder="비밀번호">
                    </div>
                    <div class="admin-form-row">
                        <label>이메일</label>
                        <input type="email" id="adminFormEmail" placeholder="example@email.com">
                    </div>
                    <div class="perm-checkboxes">
                        <label class="perm-checkbox">
                            <input type="checkbox" id="permView" checked>
                            고객 조회
                        </label>
                        <label class="perm-checkbox">
                            <input type="checkbox" id="permStatusPaid" checked>
                            신규→입금 변경
                        </label>
                        <label class="perm-checkbox">
                            <input type="checkbox" id="permStatusOther" checked>
                            그 외 상태 변경
                        </label>
                        <label class="perm-checkbox">
                            <input type="checkbox" id="permResult" checked>
                            결과 링크
                        </label>
                        <label class="perm-checkbox">
                            <input type="checkbox" id="permDelete">
                            고객 삭제
                        </label>
                        <label class="perm-checkbox">
                            <input type="checkbox" id="permEdit">
                            정보 수정
                        </label>
                        <label class="perm-checkbox">
                            <input type="checkbox" id="permAdmin">
                            관리자 관리
                        </label>
                    </div>
                    <div class="notify-section" style="margin-top:15px; padding-top:15px; border-top:1px solid #eee;">
                        <label style="font-weight:600; color:#333; display:block; margin-bottom:10px;">📧 알림 받을 상태:</label>
                        <div class="perm-checkboxes">
                            <label class="perm-checkbox">
                                <input type="checkbox" id="notify_신규">
                                신규
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" id="notify_입금확인">
                                입금확인
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" id="notify_작성중">
                                작성중
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" id="notify_변환요청">
                                변환요청
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" id="notify_대기">
                                대기
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" id="notify_제작대기">
                                제작대기
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" id="notify_추가변환요청">
                                추가변환요청
                            </label>
                        </div>
                    </div>
                    <div class="admin-form-row">
                        <label>역할</label>
                        <select id="adminFormRole" style="padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                            <option value="">선택안함</option>
                            <option value="상담사">상담사</option>
                            <option value="제작자">제작자</option>
                            <option value="검수자">검수자</option>
                            <option value="관리자">관리자</option>
                        </select>
                    </div>
                    <div class="admin-form-actions">
                        <button class="cancel" onclick="hideAdminForm()">취소</button>
                        <button class="save" onclick="saveAdmin()">저장</button>
                    </div>
                </div>

                <!-- 관리자 목록 -->
                <div class="admin-list" id="adminList">
                    <!-- JS로 생성 -->
                </div>
                
                <!-- 승인 대기 목록 -->
                <div class="pending-list" id="pendingList">
                    <!-- JS로 생성 -->
                </div>
                
                <button class="add-admin-btn" onclick="showAddAdminForm()">+ 새 관리자 추가</button>
                
                <!-- 총관리자 전용: 알림 시간 설정 -->
                <div id="notificationTimeSettings" style="display:none; margin-top:20px; padding:20px; background:#f9f6ef; border-radius:12px; border:1px solid #e5dccb;">
                    <label style="font-weight:600; color:#333; display:block; margin-bottom:15px;">⏰ 알림 시간 설정 (총관리자 전용)</label>
                    <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
                        <div>
                            <label style="font-size:13px; color:#666;">시작</label>
                            <select id="notifyStartHour" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; margin-left:5px;">
                                <option value="0">0시</option>
                                <option value="1">1시</option>
                                <option value="2">2시</option>
                                <option value="3">3시</option>
                                <option value="4">4시</option>
                                <option value="5">5시</option>
                                <option value="6">6시</option>
                                <option value="7">7시</option>
                                <option value="8">8시</option>
                                <option value="9">9시</option>
                                <option value="10" selected>10시</option>
                                <option value="11">11시</option>
                                <option value="12">12시</option>
                                <option value="13">13시</option>
                                <option value="14">14시</option>
                                <option value="15">15시</option>
                                <option value="16">16시</option>
                                <option value="17">17시</option>
                                <option value="18">18시</option>
                                <option value="19">19시</option>
                                <option value="20">20시</option>
                                <option value="21">21시</option>
                                <option value="22">22시</option>
                                <option value="23">23시</option>
                            </select>
                        </div>
                        <span>~</span>
                        <div>
                            <label style="font-size:13px; color:#666;">종료</label>
                            <select id="notifyEndHour" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; margin-left:5px;">
                                <option value="1">1시</option>
                                <option value="2">2시</option>
                                <option value="3">3시</option>
                                <option value="4">4시</option>
                                <option value="5">5시</option>
                                <option value="6">6시</option>
                                <option value="7">7시</option>
                                <option value="8">8시</option>
                                <option value="9">9시</option>
                                <option value="10">10시</option>
                                <option value="11">11시</option>
                                <option value="12">12시</option>
                                <option value="13">13시</option>
                                <option value="14">14시</option>
                                <option value="15">15시</option>
                                <option value="16">16시</option>
                                <option value="17">17시</option>
                                <option value="18">18시</option>
                                <option value="19">19시</option>
                                <option value="20">20시</option>
                                <option value="21">21시</option>
                                <option value="22" selected>22시</option>
                                <option value="23">23시</option>
                                <option value="24">24시</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:13px; color:#666;">간격</label>
                            <select id="notifyInterval" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; margin-left:5px;">
                                <option value="1" selected>1시간</option>
                                <option value="2">2시간</option>
                                <option value="3">3시간</option>
                                <option value="4">4시간</option>
                                <option value="6">6시간</option>
                            </select>
                        </div>
                        <button onclick="saveNotificationTime()" style="padding:8px 20px; background:linear-gradient(135deg, #d4af82, #b8956a); border:none; border-radius:6px; color:white; cursor:pointer; font-weight:600;">저장</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 워크플로우 모달 -->
    <div class="workflow-modal" id="workflowModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:#fffef9; border-radius:20px; padding:30px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <h2 style="font-size:20px; color:#2d2418;">🔧 워크플로우 도구</h2>
                <button onclick="closeWorkflowModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">×</button>
            </div>
            <div style="display:flex; flex-direction:column; gap:12px;">
                <!-- 기본 결과지 워크플로우 -->
                <div style="font-size:13px; font-weight:700; color:#4a7c59; margin-bottom:5px;">📝 기본 결과지</div>
                
                <a href="1_input.html" target="_blank" class="workflow-link" style="display:flex; align-items:center; gap:15px; padding:18px; background:linear-gradient(135deg, #f9f6ef 0%, #f0ebe0 100%); border:1px solid #e5dccb; border-radius:12px; text-decoration:none; color:#2d2418; transition:all 0.3s;">
                    <span style="font-size:28px;">📝</span>
                    <div>
                        <div style="font-weight:700; margin-bottom:4px;">Step 1: 입력폼 (기본정보)</div>
                        <div style="font-size:12px; color:#8b7a60;">고객 정보 + 질문지 입력</div>
                    </div>
                </a>
                <a href="2_saju.html" target="_blank" class="workflow-link" style="display:flex; align-items:center; gap:15px; padding:18px; background:linear-gradient(135deg, #f9f6ef 0%, #f0ebe0 100%); border:1px solid #e5dccb; border-radius:12px; text-decoration:none; color:#2d2418; transition:all 0.3s;">
                    <span style="font-size:28px;">🧮</span>
                    <div>
                        <div style="font-weight:700; margin-bottom:4px;">Step 2: 사주 계산기</div>
                        <div style="font-size:12px; color:#8b7a60;">만세력 기반 사주 명식 계산</div>
                    </div>
                </a>
                
                <!-- 프리미엄 전용: 인연상 워크플로우 -->
                <div style="margin:15px 0 10px; border-top:2px dashed #9b59b6; position:relative;">
                    <span style="position:absolute; top:-12px; left:50%; transform:translateX(-50%); background:#fffef9; padding:0 15px; font-size:13px; color:#9b59b6; font-weight:600;">💜 프리미엄 전용</span>
                </div>
                <a href="3_inyeon_calc.html" target="_blank" class="workflow-link" style="display:flex; align-items:center; gap:15px; padding:18px; background:linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border:1px solid #9b59b6; border-radius:12px; text-decoration:none; color:#2d2418; transition:all 0.3s;">
                    <span style="font-size:28px;">💘</span>
                    <div>
                        <div style="font-weight:700; margin-bottom:4px;">Step 3: 인연상 계산기</div>
                        <div style="font-size:12px; color:#9b59b6;">일주 기반 인연상/배우자상 계산</div>
                    </div>
                </a>
                <a href="4_inyeon_gen.html" target="_blank" class="workflow-link" style="display:flex; align-items:center; gap:15px; padding:18px; background:linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border:1px solid #9b59b6; border-radius:12px; text-decoration:none; color:#2d2418; transition:all 0.3s;">
                    <span style="font-size:28px;">🎨</span>
                    <div>
                        <div style="font-weight:700; margin-bottom:4px;">Step 4: 인연상 생성기</div>
                        <div style="font-size:12px; color:#9b59b6;">인연상 이미지 HTML 생성</div>
                    </div>
                </a>
                <div style="margin:10px 0 15px; border-top:2px dashed #9b59b6;"></div>
                
                <a href="5_prompt.html" target="_blank" class="workflow-link" style="display:flex; align-items:center; gap:15px; padding:18px; background:linear-gradient(135deg, #f9f6ef 0%, #f0ebe0 100%); border:1px solid #e5dccb; border-radius:12px; text-decoration:none; color:#2d2418; transition:all 0.3s;">
                    <span style="font-size:28px;">✨</span>
                    <div>
                        <div style="font-weight:700; margin-bottom:4px;">Step 5: 프롬프트 생성기</div>
                        <div style="font-size:12px; color:#8b7a60;">Claude용 프롬프트 생성 → Claude 입력</div>
                    </div>
                </a>
                <div style="padding:15px; background:#fff8e7; border:1px dashed #d4af82; border-radius:12px; text-align:center;">
                    <div style="font-size:14px; color:#8b6914;">📋 Step 6: Claude 출력 → 결과글 붙여넣기</div>
                </div>
                <a href="6_result.html" target="_blank" class="workflow-link" style="display:flex; align-items:center; gap:15px; padding:18px; background:linear-gradient(135deg, #f9f6ef 0%, #f0ebe0 100%); border:1px solid #e5dccb; border-radius:12px; text-decoration:none; color:#2d2418; transition:all 0.3s;">
                    <span style="font-size:28px;">🎴</span>
                    <div>
                        <div style="font-weight:700; margin-bottom:4px;">Step 7: 결과 생성기 (결과파일)</div>
                        <div style="font-size:12px; color:#8b7a60;">결과글 → HTML 결과지 생성</div>
                    </div>
                </a>
                
                <!-- 추가질문 워크플로우 구분선 -->
                <div style="margin:20px 0; border-top:2px dashed #e65100; position:relative;">
                    <span style="position:absolute; top:-12px; left:50%; transform:translateX(-50%); background:#fffef9; padding:0 15px; font-size:13px; color:#e65100; font-weight:600;">❓ 추가질문 워크플로우</span>
                </div>
                
                <a href="7_question.html" target="_blank" class="workflow-link" style="display:flex; align-items:center; gap:15px; padding:18px; background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border:1px solid #e65100; border-radius:12px; text-decoration:none; color:#2d2418; transition:all 0.3s;">
                    <span style="font-size:28px;">📝</span>
                    <div>
                        <div style="font-weight:700; margin-bottom:4px;">Step 8: 추가질문 입력폼</div>
                        <div style="font-size:12px; color:#e65100;">고객 추가질문 접수 → 프롬프트 복사 → Claude 입력</div>
                    </div>
                </a>
                <div style="padding:15px; background:#fff3e0; border:1px dashed #e65100; border-radius:12px; text-align:center;">
                    <div style="font-size:14px; color:#e65100;">📋 Step 9: Claude 출력 → 답변글 붙여넣기</div>
                </div>
                <a href="8_question_result.html" target="_blank" class="workflow-link" style="display:flex; align-items:center; gap:15px; padding:18px; background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border:1px solid #e65100; border-radius:12px; text-decoration:none; color:#2d2418; transition:all 0.3s;">
                    <span style="font-size:28px;">💬</span>
                    <div>
                        <div style="font-weight:700; margin-bottom:4px;">Step 10: 추가질문 결과 생성기 (답변파일)</div>
                        <div style="font-size:12px; color:#e65100;">답변글 → 추가질문 답변 HTML 생성</div>
                    </div>
                </a>
            </div>
            <div style="margin-top:20px; padding-top:15px; border-top:1px solid #e5dccb; font-size:12px; color:#8b7a60; text-align:center;">
                💡 각 도구는 새 탭에서 열립니다
            </div>
        </div>
    </div>

    <!-- 결과 입력 모달 -->
    <div class="edit-modal" id="resultModal" onclick="if(event.target===this)closeResultModal()">
        <div class="edit-modal-content" style="max-width:600px;">
            <div class="edit-modal-header">
                <a href="index.html" style="font-size:24px; text-decoration:none; margin-right:10px;">🏠</a>
                <h2>📄 결과 입력 - <span id="resultModalName">고객명</span></h2>
                <button class="edit-modal-close" onclick="closeResultModal()">×</button>
            </div>
            <div class="edit-modal-body" style="padding:20px;">
                <!-- 주요결과글 -->
                <div style="margin-bottom:25px;">
                    <div style="font-size:14px; font-weight:700; color:#2d2418; margin-bottom:10px;">📄 주요결과글</div>
                    <textarea id="mainResultTextarea" readonly placeholder="붙여넣기 버튼을 클릭하세요" style="width:100%; height:150px; font-size:12px; padding:12px; border:1px solid #e5dccb; border-radius:8px; background:#f9f6ef; resize:vertical; line-height:1.6;"></textarea>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="action-btn" onclick="copyMainResult()" style="flex:1; padding:12px; background:#f0f0f0; color:#333; border:1px solid #ddd;">📋 복사</button>
                        <button class="action-btn primary" onclick="pasteMainResult()" style="flex:1; padding:12px;">📥 붙여넣기</button>
                    </div>
                    <div id="mainResultStatus" style="margin-top:8px; font-size:12px; color:#999; text-align:center;"></div>
                </div>
                
                <!-- 추가질문결과글 -->
                <div>
                    <div style="font-size:14px; font-weight:700; color:#2d2418; margin-bottom:10px;">💬 추가질문결과글</div>
                    <textarea id="additionalResultTextarea" readonly placeholder="붙여넣기 버튼을 클릭하세요" style="width:100%; height:150px; font-size:12px; padding:12px; border:1px solid #e5dccb; border-radius:8px; background:#f9f6ef; resize:vertical; line-height:1.6;"></textarea>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="action-btn" onclick="copyAdditionalResult()" style="flex:1; padding:12px; background:#f0f0f0; color:#333; border:1px solid #ddd;">📋 복사</button>
                        <button class="action-btn primary" onclick="pasteAdditionalResultText()" style="flex:1; padding:12px;">📥 붙여넣기</button>
                    </div>
                    <div id="additionalResultStatus" style="margin-top:8px; font-size:12px; color:#999; text-align:center;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 고객 정보 수정 모달 -->
    <div class="edit-modal" id="editModal" onclick="if(event.target===this)closeEditModal()">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h2>✏️ 고객 정보 수정</h2>
                <button class="edit-modal-close" onclick="closeEditModal()">×</button>
            </div>
            <div class="edit-modal-body">
                <div class="edit-section">
                    <h3>기본 정보</h3>
                    <div class="edit-row">
                        <label>이름</label>
                        <input type="text" id="editName">
                    </div>
                    <div class="edit-row">
                        <label>연락처</label>
                        <input type="text" id="editPhone">
                    </div>
                    <div class="edit-row">
                        <label>성별</label>
                        <select id="editGender">
                            <option value="male">남자</option>
                            <option value="female">여자</option>
                        </select>
                    </div>
                    <div class="edit-row">
                        <label>인연성별</label>
                        <select id="editPartnerGender">
                            <option value="">선택 안 함</option>
                            <option value="male">남자</option>
                            <option value="female">여자</option>
                            <option value="male,female">남자,여자 (둘 다)</option>
                        </select>
                    </div>
                </div>
                <div class="edit-section">
                    <h3>생년월일</h3>
                    <div class="edit-row">
                        <label>연도</label>
                        <input type="number" id="editBirthYear" min="1900" max="2025">
                    </div>
                    <div class="edit-row">
                        <label>월</label>
                        <input type="number" id="editBirthMonth" min="1" max="12">
                    </div>
                    <div class="edit-row">
                        <label>일</label>
                        <input type="number" id="editBirthDay" min="1" max="31">
                    </div>
                    <div class="edit-row">
                        <label>시</label>
                        <input type="number" id="editBirthHour" min="0" max="23" placeholder="모르면 비워두세요">
                    </div>
                    <div class="edit-row">
                        <label>분</label>
                        <input type="number" id="editBirthMinute" min="0" max="59" placeholder="모르면 비워두세요">
                    </div>
                    <div class="edit-row">
                        <label>음력/양력</label>
                        <select id="editIsLunar">
                            <option value="N">양력</option>
                            <option value="Y">음력</option>
                        </select>
                    </div>
                </div>
                <div class="edit-section">
                    <h3>현재 상태</h3>
                    <div class="edit-row">
                        <label>연애 상태</label>
                        <select id="editLoveStatus">
                            <option value="선택 안 함">선택 안 함</option>
                            <option value="솔로">솔로</option>
                            <option value="썸타는 중">썸타는 중</option>
                            <option value="연애 중">연애 중</option>
                            <option value="기혼">기혼</option>
                            <option value="이별 후">이별 후</option>
                        </select>
                    </div>
                    <div class="edit-row">
                        <label>직업 상태</label>
                        <select id="editJobStatus">
                            <option value="선택 안 함">선택 안 함</option>
                            <option value="학생">학생</option>
                            <option value="취준생">취준생</option>
                            <option value="직장인">직장인</option>
                            <option value="프리랜서">프리랜서</option>
                            <option value="사업자·자영업">사업자·자영업</option>
                            <option value="주부">주부</option>
                        </select>
                    </div>
                </div>
                <div class="edit-section">
                    <h3>패키지 & 운세</h3>
                    <div class="edit-row">
                        <label>패키지</label>
                        <select id="editPackage">
                            <option value="light">라이트</option>
                            <option value="standard">스탠다드</option>
                            <option value="premium">프리미엄</option>
                        </select>
                    </div>
                    <div class="edit-row">
                        <label>선택 운세</label>
                        <input type="text" id="editFortuneType" placeholder="예: love,career">
                    </div>
                </div>
                <div class="edit-section">
                    <h3>질문지 답변</h3>
                    <div class="edit-row">
                        <label>가장 큰 고민</label>
                        <textarea id="editMainConcern" rows="2"></textarea>
                    </div>
                    <div class="edit-row">
                        <label>반복되는 패턴</label>
                        <textarea id="editRepeatPattern" rows="2"></textarea>
                    </div>
                    <div class="edit-row">
                        <label>맞춤 질문</label>
                        <textarea id="editCustomQuestion" rows="2"></textarea>
                    </div>
                </div>
                <div class="edit-section">
                    <h3>💕 매칭 정보</h3>
                    <div class="edit-row">
                        <label>매칭 관심</label>
                        <select id="editMatchingInterest">
                            <option value="">선택 안 함</option>
                            <option value="Y">Y (관심 있음)</option>
                            <option value="N">N (관심 없음)</option>
                        </select>
                    </div>
                    <div class="edit-row">
                        <label>연상 범위</label>
                        <input type="text" id="editMatchingAgeUpper" placeholder="예: 5, 상관없음">
                    </div>
                    <div class="edit-row">
                        <label>연하 범위</label>
                        <input type="text" id="editMatchingAgeLower" placeholder="예: 3, 상관없음">
                    </div>
                </div>
                <div class="edit-section">
                    <h3>❓ 추가질문</h3>
                    <div class="edit-row">
                        <label>질문 내용</label>
                        <textarea id="editQuestionContent" rows="4" placeholder="추가질문 시트의 내용을 수정합니다"></textarea>
                    </div>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="edit-btn cancel" onclick="closeEditModal()">취소</button>
                <button class="edit-btn save" onclick="saveCustomerEdit()">💾 저장하기</button>
            </div>
        </div>
    </div>

    <!-- 메인 -->
    <div class="main">
        <!-- 사이드바 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>신청 목록</h2>
                <div class="sidebar-header-right">
                    <button class="matching-filter-btn" id="matchingFilterBtn" onclick="filterByStatus('matching')">
                        💕 <span id="countMatching">0</span>
                    </button>
                    <button class="matching-filter-btn" id="allFilterBtn" onclick="filterByStatus('all')" style="background:#f5f5f5; color:#333;">
                        전체 <span id="countAll">0</span>
                    </button>
                    <button class="matching-filter-btn" id="finalCompleteBtn" onclick="filterByStatus('전달최종완료')" style="background:#e8f5e9; color:#2e7d32;">
                        최종완료 <span id="count전달최종완료">0</span>
                    </button>
                    <span class="customer-count" id="customerCount">0건</span>
                </div>
            </div>
            <!-- 검색창 -->
            <div class="search-box">
                <div class="search-input-wrapper">
                    <input type="text" class="search-input" id="searchInput" placeholder="이름, 메모, 주문코드 검색..." oninput="handleSearch(this.value)">
                    <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearch()">×</button>
                </div>
                <div class="package-filter">
                    <button class="package-filter-btn active" data-package="all" onclick="filterByPackage('all')">전체</button>
                    <button class="package-filter-btn light" data-package="light" onclick="filterByPackage('light')">🌱 라이트</button>
                    <button class="package-filter-btn standard" data-package="standard" onclick="filterByPackage('standard')">🌿 스탠다드</button>
                    <button class="package-filter-btn premium" data-package="premium" onclick="filterByPackage('premium')">🌳 프리미엄</button>
                </div>
            </div>
            <!-- 필터 탭 -->
            <div class="filter-tabs" id="filterTabs">
                <button class="filter-tab active" data-status="신규" onclick="filterByStatus('신규')">
                    신규 <span class="count" id="count신규">0</span>
                </button>
                <button class="filter-tab" data-status="입금확인" onclick="filterByStatus('입금확인')">
                    입금완료 <span class="count" id="count입금확인">0</span>
                </button>
                <button class="filter-tab" data-status="작성중" onclick="filterByStatus('작성중')">
                    준비완료(자료) <span class="count" id="count작성중">0</span>
                </button>
                <button class="filter-tab" data-status="변환요청" onclick="filterByStatus('변환요청')">
                    변환요청 <span class="count" id="count변환요청">0</span>
                </button>
                <button class="filter-tab" data-status="전달완료" onclick="filterByStatus('전달완료')">
                    전달완료 <span class="count" id="count전달완료">0</span>
                </button>
                <button class="filter-tab" data-status="대기" onclick="filterByStatus('대기')">
                    대기(추가질문) <span class="count" id="count대기">0</span>
                </button>
                <button class="filter-tab" data-status="추가변환요청" onclick="filterByStatus('추가변환요청')">
                    추가변환요청 <span class="count" id="count추가변환요청">0</span>
                </button>
            </div>
            <div class="customer-list" id="customerList">
                <div class="empty-state">
                    <div class="icon">📋</div>
                    <p>새로고침을 눌러<br>신청 목록을 불러오세요</p>
                </div>
            </div>
        </div>

        <!-- 컨텐츠 -->
        <div class="content">
            <div class="content-empty" id="contentEmpty">
                <div class="icon">👈</div>
                <p>왼쪽에서 고객을 선택하세요</p>
            </div>

            <div class="customer-detail" id="customerDetail">
                <!-- 헤더 -->
                <div class="detail-header">
                    <div class="top">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button class="mobile-back-btn" onclick="backToList()" style="padding:5px 10px; font-size:12px; margin:0;">←</button>
                            <div>
                                <div class="name" id="detailName">홍길동</div>
                                <div class="birth" id="detailBirth">2000년 3월 3일 오후 3시 40분 (양력, 남)</div>
                            </div>
                        </div>
                        <div class="package-badge" id="detailPackage">👑 프리미엄</div>
                    </div>
                    <!-- 사주팔자 토글 -->
                    <div style="display:flex; align-items:center; gap:8px; margin:10px 0 5px 0;">
                        <button id="sajuToggleBtn" onclick="toggleSajuDisplay()" style="background:none; border:1px solid #ddd; border-radius:6px; padding:4px 10px; font-size:12px; color:#666; cursor:pointer;">
                            📊 사주팔자 <span id="sajuToggleIcon">▼</span>
                        </button>
                    </div>
                    <div class="saju-display" id="sajuDisplay" style="display:flex;">
                        <!-- JS로 생성 -->
                    </div>
                    <!-- ★ 주문코드 영역 추가 -->
                    <div class="order-code-row" id="orderCodeRow" style="display:none;">
                        <span class="order-code-label">주문코드</span>
                        <span class="order-code-value" id="detailOrderCode">-</span>
                        <button class="order-code-copy" onclick="copyOrderCode()">📋 복사</button>
                    </div>
                    <!-- ★ 현재 상태 영역 -->
                    <div class="status-info-row" id="statusInfoRow">
                        <div class="status-info-item">
                            <span class="status-info-label">💕 연애</span>
                            <span class="status-info-value" id="detailLoveStatus">-</span>
                        </div>
                        <div class="status-info-item">
                            <span class="status-info-label">💼 직업</span>
                            <span class="status-info-value" id="detailJobStatus">-</span>
                        </div>
                        <div class="status-info-item">
                            <span class="status-info-label">❓ 추가질문</span>
                            <span class="status-info-value" id="detailQuestionStatus">-</span>
                        </div>
                        <div class="status-info-item">
                            <span class="status-info-label">💕 매칭</span>
                            <span class="status-info-value" id="detailMatchingStatus">-</span>
                        </div>
                    </div>
                    <!-- ★ 관리자 메모 (컴팩트) -->
                    <div style="margin-top:15px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.15);">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:12px; color:#a89068; white-space:nowrap;">📝 메모</span>
                            <input type="text" id="customerMemo" placeholder="고객 메모 입력..." 
                                style="flex:1; padding:8px 12px; font-size:12px; border:1px solid rgba(255,255,255,0.2); border-radius:6px; background:rgba(255,255,255,0.1); color:#f5efe3; font-family:inherit;"
                                onblur="saveMemo()">
                            <button onclick="saveMemo()" style="padding:8px 12px; font-size:11px; background:rgba(212,175,130,0.3); color:#d4af82; border:1px solid rgba(212,175,130,0.4); border-radius:6px; cursor:pointer; white-space:nowrap;">💾</button>
                            <span id="memoSaveStatus" style="font-size:10px; color:#a89068; white-space:nowrap;">-</span>
                        </div>
                    </div>
                </div>

                <!-- 상태 관리 (맨 위) -->
                <div class="card">
                    <div class="card-header">
                        <span class="icon">⚙️</span>
                        <h3>상태 관리</h3>
                    </div>
                    <div class="card-body">
                        <div class="status-manage-row">
                            <span class="status-manage-label">진행 상태</span>
                            <select class="status-select" id="statusSelect" onchange="updateStatus()">
                                <option value="신규">신규</option>
                                <option value="입금확인">입금확인</option>
                                <option value="작성중">작성중</option>
                                <option value="변환요청">변환요청</option>
                                <option value="완료">완료</option>
                            </select>
                        </div>
                        <div class="status-manage-row">
                            <span class="status-manage-label">추가질문</span>
                            <select class="status-select" id="answerStatusSelect" onchange="updateAnswerStatus()">
                                <option value="제출완료">제출완료</option>
                                <option value="추가변환요청">추가변환요청</option>
                                <option value="제작중">제작중</option>
                                <option value="전달완료">전달완료</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="edit-customer-btn" onclick="openEditModal()">✏️ 고객 정보 수정</button>
                            <button class="edit-customer-btn" onclick="openResultModal()" style="background:linear-gradient(135deg,#4a7c59,#3d6b4a);">📄 결과</button>
                        </div>
                    </div>
                </div>

                <!-- 📊 작업 진행 현황 -->
                <div class="card" id="progressCard" style="display:none;">
                    <div class="card-header">
                        <span class="icon">📊</span>
                        <h3>작업 진행 현황</h3>
                    </div>
                    <div class="card-body" style="padding:15px;">
                        <div id="progressSteps" style="display:flex; justify-content:space-between; gap:5px; margin-bottom:12px;">
                            <div class="progress-step" data-step="1" onclick="scrollToStep(1)" style="flex:1; text-align:center; cursor:pointer;">
                                <div class="step-icon" style="width:32px; height:32px; border-radius:50%; margin:0 auto 4px; display:flex; align-items:center; justify-content:center; font-size:14px; background:#e0e0e0; color:#999;">1</div>
                                <div style="font-size:10px; color:#999;">정보</div>
                            </div>
                            <div class="progress-step" data-step="2" onclick="scrollToStep(2)" style="flex:1; text-align:center; cursor:pointer;">
                                <div class="step-icon" style="width:32px; height:32px; border-radius:50%; margin:0 auto 4px; display:flex; align-items:center; justify-content:center; font-size:14px; background:#e0e0e0; color:#999;">2</div>
                                <div style="font-size:10px; color:#999;">계산</div>
                            </div>
                            <div class="progress-step" data-step="3" onclick="scrollToStep(3)" style="flex:1; text-align:center; cursor:pointer;">
                                <div class="step-icon" style="width:32px; height:32px; border-radius:50%; margin:0 auto 4px; display:flex; align-items:center; justify-content:center; font-size:14px; background:#e0e0e0; color:#999;">3</div>
                                <div style="font-size:10px; color:#999;">프롬프트</div>
                            </div>
                            <div class="progress-step" data-step="4" onclick="scrollToStep(4)" style="flex:1; text-align:center; cursor:pointer;">
                                <div class="step-icon" style="width:32px; height:32px; border-radius:50%; margin:0 auto 4px; display:flex; align-items:center; justify-content:center; font-size:14px; background:#e0e0e0; color:#999;">4</div>
                                <div style="font-size:10px; color:#999;">결과글</div>
                            </div>
                            <div class="progress-step" data-step="5" onclick="scrollToStep(5)" style="flex:1; text-align:center; cursor:pointer;">
                                <div class="step-icon" style="width:32px; height:32px; border-radius:50%; margin:0 auto 4px; display:flex; align-items:center; justify-content:center; font-size:14px; background:#e0e0e0; color:#999;">5</div>
                                <div style="font-size:10px; color:#999;">파일</div>
                            </div>
                            <div class="progress-step" data-step="6" onclick="scrollToStep(6)" style="flex:1; text-align:center; cursor:pointer;">
                                <div class="step-icon" style="width:32px; height:32px; border-radius:50%; margin:0 auto 4px; display:flex; align-items:center; justify-content:center; font-size:14px; background:#e0e0e0; color:#999;">6</div>
                                <div style="font-size:10px; color:#999;">질문</div>
                            </div>
                            <div class="progress-step" data-step="7" onclick="scrollToStep(7)" style="flex:1; text-align:center; cursor:pointer;">
                                <div class="step-icon" style="width:32px; height:32px; border-radius:50%; margin:0 auto 4px; display:flex; align-items:center; justify-content:center; font-size:14px; background:#e0e0e0; color:#999;">7</div>
                                <div style="font-size:10px; color:#999;">답변</div>
                            </div>
                            <div class="progress-step" data-step="8" onclick="scrollToStep(8)" style="flex:1; text-align:center; cursor:pointer;">
                                <div class="step-icon" style="width:32px; height:32px; border-radius:50%; margin:0 auto 4px; display:flex; align-items:center; justify-content:center; font-size:14px; background:#e0e0e0; color:#999;">8</div>
                                <div style="font-size:10px; color:#999;">파일</div>
                            </div>
                        </div>
                        <div id="progressStatus" style="text-align:center; font-size:12px; color:#666; padding:8px; background:#f9f6ef; border-radius:8px;">
                            현재: Step 1 - 기본정보 확인
                        </div>
                    </div>
                </div>

                <!-- ═══════ 📝 기본 결과지 작업 ═══════ -->
                <div class="section-divider" style="display:none; margin:25px 0 15px; text-align:center;" id="mainSectionDivider">
                    <span style="background:#f9f6ef; padding:0 15px; color:#8b6914; font-size:13px; font-weight:600;">📝 기본 결과지 작업</span>
                    <div style="border-bottom:2px solid #e5dccb; margin-top:-8px;"></div>
                </div>

                <!-- Step 1: 기본정보 (계산기용 데이터) -->
                <div class="card" id="copyDataCard" style="display:none;">
                    <div class="card-header">
                        <span class="step-badge" style="background:#4a7c59; color:#fff; padding:2px 8px; border-radius:10px; font-size:11px; margin-right:8px;">Step 1</span>
                        <span class="icon">📋</span>
                        <h3>기본정보</h3>
                    </div>
                    <div class="card-body">
                        <!-- 🚀 변환시작 버튼 -->
                        <button class="action-btn" id="pipelineBtn" onclick="runPipeline()" style="width:100%; margin-bottom:15px; padding:14px; background:linear-gradient(135deg, #8b6914 0%, #c49b30 100%); color:#fff; border:none; border-radius:10px; font-weight:700; font-size:14px; cursor:pointer; box-shadow:0 3px 10px rgba(139,105,20,0.3);">
                            🚀 변환시작 (사주계산 + 프롬프트 자동생성)
                        </button>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <button class="action-btn primary" onclick="copyCalculatorData()" style="flex:1;">📋 복사</button>
                            <a href="2_saju.html" target="_blank" class="action-btn primary" style="flex:1; text-align:center; text-decoration:none;">🔢 계산기 열기 →</a>
                        </div>
                        <textarea id="calculatorData" readonly style="width:100%; height:80px; font-size:12px; padding:10px; border:1px solid #e5dccb; border-radius:8px; background:#f9f6ef; resize:none;"></textarea>
                    </div>
                </div>

                <!-- Step 2: 사주계산 결과 -->
                <div class="card" id="sajuResultCard" style="display:none;">
                    <div class="card-header">
                        <span class="step-badge" style="background:#4a7c59; color:#fff; padding:2px 8px; border-radius:10px; font-size:11px; margin-right:8px;">Step 2</span>
                        <span class="icon">🧮</span>
                        <h3>사주계산 결과</h3>
                        <span id="sajuResultBadge" style="margin-left:auto; font-size:11px; background:#4a7c59; color:#fff; padding:3px 10px; border-radius:12px;">저장됨</span>
                    </div>
                    <div class="card-body">
                        <div id="sajuResultEmpty" style="display:none; text-align:center; padding:15px; color:#999;">아직 사주계산 결과가 없습니다.</div>
                        <div id="sajuResultContent" style="display:none;">
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <button class="action-btn primary" onclick="copySajuResult()" style="flex:1;">📋 복사</button>
                                <button class="action-btn" onclick="pasteSajuResult()" style="flex:1; background:#e8f5e9; color:#2e7d32; border:1px solid #a5d6a7;">📥 붙여넣기</button>
                                <a href="5_prompt.html" target="_blank" class="action-btn primary" style="flex:1; text-align:center; text-decoration:none;">📝 프롬프트 →</a>
                            </div>
                            <textarea id="sajuResultText" readonly style="width:100%; height:150px; font-size:11px; padding:12px; border:1px solid #e5dccb; border-radius:8px; background:#f9f6ef; resize:vertical; line-height:1.7; font-family:'Courier New', monospace;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 3: 인연상 계산 (프리미엄 전용) -->
                <div class="card premium-only-card" id="inyeonCalcCard" style="display:none;">
                    <div class="card-header">
                        <span class="step-badge" style="background:#9b59b6; color:#fff; padding:2px 8px; border-radius:10px; font-size:11px; margin-right:8px;">Step 3</span>
                        <span class="icon">💘</span>
                        <h3>인연상 계산</h3>
                        <span style="margin-left:auto; font-size:10px; background:#9b59b6; color:#fff; padding:2px 8px; border-radius:10px;">프리미엄</span>
                    </div>
                    <div class="card-body">
                        <div id="inyeonCalcEmpty" style="text-align:center; padding:15px; color:#999;">아직 인연상 계산 결과가 없습니다.</div>
                        <div id="inyeonCalcContent" style="display:none;">
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <button class="action-btn" onclick="copyInyeonCalcInput()" style="flex:1; background:#f3e5f5; color:#9b59b6; border:1px solid #ce93d8;">📋 입력 복사</button>
                                <a href="3_inyeon_calc.html" target="_blank" class="action-btn primary" style="flex:1; text-align:center; text-decoration:none; background:#9b59b6;">💘 계산기 →</a>
                            </div>
                            <button class="action-btn" onclick="pasteInyeonCalcResult()" style="width:100%; background:#f3e5f5; color:#9b59b6; border:1px solid #ce93d8; margin-bottom:10px;">📥 결과 붙여넣기</button>
                            <textarea id="inyeonCalcResultText" readonly style="width:100%; height:120px; font-size:11px; padding:12px; border:1px solid #ce93d8; border-radius:8px; background:#faf5fc; resize:vertical; line-height:1.7; font-family:'Courier New', monospace;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 4: 인연상 이미지 생성 (프리미엄 전용) -->
                <div class="card premium-only-card" id="inyeonImageCard" style="display:none;">
                    <div class="card-header">
                        <span class="step-badge" style="background:#9b59b6; color:#fff; padding:2px 8px; border-radius:10px; font-size:11px; margin-right:8px;">Step 4</span>
                        <span class="icon">🎨</span>
                        <h3>인연상 이미지</h3>
                        <span style="margin-left:auto; font-size:10px; background:#9b59b6; color:#fff; padding:2px 8px; border-radius:10px;">프리미엄</span>
                    </div>
                    <div class="card-body">
                        <div id="inyeonImageEmpty" style="text-align:center; padding:15px; color:#999;">아직 인연상 이미지가 없습니다.</div>
                        <div id="inyeonImageContent" style="display:none;">
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <button class="action-btn" onclick="copyInyeonHTML()" style="flex:1; background:#f3e5f5; color:#9b59b6; border:1px solid #ce93d8;">📋 HTML 복사</button>
                                <a href="4_inyeon_gen.html" target="_blank" class="action-btn primary" style="flex:1; text-align:center; text-decoration:none; background:#9b59b6;">🎨 생성기 →</a>
                            </div>
                            <button class="action-btn" onclick="pasteInyeonHTML()" style="width:100%; background:#f3e5f5; color:#9b59b6; border:1px solid #ce93d8; margin-bottom:10px;">📥 HTML 붙여넣기</button>
                            <textarea id="inyeonHTMLText" readonly style="width:100%; height:120px; font-size:11px; padding:12px; border:1px solid #ce93d8; border-radius:8px; background:#faf5fc; resize:vertical; line-height:1.7; font-family:'Courier New', monospace;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 5: 프롬프트 결과 (V6: 통합) -->
                <div class="card" id="promptResultCard" style="display:none;">
                    <div class="card-header">
                        <span class="step-badge" style="background:#4a7c59; color:#fff; padding:2px 8px; border-radius:10px; font-size:11px; margin-right:8px;">Step 5</span>
                        <span class="icon">📝</span>
                        <h3>프롬프트</h3>
                        <span id="promptResultBadge" style="margin-left:auto; font-size:11px; background:#4a7c59; color:#fff; padding:3px 10px; border-radius:12px;">저장됨</span>
                    </div>
                    <div class="card-body">
                        <div id="promptResultEmpty" style="display:none; text-align:center; padding:15px; color:#999;">아직 프롬프트 결과가 없습니다.</div>
                        <div id="promptResultContent" style="display:none;">
                            <!-- 통합 프롬프트 -->
                            <div style="background:#f9f6ef; border-radius:8px; padding:12px; margin-bottom:15px;">
                                <h4 style="margin:0 0 5px 0; font-size:13px; color:#5d4e37;">📋 프롬프트 (한 번에 복사!)</h4>
                                <p style="font-size:11px; color:#666; margin:0 0 10px 0;">🚀 이걸 Claude에 한 번에 보내세요!</p>
                                <button class="action-btn primary" onclick="copyPromptFull()" style="width:100%; margin-bottom:8px;">📋 전체 복사 → Claude</button>
                                <textarea id="promptResultFull" readonly style="width:100%; height:200px; font-size:10px; padding:10px; border:1px solid #e5dccb; border-radius:8px; background:#fff; resize:vertical; line-height:1.6; font-family:'Courier New', monospace;"></textarea>
                            </div>
                            
                            <!-- 붙여넣기 (기존 호환) -->
                            <button class="action-btn" onclick="pastePromptResult()" style="width:100%; background:#f5f5f5; color:#666; border:1px solid #ddd;">📥 프롬프트 붙여넣기 (수동)</button>
                            <textarea id="promptResultText" style="display:none;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 6: 결과글 저장 -->
                <div class="card" id="mainResultCard" style="display:none;">
                    <div class="card-header">
                        <span class="step-badge" style="background:#4a7c59; color:#fff; padding:2px 8px; border-radius:10px; font-size:11px; margin-right:8px;">Step 6</span>
                        <span class="icon">🎯</span>
                        <h3>결과글</h3>
                        <span id="mainResultCardBadge" style="margin-left:auto; font-size:11px; background:#999; color:#fff; padding:3px 10px; border-radius:12px;">미저장</span>
                    </div>
                    <div class="card-body">
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <button class="action-btn primary" onclick="copyMainResultDirect()" style="flex:1;">📋 복사</button>
                            <button class="action-btn" onclick="pasteMainResultDirect()" style="flex:1; background:#e8f5e9; color:#2e7d32; border:1px solid #a5d6a7;">📥 붙여넣기</button>
                            <button class="action-btn" onclick="openResultModal()" style="flex:1;">📄 모달</button>
                        </div>
                        <p style="font-size:11px; color:#999;">Claude에서 생성된 결과글을 붙여넣기 하세요.</p>
                    </div>
                </div>

                <!-- Step 7: 기본 결과파일 -->
                <div class="card" id="mainResultFileCard" style="display:none;">
                    <div class="card-header">
                        <span class="step-badge" style="background:#4a7c59; color:#fff; padding:2px 8px; border-radius:10px; font-size:11px; margin-right:8px;">Step 7</span>
                        <span class="icon">📄</span>
                        <h3>결과파일</h3>
                        <span id="mainResultFileStatus" style="margin-left:auto; font-size:11px; background:#999; color:#fff; padding:3px 10px; border-radius:12px;">미등록</span>
                    </div>
                    <div class="card-body">
                        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                            <input type="file" id="mainResultFile" accept=".html" style="display:none;" onchange="uploadResultFile('main')">
                            <button class="action-btn" onclick="document.getElementById('mainResultFile').click()" style="padding:10px 14px; font-size:12px;">📁 파일 선택</button>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="text" id="mainResultUrlInput" placeholder="또는 링크 직접 입력" style="flex:1; padding:10px 12px; border:1px solid #e5dccb; border-radius:6px; font-size:12px;">
                            <button class="action-btn" onclick="saveResultLink('main')" style="padding:10px 14px; font-size:12px;">💾 저장</button>
                        </div>
                        <a href="#" id="mainResultLink" target="_blank" style="display:none; margin-top:10px; font-size:12px; color:#8b6914;">🔗 결과지 보기</a>
                    </div>
                </div>

                <!-- ═══════ ❓ 추가질문 처리 ═══════ -->
                <div class="section-divider" style="display:none; margin:25px 0 15px; text-align:center;" id="additionalSectionDivider">
                    <span style="background:#f9f6ef; padding:0 15px; color:#e65100; font-size:13px; font-weight:600;">❓ 추가질문 처리</span>
                    <div style="border-bottom:2px solid #ffcc80; margin-top:-8px;"></div>
                </div>

                <!-- Step 8: 추가질문 프롬프트 -->
                <div class="card" id="additionalPromptCard" style="display:none;">
                    <div class="card-header">
                        <span class="step-badge" style="background:#e65100; color:#fff; padding:2px 8px; border-radius:10px; font-size:11px; margin-right:8px;">Step 8</span>
                        <span class="icon">❓</span>
                        <h3>추가질문 프롬프트</h3>
                        <span id="questionCountBadge" style="margin-left:auto; font-size:11px; background:var(--point-gold); color:#fff; padding:3px 10px; border-radius:12px;">0개</span>
                    </div>
                    <div class="card-body">
                        <div id="additionalPromptLoading" style="display:none;"></div>
                        <div id="additionalPromptEmpty" style="display:none; text-align:center; padding:15px; color:#999;">제출된 추가질문이 없습니다.</div>
                        <div id="additionalPromptAll" style="display:none;">
                            <button class="action-btn primary" onclick="copyAllQuestionsPrompt()" style="width:100%; margin-bottom:10px;">📋 복사 → Claude</button>
                            <textarea id="allQuestionsPrompt" readonly style="width:100%; height:120px; font-size:11px; padding:10px; border:1px solid #e5dccb; border-radius:8px; background:#f9f6ef; resize:vertical; line-height:1.6;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 9: 답변글 저장 -->
                <div class="card" id="additionalResultCard" style="display:none;">
                    <div class="card-header">
                        <span class="step-badge" style="background:#e65100; color:#fff; padding:2px 8px; border-radius:10px; font-size:11px; margin-right:8px;">Step 9</span>
                        <span class="icon">💬</span>
                        <h3>답변글</h3>
                        <span id="additionalResultCardBadge" style="margin-left:auto; font-size:11px; background:#999; color:#fff; padding:3px 10px; border-radius:12px;">미저장</span>
                    </div>
                    <div class="card-body">
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <button class="action-btn primary" onclick="copyAdditionalResultDirect()" style="flex:1;">📋 복사</button>
                            <button class="action-btn" onclick="pasteAdditionalResultDirect()" style="flex:1; background:#e8f5e9; color:#2e7d32; border:1px solid #a5d6a7;">📥 붙여넣기</button>
                            <button class="action-btn" onclick="openResultModal()" style="flex:1;">📄 모달</button>
                        </div>
                        <p style="font-size:11px; color:#999;">Claude에서 생성된 답변글을 붙여넣기 하세요.</p>
                    </div>
                </div>

                <!-- Step 10: 추가질문 결과파일 -->
                <div class="card" id="additionalResultFileCard" style="display:none;">
                    <div class="card-header">
                        <span class="step-badge" style="background:#e65100; color:#fff; padding:2px 8px; border-radius:10px; font-size:11px; margin-right:8px;">Step 10</span>
                        <span class="icon">📄</span>
                        <h3>답변파일</h3>
                        <span id="additionalResultFileStatus" style="margin-left:auto; font-size:11px; background:#999; color:#fff; padding:3px 10px; border-radius:12px;">미등록</span>
                    </div>
                    <div class="card-body">
                        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                            <input type="file" id="additionalResultFile" accept=".html" style="display:none;" onchange="uploadResultFile('additional')">
                            <button class="action-btn" onclick="document.getElementById('additionalResultFile').click()" style="padding:10px 14px; font-size:12px;">📁 파일 선택</button>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="text" id="additionalResultUrlInput" placeholder="또는 링크 직접 입력" style="flex:1; padding:10px 12px; border:1px solid #e5dccb; border-radius:6px; font-size:12px;">
                            <button class="action-btn" onclick="saveResultLink('additional')" style="padding:10px 14px; font-size:12px;">💾 저장</button>
                        </div>
                        <a href="#" id="additionalResultLink" target="_blank" style="display:none; margin-top:10px; font-size:12px; color:#8b6914;">🔗 결과지 보기</a>
                    </div>
                </div>

                <!-- ═══════ 📦 고객 정보 ═══════ -->
                <div class="section-divider" style="margin:25px 0 15px; text-align:center;">
                    <span style="background:#f9f6ef; padding:0 15px; color:#666; font-size:13px; font-weight:600;">📦 고객 정보</span>
                    <div style="border-bottom:2px solid #e0e0e0; margin-top:-8px;"></div>
                </div>

                <!-- 오행 분포 -->
                <div class="card" id="ohengCard" style="display:none;">
                    <div class="card-header">
                        <span class="icon">行</span>
                        <h3>오행 분포</h3>
                    </div>
                    <div class="card-body">
                        <div class="oheng-bars" id="ohengBars"></div>
                    </div>
                </div>

                <!-- 포함 항목 -->
                <div class="card">
                    <div class="card-header">
                        <span class="icon">📦</span>
                        <h3>결과지 포함 항목</h3>
                    </div>
                    <div class="card-body">
                        <div class="includes-list" id="includesList"></div>
                    </div>
                </div>

                <!-- 질문지 답변 -->
                <div class="card">
                    <div class="card-header">
                        <span class="icon">💭</span>
                        <h3>질문지 답변</h3>
                    </div>
                    <div class="card-body" id="questionsBody"></div>
                </div>

                <!-- 추가질문 목록 (상세) -->
                <div class="card" id="additionalQuestionListCard" style="display:none;">
                    <div class="card-header">
                        <span class="icon">❓</span>
                        <h3>추가질문 상세</h3>
                        <span id="questionListCountBadge" style="margin-left:auto; font-size:11px; background:#e65100; color:#fff; padding:3px 10px; border-radius:12px;">0개</span>
                    </div>
                    <div class="card-body">
                        <div id="additionalQuestionList"></div>
                    </div>
                </div>

                <!-- ═══════ 🔗 완료된 결과 링크 ═══════ -->
                <div class="card" id="completedLinksCard" style="display:none;">
                    <div class="card-header">
                        <span class="icon">🔗</span>
                        <h3>완료된 결과 링크</h3>
                    </div>
                    <div class="card-body">
                        <div id="completedMainLink" style="display:none; padding:10px; background:#e8f5e9; border-radius:8px; margin-bottom:10px;">
                            <span style="font-size:12px; color:#2e7d32;">📄 기본 결과지</span>
                            <a href="#" id="completedMainLinkUrl" target="_blank" style="display:block; font-size:13px; color:#1565c0; margin-top:5px;">🔗 결과지 보기</a>
                        </div>
                        <div id="completedAdditionalLink" style="display:none; padding:10px; background:#fff3e0; border-radius:8px;">
                            <span style="font-size:12px; color:#e65100;">📄 추가질문 결과지</span>
                            <a href="#" id="completedAdditionalLinkUrl" target="_blank" style="display:block; font-size:13px; color:#1565c0; margin-top:5px;">🔗 결과지 보기</a>
                        </div>
                    </div>
                </div>

                <!-- 액션 버튼 -->
                <div class="action-buttons">
                    <button id="deleteCustomerBtn" class="action-btn" onclick="deleteCustomer()" style="background:#fee; color:#c00;">🗑️ 이 고객 삭제</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 로딩 -->
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>불러오는 중...</p>
        </div>
    </div>

    <script>
        // ========== 로그인 시스템 ==========
        let currentAdmin = null;

        // 페이지 로드 시 로그인 체크
        window.addEventListener('DOMContentLoaded', function() {
            const saved = localStorage.getItem('admin_session');
            if (saved) {
                currentAdmin = JSON.parse(saved);
                showMainPage();
                // 백그라운드에서 검증
                verifyLogin(currentAdmin.id, currentAdmin.password);
            }
        });

        // 로그인 실행
        async function doLogin() {
            const id = document.getElementById('loginId').value;
            const pw = document.getElementById('loginPw').value;
            const loginBtn = document.querySelector('.login-btn');

            if (!id || !pw) {
                showLoginError('아이디와 비밀번호를 입력하세요');
                return;
            }

            // 로컬에서 빠르게 체크 (총관리자 - 하드코딩)
            if (id === 'oiah4579' && pw === '4579') {
                currentAdmin = {
                    id: 'oiah4579',
                    name: '총관리자',
                    password: '4579',
                    perm_view: true,
                    perm_status_paid: true,
                    perm_status_other: true,
                    perm_result: true,
                    perm_delete: true,
                    perm_edit: true,
                    perm_admin: true
                };
                localStorage.setItem('admin_session', JSON.stringify(currentAdmin));
                showMainPage();
                return;
            }

            // 캐시에서 확인 (이전에 로그인 성공한 관리자)
            const adminCache = JSON.parse(localStorage.getItem('admin_cache') || '{}');
            if (adminCache[id] && adminCache[id].password === pw) {
                currentAdmin = adminCache[id];
                localStorage.setItem('admin_session', JSON.stringify(currentAdmin));
                showMainPage();
                // 백그라운드에서 검증
                verifyLogin(id, pw);
                return;
            }

            // 로딩 표시
            loginBtn.textContent = '로그인 중...';
            loginBtn.disabled = true;

            // ★ Supabase 우선 로그인 (빠름!)
            try {
                const supabaseAdmin = await supabaseAdminLogin(id, pw);
                if (supabaseAdmin) {
                    currentAdmin = supabaseAdmin;
                    currentAdmin.password = pw;
                    localStorage.setItem('admin_session', JSON.stringify(currentAdmin));
                    adminCache[id] = currentAdmin;
                    localStorage.setItem('admin_cache', JSON.stringify(adminCache));
                    console.log('⚡ Supabase 로그인 성공');
                    showMainPage();
                    loginBtn.textContent = '로그인';
                    loginBtn.disabled = false;
                    return;
                }
            } catch (e) {
                console.log('Supabase 로그인 실패, Google Sheets로 시도...');
            }

            // Google Sheets 백업 로그인
            try {
                const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=adminLogin&id=${encodeURIComponent(id)}&password=${encodeURIComponent(pw)}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    currentAdmin = result.admin;
                    currentAdmin.password = pw;
                    localStorage.setItem('admin_session', JSON.stringify(currentAdmin));
                    adminCache[id] = currentAdmin;
                    localStorage.setItem('admin_cache', JSON.stringify(adminCache));
                    // ★ Supabase에도 동기화
                    supabaseUpsertAdmin({ ...currentAdmin, status: 'approved' });
                    showMainPage();
                } else {
                    showLoginError(result.error || '로그인 실패');
                }
            } catch (error) {
                showLoginError('서버 연결 실패');
            }

            // 버튼 복구
            loginBtn.textContent = '로그인';
            loginBtn.disabled = false;
        }

        // 백그라운드 검증
        async function verifyLogin(id, pw) {
            try {
                const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=adminLogin&id=${encodeURIComponent(id)}&password=${encodeURIComponent(pw)}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (!result.success) {
                    // 검증 실패 - 로그아웃
                    doLogout();
                } else {
                    // 권한 업데이트
                    currentAdmin = result.admin;
                    currentAdmin.password = pw;
                    localStorage.setItem('admin_session', JSON.stringify(currentAdmin));
                    applyPermissions();
                }
            } catch (error) {
                console.log('백그라운드 검증 실패:', error);
            }
        }

        // 로그아웃
        function doLogout() {
            currentAdmin = null;
            localStorage.removeItem('admin_session');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginId').value = '';
            document.getElementById('loginPw').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // 메인 페이지 표시
        function showMainPage() {
            document.getElementById('loginScreen').classList.add('hidden');
            applyPermissions();

            // 로그인한 사용자 이름 표시
            const userEl = document.getElementById('loggedInUser');
            if (userEl && currentAdmin) {
                userEl.querySelector('strong').textContent = currentAdmin.name;
                userEl.style.display = 'inline';
            }

            // 총관리자면 승인 대기 알림 체크
            if (currentAdmin && currentAdmin.perm_admin) {
                checkPendingAdmins();
            }

            // ★ 새 고객 알림 폴링 시작 (30초마다)
            startNewCustomerPolling();
        }

        // ========== 새 고객 실시간 알림 시스템 (Supabase Realtime) ==========
        let lastCustomerCount = 0;
        let realtimeChannel = null;

        function startNewCustomerPolling() {
            // 현재 고객 수 저장
            lastCustomerCount = customers.length;

            // Supabase Realtime 구독 시작
            setupRealtimeSubscription();
        }

        // Supabase Realtime 구독 설정
        function setupRealtimeSubscription() {
            // 이미 연결되어 있으면 스킵
            if (realtimeChannel) return;

            try {
                // Supabase Realtime WebSocket 연결
                const wsUrl = SAJU_CONFIG.supabase.url.replace('https://', 'wss://') + '/realtime/v1/websocket?apikey=' + SAJU_CONFIG.supabase.anonKey + '&vsn=1.0.0';
                const ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('🔔 Supabase Realtime 연결됨!');

                    // 채널 구독 메시지
                    const joinMsg = {
                        topic: 'realtime:public:customers',
                        event: 'phx_join',
                        payload: {
                            config: {
                                broadcast: { self: false },
                                presence: { key: '' },
                                postgres_changes: [{
                                    event: 'INSERT',
                                    schema: 'public',
                                    table: 'customers'
                                }]
                            }
                        },
                        ref: '1'
                    };
                    ws.send(JSON.stringify(joinMsg));

                    // 하트비트 (30초마다)
                    setInterval(() => {
                        if (ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({ topic: 'phoenix', event: 'heartbeat', payload: {}, ref: Date.now().toString() }));
                        }
                    }, 30000);
                };

                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);

                        // INSERT 이벤트 감지
                        if (msg.event === 'postgres_changes' && msg.payload?.data?.type === 'INSERT') {
                            const newCustomer = msg.payload.data.record;
                            console.log('🎉 새 고객 실시간 감지:', newCustomer.name);
                            showNewCustomerAlert(1, newCustomer.name);
                            loadCustomers(true); // 목록 새로고침
                        }
                    } catch (e) {
                        // JSON 파싱 실패는 무시
                    }
                };

                ws.onerror = (error) => {
                    console.log('Realtime 에러, 폴백 모드로 전환:', error);
                    startFallbackPolling();
                };

                ws.onclose = () => {
                    console.log('Realtime 연결 종료, 5초 후 재연결...');
                    realtimeChannel = null;
                    setTimeout(setupRealtimeSubscription, 5000);
                };

                realtimeChannel = ws;
            } catch (e) {
                console.log('Realtime 설정 실패, 폴백 모드:', e);
                startFallbackPolling();
            }
        }

        // 폴백: Realtime 실패 시 폴링 모드
        let pollingInterval = null;
        function startFallbackPolling() {
            if (pollingInterval) return;
            pollingInterval = setInterval(checkNewCustomers, 30000);
            console.log('🔔 폴백 모드: 30초 폴링 시작');
        }

        async function checkNewCustomers() {
            try {
                // Supabase에서 최신 고객 수 확인
                const response = await fetch(
                    `${SAJU_CONFIG.supabase.url}/rest/v1/customers?select=id&order=created_at.desc&limit=1`,
                    { headers: supabaseHeaders }
                );
                if (!response.ok) return;

                // 전체 고객 수 확인
                const countResponse = await fetch(
                    `${SAJU_CONFIG.supabase.url}/rest/v1/customers?select=count`,
                    { headers: { ...supabaseHeaders, 'Prefer': 'count=exact' } }
                );

                const contentRange = countResponse.headers.get('content-range');
                const totalCount = contentRange ? parseInt(contentRange.split('/')[1]) : 0;

                if (totalCount > lastCustomerCount && lastCustomerCount > 0) {
                    const newCount = totalCount - lastCustomerCount;
                    showNewCustomerAlert(newCount);
                    lastCustomerCount = totalCount;

                    // 자동 새로고침
                    await loadCustomers(true);
                }
            } catch (e) {
                console.log('새 고객 체크 실패:', e);
            }
        }

        function showNewCustomerAlert(count, customerName = null) {
            // 브라우저 알림 권한 요청
            const message = customerName
                ? `${customerName}님이 신청했습니다!`
                : `${count}명의 새 고객이 신청했습니다.`;

            if (Notification.permission === 'granted') {
                new Notification('🎉 새 고객 신청!', {
                    body: message,
                    icon: '📋'
                });
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission();
            }

            // 화면 알림
            const alert = document.createElement('div');
            alert.className = 'new-customer-alert';
            const alertText = customerName
                ? `🎉 ${customerName}님이 신청했습니다!`
                : `🎉 새 고객 ${count}명이 신청했습니다!`;
            alert.innerHTML = `
                <div class="alert-content">
                    <span class="alert-icon">🎉</span>
                    <span class="alert-text">${alertText}</span>
                    <button onclick="this.parentElement.parentElement.remove()">✕</button>
                </div>
            `;
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #4a7c59, #6b9b7a);
                color: white;
                padding: 15px 25px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideDown 0.3s ease;
            `;
            document.body.appendChild(alert);

            // 5초 후 자동 제거
            setTimeout(() => alert.remove(), 5000);

            // 소리 알림 (선택적)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onr6ysKGUi4uXpbK/w7u0qqKbm6GnsbvDxL22raObmZuepq+5wcTAuLCtqKajp6y0u8HEw7+5s66qp6eprrS6v8LAu7aysKyqqq2yt7u+vry5tbKvrKytsba6vb68ubW0sbCvsLK1ubu9vLq3tbOxsLGztba5u7y7uba0s7GxsbO1t7m7u7q4trSzsrKztLa4uru7urm3tbSzs7O0tre5uru6uLe1tLO0tLW2uLm6urm4t7W0tLW1tri5uru6ubi2tbS0tbW2t7i5ubm4t7a1tLS1tba3uLm5ubi3trW0tbW2t7i4ubm4t7a1tbW1tre4ubm5uLe2tbW1tba3uLi5ubi3t7a1tbW2tre4uLi4t7e2trW1tba3t7i4uLe3trW1tba2t7e4uLi3t7a2tbW2tre3uLi4t7e2trW1tba3t7i4t7e3trW1tba2t7e3t7e3trW1tba2t7e3t7e2trW1tbW2t7e3t7e2trW1tba2tre3t7e2trW1tba2tre3t7e2trW1tba2tre3t7e2trW1');
                audio.volume = 0.3;
                audio.play();
            } catch (e) {}
        }
        
        // 승인 대기 관리자 수 체크
        async function checkPendingAdmins() {
            const adminBtn = document.getElementById('adminManageBtn');
            if (!adminBtn) return;
            
            // 뱃지 업데이트 함수
            function updateBadge(count) {
                const oldBadge = adminBtn.querySelector('.header-badge');
                if (oldBadge) oldBadge.remove();
                
                if (count > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'header-badge';
                    badge.textContent = count;
                    adminBtn.appendChild(badge);
                }
            }
            
            // 1. 캐시에서 먼저 표시 (즉시)
            const cached = localStorage.getItem('adminList_cache');
            if (cached) {
                const cachedAdmins = JSON.parse(cached);
                const pendingCount = cachedAdmins.filter(a => a.status === 'pending').length;
                updateBadge(pendingCount);
            }
            
            // 2. 백그라운드에서 최신 데이터 로드
            try {
                const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=getAdminList`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    localStorage.setItem('adminList_cache', JSON.stringify(result.admins));
                    const pendingCount = result.admins.filter(a => a.status === 'pending').length;
                    updateBadge(pendingCount);
                }
            } catch (error) {
                console.log('승인 대기 체크 실패:', error);
            }
        }

        // 권한 적용
        function applyPermissions() {
            if (!currentAdmin) return;
            
            // 관리자 관리 버튼 (perm_admin 있을 때만)
            const adminBtn = document.getElementById('adminManageBtn');
            if (adminBtn) {
                adminBtn.style.display = currentAdmin.perm_admin ? 'inline-block' : 'none';
            }
            
            // 삭제 버튼 (perm_delete)
            const deleteBtn = document.getElementById('deleteCustomerBtn');
            if (deleteBtn) {
                deleteBtn.style.display = currentAdmin.perm_delete ? 'block' : 'none';
            }
            
            // 정보 수정 버튼 (perm_edit)
            const editBtn = document.querySelector('[onclick="openEditModal()"]');
            if (editBtn) {
                editBtn.style.display = currentAdmin.perm_edit ? 'block' : 'none';
            }
            
            // 진행 상태 변경 (perm_status_paid 또는 perm_status_other)
            const statusSelect = document.getElementById('statusSelect');
            if (statusSelect) {
                statusSelect.disabled = !(currentAdmin.perm_status_paid || currentAdmin.perm_status_other);
                
                // 옵션 숨기기/보이기
                Array.from(statusSelect.options).forEach(opt => {
                    if (opt.value === '신규' || opt.value === '입금확인') {
                        opt.style.display = currentAdmin.perm_status_paid ? '' : 'none';
                    }
                    if (opt.value === '작성중' || opt.value === '완료') {
                        opt.style.display = currentAdmin.perm_status_other ? '' : 'none';
                    }
                });
            }
            
            // 추가질문 상태 변경 (perm_status_other)
            const answerSelect = document.getElementById('answerStatusSelect');
            if (answerSelect) {
                answerSelect.disabled = !currentAdmin.perm_status_other;
            }
            
            // 결과 링크 (perm_result)
            const mainFileCard = document.getElementById('mainResultFileCard');
            const additionalFileCard = document.getElementById('additionalResultFileCard');
            if (mainFileCard && !currentAdmin.perm_result) {
                mainFileCard.style.display = 'none';
            }
            if (additionalFileCard && !currentAdmin.perm_result) {
                additionalFileCard.style.display = 'none';
            }
        }

        // 로그인 에러 표시
        function showLoginError(msg) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = msg;
            errorEl.style.display = 'block';
        }

        // ========== CONFIG ==========
        const SAJU_CONFIG = {
            prices: {
                light: 14900,
                standard: 24900,
                premium: 39900
            },
            packages: {
                // 영어 키 (입력폼, 테스트 데이터)
                light: {
                    name: "라이트",
                    emoji: "🌱",
                    pages: "10~12",
                    selectable: 1,
                    includes: [
                        "표지", "일간 해석", "오행 분포", "2025년 운세",
                        "월별 키워드", "선택 1가지", "마무리"
                    ]
                },
                standard: {
                    name: "스탠다드",
                    emoji: "⭐",
                    pages: "18~22",
                    selectable: 2,
                    includes: [
                        "표지", "일간 해석", "오행 상세", "성격 분석",
                        "2025년 운세", "월별 상세", "선택 2가지", "대운 간단", "마무리"
                    ]
                },
                premium: {
                    name: "프리미엄",
                    emoji: "👑",
                    pages: "28~35",
                    selectable: 0,
                    includes: [
                        "표지", "사주 구조", "일간 심화", "오행 상세", "성격 심화",
                        "2025년 운세", "월별 상세", "연애운", "직업운", "재물운",
                        "건강운", "대운 10년", "귀인/피할 사람", "맞춤 질문", "마무리"
                    ]
                },
                // 한글 키 (Google Sheets 데이터용)
                "라이트": {
                    name: "라이트",
                    emoji: "🌱",
                    pages: "10~12",
                    selectable: 1,
                    includes: ["표지", "일간 해석", "오행 분포", "2025년 운세", "월별 키워드", "선택 1가지", "마무리"]
                },
                "스탠다드": {
                    name: "스탠다드",
                    emoji: "⭐",
                    pages: "18~22",
                    selectable: 2,
                    includes: ["표지", "일간 해석", "오행 상세", "성격 분석", "2025년 운세", "월별 상세", "선택 2가지", "대운 간단", "마무리"]
                },
                "프리미엄": {
                    name: "프리미엄",
                    emoji: "👑",
                    pages: "28~35",
                    selectable: 0,
                    includes: ["표지", "사주 구조", "일간 심화", "오행 상세", "성격 심화", "2025년 운세", "월별 상세", "연애운", "직업운", "재물운", "건강운", "대운 10년", "귀인/피할 사람", "맞춤 질문", "마무리"]
                }
            },
            selectableOptions: {
                love: "연애/결혼운",
                career: "직업/진로운",
                wealth: "재물/사업운"
            },
            googleSheets: {
                webAppUrl: "https://script.google.com/macros/s/AKfycbzlnTB3d3tO_qvRNKgiLkGgy3EmH_92eYslv4mODGzV7QCiVHYTDLEl4duNlp3PO_kclA/exec"
            },
            supabase: {
                url: "https://hvxacycvwfwhzfqftscx.supabase.co",
                anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2eGFjeWN2d2Z3aHpmcWZ0c2N4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTAyMjQsImV4cCI6MjA4MzE4NjIyNH0.MK6k6hOQA9YajKqNvRoBelW6aO7eSjW8g5m72JWL4Tg"
            }
        };

        // ========== Supabase 헬퍼 함수들 ==========
        const supabaseHeaders = {
            'apikey': SAJU_CONFIG.supabase.anonKey,
            'Authorization': `Bearer ${SAJU_CONFIG.supabase.anonKey}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
        };

        // ========== 페이지네이션 설정 ==========
        const PAGE_SIZE = 50; // 한 번에 로드할 고객 수
        let currentPage = 1;
        let hasMoreData = true;
        let isLoadingMore = false;

        // Supabase에서 고객 목록 조회 (페이지네이션 + 지연 로딩)
        async function supabaseGetCustomers(page = 1, append = false) {
            try {
                const offset = (page - 1) * PAGE_SIZE;

                // ★ 진행 중인 고객은 전체 데이터, 완료된 고객은 기본 정보만 (성능 최적화)
                // 기본 필드: 목록 표시에 필요한 최소 정보
                const basicFields = 'id,order_code,name,birth_year,birth_month,birth_day,birth_hour,birth_minute,gender,calendar_type,package,status,answer_status,matching_interest,memo,created_at';

                // 완료 상태가 아닌 고객 (전체 데이터) - 페이지네이션 적용
                const activeResponse = await fetch(
                    `${SAJU_CONFIG.supabase.url}/rest/v1/customers?status=neq.완료&order=created_at.desc&limit=${PAGE_SIZE}&offset=${offset}`,
                    { headers: { ...supabaseHeaders, 'Prefer': 'count=exact' } }
                );

                if (!activeResponse.ok) {
                    throw new Error('Supabase 조회 실패');
                }

                const activeCustomers = await activeResponse.json();

                // 더 불러올 데이터가 있는지 확인
                const contentRange = activeResponse.headers.get('content-range');
                if (contentRange) {
                    const [range, total] = contentRange.split('/');
                    hasMoreData = activeCustomers.length === PAGE_SIZE && (offset + PAGE_SIZE) < parseInt(total);
                } else {
                    hasMoreData = activeCustomers.length === PAGE_SIZE;
                }

                // 첫 페이지면 완료된 고객도 함께 로드 (별도 페이징)
                let completedCustomers = [];
                if (page === 1) {
                    const completedResponse = await fetch(
                        `${SAJU_CONFIG.supabase.url}/rest/v1/customers?status=eq.완료&select=${basicFields}&order=created_at.desc&limit=${PAGE_SIZE}`,
                        { headers: supabaseHeaders }
                    );
                    if (completedResponse.ok) {
                        completedCustomers = await completedResponse.json();
                        completedCustomers.forEach(c => {
                            c._needsDetailLoad = true;
                        });
                    }
                }

                console.log(`⚡ Supabase 로드 (페이지 ${page}): 진행중 ${activeCustomers.length}건, 완료 ${completedCustomers.length}건`);

                return [...activeCustomers, ...completedCustomers];
            } catch (error) {
                console.error('Supabase 조회 에러:', error);
                return null;
            }
        }

        // 더 불러오기 (무한 스크롤)
        async function loadMoreCustomers() {
            if (isLoadingMore || !hasMoreData) return;

            isLoadingMore = true;
            currentPage++;

            const moreCustomers = await supabaseGetCustomers(currentPage, true);
            if (moreCustomers && moreCustomers.length > 0) {
                // Supabase 형식 → 앱 형식 변환 후 추가
                const converted = moreCustomers.map(convertFromSupabaseFormat);
                customers = [...customers, ...converted];
                renderCustomerList();
            }

            isLoadingMore = false;
        }

        // 스크롤 이벤트 (무한 스크롤)
        function setupInfiniteScroll() {
            const list = document.getElementById('customerList');
            if (!list) return;

            list.addEventListener('scroll', () => {
                if (list.scrollTop + list.clientHeight >= list.scrollHeight - 100) {
                    loadMoreCustomers();
                }
            });
        }

        // 완료된 고객의 상세 데이터 로드 (클릭 시)
        async function supabaseLoadCustomerDetail(orderCode) {
            try {
                const response = await fetch(
                    `${SAJU_CONFIG.supabase.url}/rest/v1/customers?order_code=eq.${encodeURIComponent(orderCode)}`,
                    { headers: supabaseHeaders }
                );
                if (!response.ok) throw new Error('상세 데이터 조회 실패');
                const data = await response.json();
                return data.length > 0 ? data[0] : null;
            } catch (error) {
                console.error('상세 데이터 로드 에러:', error);
                return null;
            }
        }

        // ========== Supabase 관리자 함수 ==========

        // Supabase에서 관리자 로그인
        async function supabaseAdminLogin(id, password) {
            try {
                const response = await fetch(
                    `${SAJU_CONFIG.supabase.url}/rest/v1/admins?id=eq.${encodeURIComponent(id)}&password=eq.${encodeURIComponent(password)}&status=eq.approved&select=*`,
                    { headers: supabaseHeaders }
                );
                if (!response.ok) return null;
                const data = await response.json();
                return data.length > 0 ? data[0] : null;
            } catch (error) {
                console.error('Supabase 로그인 에러:', error);
                return null;
            }
        }

        // Supabase에서 관리자 목록 조회
        async function supabaseGetAdmins() {
            try {
                const response = await fetch(
                    `${SAJU_CONFIG.supabase.url}/rest/v1/admins?status=eq.approved&select=*`,
                    { headers: supabaseHeaders }
                );
                if (!response.ok) return null;
                return await response.json();
            } catch (error) {
                console.error('Supabase 관리자 목록 에러:', error);
                return null;
            }
        }

        // Supabase에 관리자 추가/업데이트
        async function supabaseUpsertAdmin(admin) {
            try {
                const response = await fetch(
                    `${SAJU_CONFIG.supabase.url}/rest/v1/admins?on_conflict=id`,
                    {
                        method: 'POST',
                        headers: { ...supabaseHeaders, 'Prefer': 'resolution=merge-duplicates' },
                        body: JSON.stringify(admin)
                    }
                );
                return response.ok;
            } catch (error) {
                console.error('Supabase 관리자 저장 에러:', error);
                return false;
            }
        }

        // Supabase에서 관리자 삭제
        async function supabaseDeleteAdmin(id) {
            try {
                const response = await fetch(
                    `${SAJU_CONFIG.supabase.url}/rest/v1/admins?id=eq.${encodeURIComponent(id)}`,
                    { method: 'DELETE', headers: supabaseHeaders }
                );
                return response.ok;
            } catch (error) {
                console.error('Supabase 관리자 삭제 에러:', error);
                return false;
            }
        }

        // Supabase 설정 조회
        async function supabaseGetSetting(key) {
            try {
                const response = await fetch(
                    `${SAJU_CONFIG.supabase.url}/rest/v1/settings?key=eq.${encodeURIComponent(key)}&select=value`,
                    { headers: supabaseHeaders }
                );
                if (!response.ok) return null;
                const data = await response.json();
                return data.length > 0 ? data[0].value : null;
            } catch (error) {
                return null;
            }
        }

        // Supabase 설정 저장
        async function supabaseSetSetting(key, value) {
            try {
                const response = await fetch(
                    `${SAJU_CONFIG.supabase.url}/rest/v1/settings?on_conflict=key`,
                    {
                        method: 'POST',
                        headers: { ...supabaseHeaders, 'Prefer': 'resolution=merge-duplicates' },
                        body: JSON.stringify({ key, value, updated_at: new Date().toISOString() })
                    }
                );
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // ========== Supabase 고객 함수 ==========

        // Supabase에 고객 추가
        async function supabaseInsertCustomer(customer, upsert = false) {
            try {
                const data = convertToSupabaseFormat(customer);

                // order_code가 없으면 스킵
                if (!data.order_code) {
                    console.warn('order_code 없음, 스킵:', customer.name);
                    return null;
                }

                const headers = { ...supabaseHeaders };

                // upsert 모드: 중복 시 업데이트
                if (upsert) {
                    headers['Prefer'] = 'resolution=merge-duplicates';
                }

                const url = upsert
                    ? `${SAJU_CONFIG.supabase.url}/rest/v1/customers?on_conflict=order_code`
                    : `${SAJU_CONFIG.supabase.url}/rest/v1/customers`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`Supabase 추가 실패: ${response.status} - ${errText}`);
                }

                // 201 Created 또는 200 OK (upsert 성공)
                const text = await response.text();
                return text ? JSON.parse(text) : { success: true };
            } catch (error) {
                console.error('Supabase 추가 에러:', error);
                return null;
            }
        }

        // Supabase 고객 업데이트
        async function supabaseUpdateCustomer(orderCode, updates) {
            try {
                const data = convertToSupabaseFormat(updates);
                const response = await fetch(
                    `${SAJU_CONFIG.supabase.url}/rest/v1/customers?order_code=eq.${encodeURIComponent(orderCode)}`,
                    {
                        method: 'PATCH',
                        headers: supabaseHeaders,
                        body: JSON.stringify(data)
                    }
                );
                if (!response.ok) throw new Error('Supabase 업데이트 실패');
                return await response.json();
            } catch (error) {
                console.error('Supabase 업데이트 에러:', error);
                return null;
            }
        }

        // Supabase 고객 삭제
        async function supabaseDeleteCustomer(orderCode) {
            try {
                const response = await fetch(
                    `${SAJU_CONFIG.supabase.url}/rest/v1/customers?order_code=eq.${encodeURIComponent(orderCode)}`,
                    { method: 'DELETE', headers: supabaseHeaders }
                );
                return response.ok;
            } catch (error) {
                console.error('Supabase 고객 삭제 에러:', error);
                return false;
            }
        }

        // Google Sheets 형식 → Supabase 형식 변환
        function convertToSupabaseFormat(customer) {
            // Supabase 테이블에 있는 필드만 매핑
            const allowedFields = [
                'order_code', 'name', 'birth_year', 'birth_month', 'birth_day',
                'birth_hour', 'birth_minute', 'gender', 'calendar_type', 'package',
                'status', 'phone', 'email', 'main_concern', 'repeat_pattern',
                'custom_question', 'fortune_type', 'love_status', 'job_status',
                'partner_gender', 'matching_interest', 'saju_result', 'prompt_result',
                'main_result_text', 'result_url', 'inyeon_calc_result', 'inyeon_html',
                'answer_status', 'additional_result_text', 'additional_result_url',
                'memo', 'payment_status', 'payment_date'
            ];

            const mapping = {
                orderCode: 'order_code',
                birthYear: 'birth_year',
                birthMonth: 'birth_month',
                birthDay: 'birth_day',
                birthHour: 'birth_hour',
                birthMinute: 'birth_minute',
                calendarType: 'calendar_type',
                mainConcern: 'main_concern',
                repeatPattern: 'repeat_pattern',
                customQuestion: 'custom_question',
                fortuneType: 'fortune_type',
                loveStatus: 'love_status',
                jobStatus: 'job_status',
                partnerGender: 'partner_gender',
                matchingInterest: 'matching_interest',
                sajuResult: 'saju_result',
                promptResult: 'prompt_result',
                mainResultText: 'main_result_text',
                resultUrl: 'result_url',
                inyeonCalcResult: 'inyeon_calc_result',
                inyeonHTML: 'inyeon_html',
                _answerStatus: 'answer_status',
                additionalResultText: 'additional_result_text',
                additionalResultUrl: 'additional_result_url',
                paymentStatus: 'payment_status',
                paymentDate: 'payment_date'
            };

            const result = {};
            for (const [key, value] of Object.entries(customer)) {
                if (key.startsWith('_') && key !== '_answerStatus') continue;
                const newKey = mapping[key] || key;
                // 허용된 필드만 포함
                if (allowedFields.includes(newKey) && value !== undefined && value !== null) {
                    result[newKey] = value;
                }
            }
            return result;
        }

        // Supabase 형식 → Google Sheets 형식 변환
        function convertFromSupabaseFormat(row) {
            return {
                orderCode: row.order_code,
                name: row.name,
                birthYear: row.birth_year,
                birthMonth: row.birth_month,
                birthDay: row.birth_day,
                birthHour: row.birth_hour,
                birthMinute: row.birth_minute,
                gender: row.gender,
                calendarType: row.calendar_type,
                package: row.package,
                status: row.status,
                phone: row.phone,
                email: row.email,
                mainConcern: row.main_concern,
                repeatPattern: row.repeat_pattern,
                customQuestion: row.custom_question,
                fortuneType: row.fortune_type,
                loveStatus: row.love_status,
                jobStatus: row.job_status,
                partnerGender: row.partner_gender,
                matchingInterest: row.matching_interest,
                sajuResult: row.saju_result,
                promptResult: row.prompt_result,
                mainResultText: row.main_result_text,
                resultUrl: row.result_url,
                inyeonCalcResult: row.inyeon_calc_result,
                inyeonHTML: row.inyeon_html,
                _answerStatus: row.answer_status || '미제출',
                additionalResultText: row.additional_result_text,
                additionalResultUrl: row.additional_result_url,
                memo: row.memo,
                paymentStatus: row.payment_status,
                paymentDate: row.payment_date,
                _supabaseId: row.id
            };
        }

        // Google Sheets 데이터 → Supabase로 마이그레이션
        async function migrateToSupabase() {
            if (!confirm('Google Sheets의 모든 데이터를 Supabase로 복사합니다.\n(이미 있는 데이터는 업데이트됩니다)\n계속하시겠습니까?')) {
                return;
            }

            console.log('🚀 마이그레이션 시작... (upsert 모드)');
            let success = 0, failed = 0, skipped = 0;

            for (const customer of customers) {
                try {
                    // upsert=true: 중복 시 업데이트
                    const result = await supabaseInsertCustomer(customer, true);
                    if (result) {
                        success++;
                        console.log(`✅ ${customer.name} (${customer.orderCode}) 완료`);
                    } else {
                        skipped++;
                        console.warn(`⚠️ ${customer.name} 스킵됨`);
                    }
                } catch (e) {
                    failed++;
                    console.error(`❌ ${customer.name} 실패:`, e);
                }
            }

            alert(`마이그레이션 완료!\n✅ 성공: ${success}건\n⚠️ 스킵: ${skipped}건\n❌ 실패: ${failed}건`);
        }

        // ★ 엑셀 → Supabase 자동 동기화 (백그라운드)
        async function syncSheetsToSupabase(sheetsCustomers) {
            let synced = 0;
            for (const customer of sheetsCustomers) {
                if (!customer.orderCode) continue;
                try {
                    // upsert 모드로 업데이트 (있으면 업데이트, 없으면 추가)
                    await supabaseInsertCustomer(customer, true);
                    synced++;
                } catch (e) {
                    // 에러는 무시 (백그라운드 동기화)
                }
            }
            console.log(`⚡ 엑셀 → Supabase 동기화 완료: ${synced}건`);
        }

        // ========== 사주 계산 데이터 ==========
        const CHEONGAN = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
        const JIJI = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        const CHEONGAN_KO = ['갑', '을', '병', '정', '무', '기', '경', '신', '임', '계'];
        const JIJI_KO = ['자', '축', '인', '묘', '진', '사', '오', '미', '신', '유', '술', '해'];

        const OHENG_CHEONGAN = {
            '甲': '목', '乙': '목', '丙': '화', '丁': '화', '戊': '토',
            '己': '토', '庚': '금', '辛': '금', '壬': '수', '癸': '수'
        };
        const OHENG_JIJI = {
            '子': '수', '丑': '토', '寅': '목', '卯': '목', '辰': '토', '巳': '화',
            '午': '화', '未': '토', '申': '금', '酉': '금', '戌': '토', '亥': '수'
        };

        const MONTH_JIJI = ['寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥', '子', '丑'];

        // ========== 상태 ==========
        let customers = [];
        let selectedCustomer = null;

        // ========== 초기화 ==========
        document.addEventListener('DOMContentLoaded', function() {
            loadCustomers();
            setupInfiniteScroll(); // 무한 스크롤 설정
        });

        // ========== 강제 새로고침 (캐시 완전 무효화) ==========
        async function forceRefresh() {
            console.log('🔄 강제 새로고침 시작 - 캐시 삭제');

            // 1. 모든 캐시 완전 삭제
            localStorage.removeItem('saju_customers');
            localStorage.removeItem('saju_question_statuses');

            // 2. 메모리도 클리어
            customers = [];
            selectedCustomer = null;

            // 3. 로딩 표시
            const list = document.getElementById('customerList');
            list.innerHTML = `
                <div class="empty-state">
                    <div class="icon">⏳</div>
                    <p>최신 데이터 불러오는 중...</p>
                </div>
            `;
            document.getElementById('customerCount').textContent = '로딩중...';

            // 4. 강제로 서버에서만 로드
            await loadCustomers(true);
        }

        // ========== 고객 목록 로드 ==========
        async function loadCustomers(forceFromServer = false) {
            // 1. 강제 새로고침이 아니면 캐시 먼저 표시 (즉시!)
            if (!forceFromServer) {
                try {
                    const localData = JSON.parse(localStorage.getItem('saju_customers') || '[]');
                    const cachedStatuses = JSON.parse(localStorage.getItem('saju_question_statuses') || '{}');

                    if (localData.length > 0) {
                        console.log('캐시에서 즉시 표시:', localData.length, '건');
                        customers = localData;

                        // ★ 캐시된 상태 즉시 적용
                        applyQuestionStatuses(cachedStatuses);
                        renderCustomerList();
                    }
                } catch (e) {
                    console.log('캐시 로드 실패:', e);
                }
            }

            // 2. Supabase 우선, Google Sheets 백업 (병렬 로드)
            const timestamp = Date.now();
            try {
                // ★ Supabase + Google Sheets + 추가질문 상태 동시에 로드
                const [supabaseData, sheetsData, statusesData] = await Promise.all([
                    supabaseGetCustomers(),
                    fetch(`${SAJU_CONFIG.googleSheets.webAppUrl}?_t=${timestamp}`).then(r => r.json()).catch(() => null),
                    fetch(`${SAJU_CONFIG.googleSheets.webAppUrl}?action=getAllQuestionStatuses&_t=${timestamp}`).then(r => r.json()).catch(() => null)
                ]);

                let updated = false;

                // ★ Supabase 데이터 우선 사용 (더 빠름!)
                if (supabaseData && supabaseData.length > 0) {
                    console.log('⚡ Supabase 동기화:', supabaseData.length, '건');
                    customers = supabaseData.map(convertFromSupabaseFormat);
                    localStorage.setItem('saju_customers', JSON.stringify(customers));
                    updated = true;
                }
                // Supabase 실패 시 Google Sheets 사용 (백업)
                else if (sheetsData) {
                    const newCustomers = Array.isArray(sheetsData) ? sheetsData.filter(c => c.name) : (sheetsData.data || []);
                    if (newCustomers.length > 0) {
                        console.log('📊 Google Sheets 동기화 (백업):', newCustomers.length, '건');
                        customers = newCustomers;
                        localStorage.setItem('saju_customers', JSON.stringify(customers));
                        updated = true;
                    }
                }

                // ★ 엑셀 수정분 Supabase에 자동 동기화 (강제 새로고침 시)
                if (forceFromServer && sheetsData) {
                    const sheetsCustomers = Array.isArray(sheetsData) ? sheetsData.filter(c => c.name) : (sheetsData.data || []);
                    if (sheetsCustomers.length > 0) {
                        console.log('🔄 엑셀 → Supabase 동기화 시작...');
                        syncSheetsToSupabase(sheetsCustomers);
                    }
                }

                // 추가질문 상태 업데이트
                if (statusesData && statusesData.success) {
                    const statuses = statusesData.statuses || {};
                    localStorage.setItem('saju_question_statuses', JSON.stringify(statuses));
                    applyQuestionStatuses(statuses);
                    updated = true;
                }

                if (updated) {
                    renderCustomerList();
                    if (forceFromServer) {
                        console.log('✅ 강제 새로고침 완료!');
                    }
                }
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                if (forceFromServer) {
                    const list = document.getElementById('customerList');
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">❌</div>
                            <p>데이터 로드 실패<br>인터넷 연결을 확인해주세요</p>
                        </div>
                    `;
                }
            }
        }
        
        // ========== 추가질문 상태 적용 (캐시/API 공용) ==========
        function applyQuestionStatuses(statuses) {
            customers.forEach(customer => {
                if (customer.orderCode && statuses[customer.orderCode]) {
                    customer._questionSubmitted = true;
                    const rawStatus = statuses[customer.orderCode].answerStatus || '';
                    if (!rawStatus || rawStatus === '대기') {
                        customer._answerStatus = '제출완료';
                    } else {
                        customer._answerStatus = rawStatus;
                    }
                    // ★ 추가질문결과글도 적용
                    if (statuses[customer.orderCode].additionalResultText) {
                        customer.additionalResultText = statuses[customer.orderCode].additionalResultText;
                    }
                } else {
                    customer._questionSubmitted = false;
                    customer._answerStatus = '미제출';
                }
            });
        }

        // ========== 모든 고객 추가질문 상태 로드 (배치 API) ==========
        async function loadAllQuestionStatuses() {
            try {
                const response = await fetch(`${SAJU_CONFIG.googleSheets.webAppUrl}?action=getAllQuestionStatuses`);
                const result = await response.json();
                
                if (result.success) {
                    const statuses = result.statuses || {};
                    localStorage.setItem('saju_question_statuses', JSON.stringify(statuses));
                    applyQuestionStatuses(statuses);
                }
            } catch (error) {
                console.log('추가질문 상태 로드 실패:', error);
                customers.forEach(customer => {
                    customer._questionSubmitted = false;
                    customer._answerStatus = '미제출';
                });
            }
        }

        // ========== 현재 필터 상태 ==========
        let currentFilter = 'all';
        let currentSearchQuery = '';
        let currentPackageFilter = 'all';

        // ========== 검색 기능 ==========
        function handleSearch(query) {
            currentSearchQuery = query.trim().toLowerCase();

            // X 버튼 표시/숨김
            const clearBtn = document.getElementById('searchClearBtn');
            if (currentSearchQuery) {
                clearBtn.classList.add('show');
            } else {
                clearBtn.classList.remove('show');
            }

            renderCustomerList();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearchQuery = '';
            document.getElementById('searchClearBtn').classList.remove('show');
            renderCustomerList();
        }

        // ========== 패키지 필터 ==========
        function filterByPackage(pkg) {
            currentPackageFilter = pkg;

            // 버튼 활성화 상태 업데이트
            document.querySelectorAll('.package-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.package === pkg) {
                    btn.classList.add('active');
                }
            });

            renderCustomerList();
        }

        // ========== 필터 적용 ==========
        function filterByStatus(status) {
            currentFilter = status;
            
            // 탭 활성화 상태 업데이트
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.status === status) {
                    tab.classList.add('active');
                }
            });
            
            // 💕 버튼 활성화 상태 업데이트
            const matchingBtn = document.getElementById('matchingFilterBtn');
            if (matchingBtn) {
                if (status === 'matching') {
                    matchingBtn.classList.add('active');
                } else {
                    matchingBtn.classList.remove('active');
                }
            }
            
            renderCustomerList();
        }

        // ========== 상태별 카운트 업데이트 ==========
        function updateStatusCounts() {
            const counts = {
                'all': customers.length,
                '신규': 0,
                '입금확인': 0,
                '작성중': 0,
                '변환요청': 0,
                '전달완료': 0,
                '대기': 0,
                '추가변환요청': 0,
                '전달최종완료': 0,
                'matching': 0
            };
            
            customers.forEach(c => {
                const status = c.status || '신규';
                const answerStatus = c._answerStatus || '미제출';
                
                // 기본 상태 카운트 (신규, 입금확인, 작성중, 변환요청)
                if (status === '신규' || status === '입금확인' || status === '작성중' || status === '변환요청') {
                    counts[status]++;
                }
                // 전달완료: status=완료 AND answerStatus=미제출 (기본 결과지 전달, 추가질문 안함)
                if (status === '완료' && answerStatus === '미제출') {
                    counts['전달완료']++;
                }
                // 대기(추가질문): answerStatus=제출완료 (추가질문 제출한 사람)
                if (answerStatus === '제출완료') {
                    counts['대기']++;
                }
                // 추가변환요청: answerStatus=추가변환요청
                if (answerStatus === '추가변환요청') {
                    counts['추가변환요청']++;
                }
                // 전달최종완료: answerStatus=전달완료
                if (answerStatus === '전달완료') {
                    counts['전달최종완료']++;
                }
                // 매칭 신청자
                if (c.matchingInterest === 'Y') {
                    counts['matching']++;
                }
            });
            
            document.getElementById('countAll').textContent = counts['all'];
            document.getElementById('count신규').textContent = counts['신규'];
            document.getElementById('count입금확인').textContent = counts['입금확인'];
            document.getElementById('count작성중').textContent = counts['작성중'];
            document.getElementById('count변환요청').textContent = counts['변환요청'];
            document.getElementById('count전달완료').textContent = counts['전달완료'];
            document.getElementById('count대기').textContent = counts['대기'];
            document.getElementById('count추가변환요청').textContent = counts['추가변환요청'];
            document.getElementById('count전달최종완료').textContent = counts['전달최종완료'];
            document.getElementById('countMatching').textContent = counts['matching'];
        }

        // ========== 고객 목록 렌더링 ==========
        function renderCustomerList() {
            const list = document.getElementById('customerList');

            // 상태별 카운트 업데이트
            updateStatusCounts();

            // 1단계: 상태 필터 적용
            let filteredCustomers;
            if (currentFilter === 'all') {
                filteredCustomers = customers;
            } else if (currentFilter === '전달완료') {
                // 전달완료: 기본 결과지 전달, 추가질문 안함
                filteredCustomers = customers.filter(c => (c.status || '신규') === '완료' && (c._answerStatus || '미제출') === '미제출');
            } else if (currentFilter === '대기') {
                // 대기(추가질문): 추가질문 제출한 사람
                filteredCustomers = customers.filter(c => c._answerStatus === '제출완료');
            } else if (currentFilter === '추가변환요청') {
                filteredCustomers = customers.filter(c => c._answerStatus === '추가변환요청');
            } else if (currentFilter === '전달최종완료') {
                // 전달최종완료: 추가질문 답변까지 다 보낸 사람
                filteredCustomers = customers.filter(c => c._answerStatus === '전달완료');
            } else if (currentFilter === 'matching') {
                filteredCustomers = customers.filter(c => c.matchingInterest === 'Y');
            } else {
                filteredCustomers = customers.filter(c => (c.status || '신규') === currentFilter);
            }

            // 2단계: 패키지 필터 적용
            if (currentPackageFilter !== 'all') {
                filteredCustomers = filteredCustomers.filter(c => c.package === currentPackageFilter);
            }

            // 3단계: 검색어 필터 적용
            if (currentSearchQuery) {
                filteredCustomers = filteredCustomers.filter(c => {
                    const name = (c.name || '').toLowerCase();
                    const memo = (c.memo || '').toLowerCase();
                    const orderCode = (c.orderCode || '').toLowerCase();
                    const phone = (c.phone || '').toLowerCase();

                    return name.includes(currentSearchQuery) ||
                           memo.includes(currentSearchQuery) ||
                           orderCode.includes(currentSearchQuery) ||
                           phone.includes(currentSearchQuery);
                });
            }

            document.getElementById('customerCount').textContent = `${filteredCustomers.length}건`;

            // 빈 상태 메시지
            if (filteredCustomers.length === 0) {
                let emptyMessage = '신청 내역이 없습니다';
                if (currentSearchQuery) {
                    emptyMessage = `'${currentSearchQuery}' 검색 결과가 없습니다`;
                } else if (currentFilter !== 'all') {
                    emptyMessage = `'${currentFilter}' 상태인 고객이 없습니다`;
                } else if (currentPackageFilter !== 'all') {
                    emptyMessage = `선택한 패키지의 고객이 없습니다`;
                }

                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📭</div>
                        <p>${emptyMessage}</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = filteredCustomers.map((c) => {
                // 원본 customers 배열에서의 인덱스 찾기
                const originalIndex = customers.indexOf(c);
                const pkg = SAJU_CONFIG.packages[c.package] || SAJU_CONFIG.packages.light;
                const statusClass = c.status === '신규' ? 'new' : c.status === '입금확인' ? 'paid' : 'done';

                // 검색어 하이라이트
                let displayName = c.name || '';
                if (currentSearchQuery && displayName.toLowerCase().includes(currentSearchQuery)) {
                    const regex = new RegExp(`(${currentSearchQuery})`, 'gi');
                    displayName = displayName.replace(regex, '<mark style="background:#ffe082; padding:0 2px; border-radius:2px;">$1</mark>');
                }

                return `
                    <div class="customer-item ${selectedCustomer === originalIndex ? 'selected' : ''}" onclick="selectCustomer(${originalIndex})">
                        <div class="top-row">
                            <span class="name">${displayName}${c.matchingInterest === 'Y' ? ' 💕' : ''}</span>
                            <span class="package ${c.package}">${pkg.emoji} ${pkg.name}</span>
                        </div>
                        <div class="info">${c.birthYear}.${c.birthMonth}.${c.birthDay} · ${c.gender === 'male' ? '남자' : c.gender === 'female' ? '여자' : c.gender}</div>
                        <span class="status ${statusClass}">${c.status || '신규'}</span>
                    </div>
                `;
            }).join('');
        }

        // ========== 고객 선택 ==========
        async function selectCustomer(index) {
            selectedCustomer = index;
            renderCustomerList();

            const customer = customers[index];

            // ★ 지연 로딩: 완료된 고객이고 상세 데이터가 없으면 로드
            if (customer._needsDetailLoad && customer.orderCode) {
                // 로딩 표시
                const contentEl = document.getElementById('customerDetail');
                contentEl.innerHTML = `
                    <div style="display:flex; align-items:center; justify-content:center; height:200px; color:var(--text-light);">
                        <div style="text-align:center;">
                            <div style="font-size:32px; margin-bottom:10px;">⏳</div>
                            <div>상세 데이터 로딩 중...</div>
                        </div>
                    </div>
                `;
                contentEl.classList.add('show');
                document.getElementById('contentEmpty').style.display = 'none';

                // Supabase에서 상세 데이터 로드
                const detailData = await supabaseLoadCustomerDetail(customer.orderCode);
                if (detailData) {
                    // 고객 데이터 업데이트
                    const fullCustomer = convertFromSupabaseFormat(detailData);
                    customers[index] = { ...customers[index], ...fullCustomer, _needsDetailLoad: false };
                    console.log('✅ 상세 데이터 로드 완료:', customer.name);
                }
            }

            showCustomerDetail(customers[index]);

            // 모바일: 목록 숨기고 상세 표시
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.add('mobile-hidden');
                document.querySelector('.content').classList.add('mobile-show');
            }
        }

        // ========== 사주팔자 접기/펼치기 ==========
        function toggleSajuDisplay() {
            const sajuDisplay = document.getElementById('sajuDisplay');
            const toggleIcon = document.getElementById('sajuToggleIcon');
            
            if (sajuDisplay.style.display === 'none') {
                sajuDisplay.style.display = 'flex';
                toggleIcon.textContent = '▼';
            } else {
                sajuDisplay.style.display = 'none';
                toggleIcon.textContent = '▶';
            }
        }

        // ========== 모바일: 목록으로 돌아가기 ==========
        function backToList() {
            document.querySelector('.sidebar').classList.remove('mobile-hidden');
            document.querySelector('.content').classList.remove('mobile-show');
            // 헤더 뒤로가기 버튼 숨기기
            document.getElementById('headerBackBtn').style.display = 'none';
        }

        // ========== 고객 상세 표시 ==========
        function showCustomerDetail(customer) {
            document.getElementById('contentEmpty').style.display = 'none';
            document.getElementById('customerDetail').classList.add('show');
            // 헤더 뒤로가기 버튼 보이기
            document.getElementById('headerBackBtn').style.display = 'inline-flex';

            // ★ sajuResult가 있으면 파싱해서 표시, 없으면 숨기기
            if (customer.sajuResult && customer.sajuResult.trim()) {
                const parsedSaju = parseSajuResult(customer.sajuResult);
                renderSajuDisplay(parsedSaju);
                renderOhengBars(parsedSaju.oheng);
                document.getElementById('sajuDisplay').style.display = 'flex';
                document.getElementById('ohengCard').style.display = 'block';
            } else {
                document.getElementById('sajuDisplay').innerHTML = '<div style="color:#999; font-size:12px; text-align:center; width:100%;">사주계산 결과가 없습니다</div>';
                document.getElementById('sajuDisplay').style.display = 'flex';
                document.getElementById('ohengCard').style.display = 'none';
            }

            // 기본 정보
            const pkg = SAJU_CONFIG.packages[customer.package] || SAJU_CONFIG.packages.light;
            document.getElementById('detailName').textContent = customer.name;
            document.getElementById('detailBirth').textContent = 
                `${customer.birthYear}년 ${customer.birthMonth}월 ${customer.birthDay}일 ${customer.birthHour ? customer.birthHour + '시' : ''} (${customer.isLunar === 'Y' || customer.isLunar === 'true' ? '음력' : '양력'}, ${customer.gender === 'male' ? '남자' : customer.gender === 'female' ? '여자' : customer.gender})`;
            document.getElementById('detailPackage').textContent = `${pkg.emoji} ${pkg.name}`;

            // ★ 주문코드 표시
            const orderCodeRow = document.getElementById('orderCodeRow');
            const orderCodeEl = document.getElementById('detailOrderCode');
            if (customer.orderCode) {
                orderCodeEl.textContent = customer.orderCode;
                orderCodeRow.style.display = 'flex';
            } else {
                orderCodeRow.style.display = 'none';
            }

            // ★ 현재 상태 표시 (연애/직업)
            document.getElementById('detailLoveStatus').textContent = customer.loveStatus || '선택 안 함';
            document.getElementById('detailJobStatus').textContent = customer.jobStatus || '선택 안 함';

            // ★ 매칭 상태 표시
            const matchingEl = document.getElementById('detailMatchingStatus');
            if (customer.matchingInterest === 'Y') {
                let ageText = '';
                if (customer.matchingAgeUpper === '상관없음' || customer.matchingAgeLower === '상관없음') {
                    ageText = '나이 무관';
                } else {
                    ageText = `연상${customer.matchingAgeUpper || '?'}/연하${customer.matchingAgeLower || '?'}`;
                }
                matchingEl.textContent = `신청 (${ageText})`;
                matchingEl.className = 'status-info-value submitted';
            } else {
                matchingEl.textContent = '미신청';
                matchingEl.className = 'status-info-value not-submitted';
            }

            // ★ 추가질문 상태 표시
            // 포함 항목
            renderIncludes(customer);

            // 질문지
            renderQuestions(customer);

            // 상태
            document.getElementById('statusSelect').value = customer.status || '신규';
            
            // ★ 상태에 따른 카드 표시 (checkQuestionStatus 전에 호출해야 함!)
            updateCardVisibility(customer);
            
            // ★ 추가질문 상태 확인 (updateCardVisibility 후에 호출!)
            checkQuestionStatus(customer.orderCode);
            
            // ★ 계산기용 데이터 생성
            generateCalculatorData(customer);
            
            // ★ 결과 링크 표시
            updateResultLink(customer);
            
            // ★ 사주계산 결과 표시
            updateSajuResultCard(customer);
            
            // ★ 프롬프트 결과 표시
            updatePromptResultCard(customer);
            
            // ★ 진행 현황 업데이트
            updateProgressCard(customer);
            
            // ★ 메모 표시
            updateMemoCard(customer);
            
            // ★ 권한 적용 (옵션 숨기기 등)
            applyPermissions();
        }
        
        // ========== 상태에 따른 카드 표시 ==========
        function updateCardVisibility(customer) {
            const status = customer.status || '신규';
            
            // ★ 프리미엄 전용 인연상 카드 표시/숨김
            const isPremium = customer.package === 'premium';
            const inyeonCalcCard = document.getElementById('inyeonCalcCard');
            const inyeonImageCard = document.getElementById('inyeonImageCard');
            
            if (isPremium && ['입금확인', '작성중', '변환요청', '완료'].includes(status)) {
                inyeonCalcCard.style.display = 'block';
                inyeonImageCard.style.display = 'block';
                
                // 인연상 계산 결과가 있으면 표시
                if (customer.inyeonCalcResult && customer.inyeonCalcResult.trim()) {
                    document.getElementById('inyeonCalcEmpty').style.display = 'none';
                    document.getElementById('inyeonCalcContent').style.display = 'block';
                    document.getElementById('inyeonCalcResultText').value = customer.inyeonCalcResult;
                } else {
                    document.getElementById('inyeonCalcEmpty').style.display = 'block';
                    document.getElementById('inyeonCalcContent').style.display = 'none';
                }
                
                // 인연상 이미지 HTML이 있으면 표시
                if (customer.inyeonHTML && customer.inyeonHTML.trim()) {
                    document.getElementById('inyeonImageEmpty').style.display = 'none';
                    document.getElementById('inyeonImageContent').style.display = 'block';
                    document.getElementById('inyeonHTMLText').value = customer.inyeonHTML;
                } else {
                    document.getElementById('inyeonImageEmpty').style.display = 'block';
                    document.getElementById('inyeonImageContent').style.display = 'none';
                }
            } else {
                inyeonCalcCard.style.display = 'none';
                inyeonImageCard.style.display = 'none';
            }
            
            // 기본 결과지 섹션 카드들
            const mainDivider = document.getElementById('mainSectionDivider');
            const copyCard = document.getElementById('copyDataCard');
            const mainResultCard = document.getElementById('mainResultCard');
            const mainFileCard = document.getElementById('mainResultFileCard');
            
            // 추가질문 섹션 카드들
            const additionalDivider = document.getElementById('additionalSectionDivider');
            const additionalResultCard = document.getElementById('additionalResultCard');
            const additionalFileCard = document.getElementById('additionalResultFileCard');
            
            // 완료 링크 카드
            const completedLinksCard = document.getElementById('completedLinksCard');
            
            // 입금확인 이상이면 기본 결과지 섹션 표시
            if (['입금확인', '작성중', '변환요청', '완료'].includes(status)) {
                mainDivider.style.display = 'block';
                copyCard.style.display = 'block';
                mainResultCard.style.display = 'block';
                mainFileCard.style.display = 'block';
            } else {
                mainDivider.style.display = 'none';
                copyCard.style.display = 'none';
                mainResultCard.style.display = 'none';
                mainFileCard.style.display = 'none';
            }
            
            // Step 4 결과글 뱃지 업데이트
            const mainResultBadge = document.getElementById('mainResultCardBadge');
            if (customer.mainResultText && customer.mainResultText.trim()) {
                mainResultBadge.textContent = '저장됨';
                mainResultBadge.style.background = '#4a7c59';
            } else {
                mainResultBadge.textContent = '미저장';
                mainResultBadge.style.background = '#999';
            }
            
            // Step 5 결과파일 뱃지 업데이트
            const mainFileBadge = document.getElementById('mainResultFileStatus');
            if (customer.resultUrl && customer.resultUrl.trim()) {
                mainFileBadge.textContent = '등록됨';
                mainFileBadge.style.background = '#4a7c59';
                document.getElementById('mainResultLink').style.display = 'block';
                document.getElementById('mainResultLink').href = customer.resultUrl;
            } else {
                mainFileBadge.textContent = '미등록';
                mainFileBadge.style.background = '#999';
                document.getElementById('mainResultLink').style.display = 'none';
            }
            
            // 추가질문 섹션은 checkQuestionStatus()에서 별도 처리
            // 기본값: 숨김
            additionalDivider.style.display = 'none';
            additionalResultCard.style.display = 'none';
            additionalFileCard.style.display = 'none';
            
            // Step 7 답변글 뱃지 업데이트
            const additionalResultBadge = document.getElementById('additionalResultCardBadge');
            if (customer.additionalResultText && customer.additionalResultText.trim()) {
                additionalResultBadge.textContent = '저장됨';
                additionalResultBadge.style.background = '#4a7c59';
            } else {
                additionalResultBadge.textContent = '미저장';
                additionalResultBadge.style.background = '#999';
            }
            
            // Step 8 답변파일 뱃지 업데이트
            const additionalFileBadge = document.getElementById('additionalResultFileStatus');
            if (customer.additionalResultUrl && customer.additionalResultUrl.trim()) {
                additionalFileBadge.textContent = '등록됨';
                additionalFileBadge.style.background = '#4a7c59';
                document.getElementById('additionalResultLink').style.display = 'block';
                document.getElementById('additionalResultLink').href = customer.additionalResultUrl;
            } else {
                additionalFileBadge.textContent = '미등록';
                additionalFileBadge.style.background = '#999';
                document.getElementById('additionalResultLink').style.display = 'none';
            }
            
            // 완료 링크 카드 (결과파일이 하나라도 있으면 표시)
            const hasMainUrl = customer.resultUrl && customer.resultUrl.trim();
            const hasAdditionalUrl = customer.additionalResultUrl && customer.additionalResultUrl.trim();
            
            if (hasMainUrl || hasAdditionalUrl) {
                completedLinksCard.style.display = 'block';
                
                const completedMain = document.getElementById('completedMainLink');
                const completedMainUrl = document.getElementById('completedMainLinkUrl');
                if (hasMainUrl) {
                    completedMain.style.display = 'block';
                    completedMainUrl.href = customer.resultUrl;
                } else {
                    completedMain.style.display = 'none';
                }
                
                const completedAdditional = document.getElementById('completedAdditionalLink');
                const completedAdditionalUrl = document.getElementById('completedAdditionalLinkUrl');
                if (hasAdditionalUrl) {
                    completedAdditional.style.display = 'block';
                    completedAdditionalUrl.href = customer.additionalResultUrl;
                } else {
                    completedAdditional.style.display = 'none';
                }
            } else {
                completedLinksCard.style.display = 'none';
            }
        }
        
        // ========== 주문코드 복사 ==========
        function copyOrderCode() {
            const code = document.getElementById('detailOrderCode').textContent;
            if (!code || code === '-') {
                alert('주문코드가 없습니다.');
                return;
            }
            
            navigator.clipboard.writeText(code).then(() => {
                alert('주문코드가 복사되었습니다!\n' + code);
            }).catch(() => {
                // 폴백
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('주문코드가 복사되었습니다!\n' + code);
            });
        }
        
        // ========== 계산기용 데이터 생성 ==========
        function generateCalculatorData(customer) {
            const pkg = SAJU_CONFIG.packages[customer.package] || SAJU_CONFIG.packages.light;
            const calendarType = (customer.isLunar === 'Y' || customer.isLunar === 'true') ? '음력' : '양력';
            const gender = customer.gender === 'male' ? '남자' : customer.gender === 'female' ? '여자' : customer.gender;
            
            // 시간 포맷
            let timeStr = '모름';
            if (customer.birthHour) {
                timeStr = customer.birthHour + '시';
                if (customer.birthMinute) {
                    timeStr += ' ' + customer.birthMinute + '분';
                }
            }
            
            // ★ 사주계산기 형식에 맞춤
            const data = `[사주 제작 정보]
━━━━━━━━━━━━━━━━━━━━
주문코드: ${customer.orderCode || '-'}
이름: ${customer.name}
생년월일: ${customer.birthYear}년 ${customer.birthMonth}월 ${customer.birthDay}일
시간: ${timeStr}
음/양력: ${calendarType}
성별: ${gender}
인연성별: ${customer.partnerGender || '-'}
━━━━━━━━━━━━━━━━━━━━
연애 상태: ${customer.loveStatus || '선택 안 함'}
직업 상태: ${customer.jobStatus || '선택 안 함'}
━━━━━━━━━━━━━━━━━━━━
패키지: ${pkg.name}
선택 운세: ${customer.fortuneType || '-'}
선택 질문: ${customer.questions || '-'}
━━━━━━━━━━━━━━━━━━━━
[질문지 응답]
가장 큰 고민: ${customer.mainConcern || '-'}
반복되는 패턴: ${customer.repeatPattern || '-'}
맞춤 질문: ${customer.customQuestion || '-'}`;
            
            document.getElementById('calculatorData').value = data;
        }
        
        // ========== 계산기 데이터 복사 ==========
        function copyCalculatorData() {
            const textarea = document.getElementById('calculatorData');
            textarea.select();
            document.execCommand('copy');
            alert('📋 사주계산기용 데이터가 복사되었습니다!\n\n사주계산기에 붙여넣기 하세요.');
        }
        
        // ========== 결과 링크 업데이트 ==========
        function updateResultLink(customer) {
            // 기본 결과지
            const mainStatus = document.getElementById('mainResultFileStatus');
            const mainLink = document.getElementById('mainResultLink');
            const mainInput = document.getElementById('mainResultUrlInput');
            
            if (customer.resultUrl) {
                mainStatus.textContent = '등록됨';
                mainStatus.style.background = '#4a7c59';
                mainLink.href = customer.resultUrl;
                mainLink.style.display = 'block';
                mainInput.value = customer.resultUrl;
            } else {
                mainStatus.textContent = '미등록';
                mainStatus.style.background = '#999';
                mainLink.style.display = 'none';
                mainInput.value = '';
            }
            
            // 추가질문 결과지 (비동기로 가져오기)
            loadAdditionalResultUrl(customer.orderCode);
        }
        
        // 추가질문 결과지 URL 로드
        async function loadAdditionalResultUrl(orderCode) {
            const additionalStatus = document.getElementById('additionalResultFileStatus');
            const additionalLink = document.getElementById('additionalResultLink');
            const additionalInput = document.getElementById('additionalResultUrlInput');
            
            if (!orderCode) {
                additionalStatus.textContent = '미등록';
                additionalStatus.style.background = '#999';
                additionalLink.style.display = 'none';
                additionalInput.value = '';
                return;
            }
            
            try {
                const response = await fetch(`${SAJU_CONFIG.googleSheets.webAppUrl}?action=getAdditionalResultUrl&orderCode=${encodeURIComponent(orderCode)}`);
                const result = await response.json();
                
                if (result.success && result.resultUrl) {
                    additionalStatus.textContent = '등록됨';
                    additionalStatus.style.background = '#4a7c59';
                    additionalLink.href = result.resultUrl;
                    additionalLink.style.display = 'block';
                    additionalInput.value = result.resultUrl;
                    
                    // 로컬 데이터에도 저장
                    if (selectedCustomer !== null) {
                        customers[selectedCustomer].additionalResultUrl = result.resultUrl;
                    }
                } else {
                    additionalStatus.textContent = '미등록';
                    additionalStatus.style.background = '#999';
                    additionalLink.style.display = 'none';
                    additionalInput.value = '';
                }
            } catch (error) {
                additionalStatus.textContent = '미등록';
                additionalStatus.style.background = '#999';
                additionalLink.style.display = 'none';
                additionalInput.value = '';
            }
        }
        
        // ========== 사주계산 결과 카드 업데이트 ==========
        function updateSajuResultCard(customer) {
            const card = document.getElementById('sajuResultCard');
            const emptyEl = document.getElementById('sajuResultEmpty');
            const contentEl = document.getElementById('sajuResultContent');
            const textEl = document.getElementById('sajuResultText');
            const badge = document.getElementById('sajuResultBadge');
            
            if (customer.sajuResult && customer.sajuResult.trim()) {
                card.style.display = 'block';
                emptyEl.style.display = 'none';
                contentEl.style.display = 'block';
                textEl.value = customer.sajuResult;
                badge.textContent = '저장됨';
                badge.style.background = '#4a7c59';
            } else {
                card.style.display = 'block';
                emptyEl.style.display = 'block';
                contentEl.style.display = 'none';
                badge.textContent = '없음';
                badge.style.background = '#999';
            }
        }
        
        // ========== 사주계산 결과 복사 ==========
        function copySajuResult() {
            const textEl = document.getElementById('sajuResultText');
            textEl.select();
            document.execCommand('copy');
            alert('📋 사주계산 결과가 복사되었습니다!');
        }
        
        // ========== 사주계산 결과 붙여넣기 ==========
        async function pasteSajuResult() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            try {
                const text = await navigator.clipboard.readText();
                if (!text || !text.trim()) {
                    alert('클립보드가 비어있습니다.');
                    return;
                }
                
                // textarea에 표시
                document.getElementById('sajuResultText').value = text;
                document.getElementById('sajuResultEmpty').style.display = 'none';
                document.getElementById('sajuResultContent').style.display = 'block';
                document.getElementById('sajuResultBadge').textContent = '저장중...';
                
                // 로컬 데이터 업데이트
                customer.sajuResult = text;
                localStorage.setItem('saju_customers', JSON.stringify(customers));
                
                // Google Sheets에 저장
                const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=update&rowIndex=${customer._rowIndex}&field=sajuResult&value=${encodeURIComponent(text)}`;
                fetch(url).then(() => {
                    document.getElementById('sajuResultBadge').textContent = '저장됨';
                    document.getElementById('sajuResultBadge').style.background = '#4a7c59';
                }).catch(() => {
                    document.getElementById('sajuResultBadge').textContent = '저장실패';
                    document.getElementById('sajuResultBadge').style.background = '#c00';
                });

                // Supabase에도 저장
                if (customer.orderCode) {
                    supabaseUpdateCustomer(customer.orderCode, { sajuResult: text }).then(result => {
                        if (result) console.log('⚡ Supabase sajuResult 저장 완료');
                    }).catch(error => {
                        console.log('Supabase 저장 실패:', error);
                    });
                }

                alert('📥 사주계산 결과가 붙여넣기 되었습니다!');
                
            } catch (error) {
                console.error(error);
                alert('붙여넣기 실패: 클립보드 접근 권한을 확인해주세요.');
            }
        }
        
        // ========== 인연상 계산기용 입력 복사 ==========
        function copyInyeonCalcInput() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            // 사주계산 결과에서 일주 정보 추출
            const sajuResult = customer.sajuResult || '';
            if (!sajuResult.trim()) {
                alert('⚠️ 사주계산 결과가 없습니다.\n먼저 Step 2에서 사주를 계산해주세요.');
                return;
            }
            
            // parseSajuResult로 일주 추출
            const parsedSaju = parseSajuResult(sajuResult);
            const dayGan = parsedSaju.day?.gan || '?';
            const dayJi = parsedSaju.day?.ji || '?';
            const ilju = dayGan + dayJi;
            
            // 성별 변환
            let genderText = '여';
            if (customer.gender === 'male') genderText = '남';
            else if (customer.gender === 'female') genderText = '여';
            else genderText = customer.gender || '여';
            
            // 인연상 계산기용 입력 형식
            const inputData = `일주: ${ilju}
본인 성별: ${genderText}
찾는 상대: ${genderText === '남' ? '여' : '남'}`;
            
            navigator.clipboard.writeText(inputData).then(() => {
                alert(`📋 인연상 계산기용 입력이 복사되었습니다!\n\n${inputData}\n\n인연상 계산기에서 입력하세요.`);
            }).catch(() => {
                alert('복사 실패');
            });
        }
        
        // ========== 인연상 계산 결과 붙여넣기 ==========
        async function pasteInyeonCalcResult() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            try {
                const text = await navigator.clipboard.readText();
                if (!text || !text.trim()) {
                    alert('클립보드가 비어있습니다.');
                    return;
                }
                
                // textarea에 표시
                document.getElementById('inyeonCalcResultText').value = text;
                document.getElementById('inyeonCalcEmpty').style.display = 'none';
                document.getElementById('inyeonCalcContent').style.display = 'block';
                
                // 로컬 데이터 업데이트
                customer.inyeonCalcResult = text;
                localStorage.setItem('saju_customers', JSON.stringify(customers));

                // Supabase에도 저장
                if (customer.orderCode) {
                    supabaseUpdateCustomer(customer.orderCode, { inyeonCalcResult: text }).then(result => {
                        if (result) console.log('⚡ Supabase inyeonCalcResult 저장 완료');
                    }).catch(error => {
                        console.log('Supabase 저장 실패:', error);
                    });
                }

                alert('📥 인연상 계산 결과가 붙여넣기 되었습니다!');
                
            } catch (error) {
                console.error(error);
                alert('붙여넣기 실패: 클립보드 접근 권한을 확인해주세요.');
            }
        }
        
        // ========== 인연상 JSON 복사 ==========
        function copyInyeonJSON() {
            const textEl = document.getElementById('inyeonCalcResultText');
            if (!textEl.value || !textEl.value.trim()) {
                alert('먼저 인연상 계산 결과를 붙여넣기 해주세요.');
                return;
            }
            textEl.select();
            document.execCommand('copy');
            alert('📋 인연상 JSON이 복사되었습니다!\n\n인연상 생성기에 붙여넣기 하세요.');
        }
        
        // ========== 인연상 HTML 복사 ==========
        function copyInyeonHTML() {
            const textEl = document.getElementById('inyeonHTMLText');
            if (!textEl.value || !textEl.value.trim()) {
                alert('먼저 인연상 이미지를 생성해주세요.');
                return;
            }
            textEl.select();
            document.execCommand('copy');
            alert('📋 인연상 HTML이 복사되었습니다!');
        }
        
        // ========== 인연상 HTML 붙여넣기 ==========
        async function pasteInyeonHTML() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            try {
                const text = await navigator.clipboard.readText();
                if (!text || !text.trim()) {
                    alert('클립보드가 비어있습니다.');
                    return;
                }
                
                // textarea에 표시
                document.getElementById('inyeonHTMLText').value = text;
                document.getElementById('inyeonImageEmpty').style.display = 'none';
                document.getElementById('inyeonImageContent').style.display = 'block';
                
                // 로컬 데이터 업데이트
                customer.inyeonHTML = text;
                localStorage.setItem('saju_customers', JSON.stringify(customers));

                // Supabase에도 저장
                if (customer.orderCode) {
                    supabaseUpdateCustomer(customer.orderCode, { inyeonHTML: text }).then(result => {
                        if (result) console.log('⚡ Supabase inyeonHTML 저장 완료');
                    }).catch(error => {
                        console.log('Supabase 저장 실패:', error);
                    });
                }

                alert('📥 인연상 HTML이 붙여넣기 되었습니다!');
                
            } catch (error) {
                console.error(error);
                alert('붙여넣기 실패: 클립보드 접근 권한을 확인해주세요.');
            }
        }
        
        // ========== 프롬프트 결과 카드 업데이트 ==========
        function updatePromptResultCard(customer) {
            const card = document.getElementById('promptResultCard');
            const emptyEl = document.getElementById('promptResultEmpty');
            const contentEl = document.getElementById('promptResultContent');
            const textEl = document.getElementById('promptResultText');
            const fullEl = document.getElementById('promptResultFull');
            const badge = document.getElementById('promptResultBadge');
            
            if (customer.promptResult && customer.promptResult.trim()) {
                card.style.display = 'block';
                emptyEl.style.display = 'none';
                contentEl.style.display = 'block';
                textEl.value = customer.promptResult;
                if (fullEl) fullEl.value = customer.promptResult;
                badge.textContent = '저장됨';
                badge.style.background = '#4a7c59';
            } else {
                card.style.display = 'block';
                emptyEl.style.display = 'block';
                contentEl.style.display = 'none';
                badge.textContent = '없음';
                badge.style.background = '#999';
            }
        }
        
        // ========== 프롬프트 전체 복사 (V6: 통합) ==========
        function copyPromptFull() {
            const text = document.getElementById('promptResultFull').value;
            if (!text) {
                alert('프롬프트가 비어있습니다.');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                alert('📋 프롬프트 복사 완료!\n\nClaude에 한 번에 붙여넣기 하세요! 🚀');
            }).catch(() => {
                // 모바일 fallback
                const textarea = document.getElementById('promptResultFull');
                textarea.select();
                document.execCommand('copy');
                alert('📋 프롬프트 복사 완료!\n\nClaude에 한 번에 붙여넣기 하세요! 🚀');
            });
        }
        
        // ========== 프롬프트 결과 복사 ==========
        function copyPromptResult() {
            const textEl = document.getElementById('promptResultText');
            textEl.select();
            document.execCommand('copy');
            alert('📋 프롬프트 결과가 복사되었습니다!');
        }
        
        // ========== 프롬프트 결과 붙여넣기 ==========
        async function pastePromptResult() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            try {
                const text = await navigator.clipboard.readText();
                if (!text || !text.trim()) {
                    alert('클립보드가 비어있습니다.');
                    return;
                }
                
                // textarea에 표시
                document.getElementById('promptResultText').value = text;
                document.getElementById('promptResultEmpty').style.display = 'none';
                document.getElementById('promptResultContent').style.display = 'block';
                document.getElementById('promptResultBadge').textContent = '저장중...';
                
                // 로컬 데이터 업데이트
                customer.promptResult = text;
                localStorage.setItem('saju_customers', JSON.stringify(customers));
                
                // Google Sheets에 저장
                const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=update&rowIndex=${customer._rowIndex}&field=promptResult&value=${encodeURIComponent(text)}`;
                fetch(url).then(() => {
                    document.getElementById('promptResultBadge').textContent = '저장됨';
                    document.getElementById('promptResultBadge').style.background = '#4a7c59';
                }).catch(() => {
                    document.getElementById('promptResultBadge').textContent = '저장실패';
                    document.getElementById('promptResultBadge').style.background = '#c00';
                });

                // Supabase에도 저장
                if (customer.orderCode) {
                    supabaseUpdateCustomer(customer.orderCode, { promptResult: text }).then(result => {
                        if (result) console.log('⚡ Supabase promptResult 저장 완료');
                    }).catch(error => {
                        console.log('Supabase 저장 실패:', error);
                    });
                }

                alert('📥 프롬프트 결과가 붙여넣기 되었습니다!');
                
            } catch (error) {
                console.error(error);
                alert('붙여넣기 실패: 클립보드 접근 권한을 확인해주세요.');
            }
        }
        
        // ========== 진행 현황 카드 업데이트 ==========
        function updateProgressCard(customer) {
            const progressCard = document.getElementById('progressCard');
            const status = customer.status || '신규';
            
            // 입금확인 이상일 때만 표시
            if (['입금확인', '작성중', '변환요청', '완료'].includes(status)) {
                progressCard.style.display = 'block';
            } else {
                progressCard.style.display = 'none';
                return;
            }
            
            // 각 Step 실제 완료 여부 체크
            const actualSteps = {
                1: true, // 기본정보는 항상 있음
                2: !!(customer.sajuResult && customer.sajuResult.trim()),
                3: !!(customer.promptResult && customer.promptResult.trim()),
                4: !!(customer.mainResultText && customer.mainResultText.trim()),
                5: !!(customer.resultUrl && customer.resultUrl.trim()),
                6: false, // 추가질문 여부는 별도 체크
                7: !!(customer.additionalResultText && customer.additionalResultText.trim()),
                8: !!(customer.additionalResultUrl && customer.additionalResultUrl.trim())
            };
            
            // 추가질문 여부 체크
            const questionBadge = document.getElementById('questionCountBadge');
            const hasAdditionalQuestions = questionBadge && parseInt(questionBadge.textContent) > 0;
            actualSteps[6] = hasAdditionalQuestions;
            
            // ★ 핵심 로직: 뒤에 것이 완료되면 앞에 것도 완료로 표시
            // 전체 1~8 통합: Step 6이 완료면 1~5도 완료, Step 8이 완료면 1~7도 완료
            const steps = {...actualSteps};
            
            // 전체: 뒤에서부터 체크해서 완료면 앞도 완료
            let maxCompleted = 0;
            for (let i = 8; i >= 1; i--) {
                if (actualSteps[i]) {
                    maxCompleted = i;
                    break;
                }
            }
            for (let i = 1; i <= maxCompleted; i++) {
                steps[i] = true;
            }
            
            // 현재 진행 단계 찾기 (첫 번째 미완료 Step)
            let currentStep = 1;
            for (let i = 1; i <= 8; i++) {
                // 추가질문 없으면 6~8 스킵
                if (i >= 6 && !hasAdditionalQuestions) {
                    currentStep = 6;
                    break;
                }
                if (!steps[i]) {
                    currentStep = i;
                    break;
                }
                currentStep = i + 1;
            }
            if (currentStep > 8) currentStep = 8;
            
            // 추가질문 없으면 6~8 스킵
            const skipAdditional = !hasAdditionalQuestions && currentStep >= 6;
            
            // UI 업데이트
            const stepNames = ['', '정보', '계산', '프롬프트', '결과글', '파일', '질문', '답변', '파일'];
            
            for (let i = 1; i <= 8; i++) {
                const stepEl = document.querySelector(`.progress-step[data-step="${i}"]`);
                if (!stepEl) continue;
                
                const iconEl = stepEl.querySelector('.step-icon');
                const labelEl = stepEl.querySelector('div:last-child');
                
                // 추가질문 없으면 6~8 비활성화 스타일
                if (i >= 6 && !hasAdditionalQuestions) {
                    iconEl.style.background = '#f0f0f0';
                    iconEl.style.color = '#ccc';
                    iconEl.textContent = '–';
                    labelEl.style.color = '#ccc';
                    labelEl.style.textDecoration = 'line-through';
                    continue;
                }
                
                labelEl.style.textDecoration = 'none';
                
                if (steps[i]) {
                    // 완료
                    iconEl.style.background = '#4a7c59';
                    iconEl.style.color = '#fff';
                    iconEl.textContent = '✓';
                    labelEl.style.color = '#4a7c59';
                } else if (i === currentStep) {
                    // 진행중
                    iconEl.style.background = '#f5a623';
                    iconEl.style.color = '#fff';
                    iconEl.textContent = i;
                    labelEl.style.color = '#f5a623';
                } else {
                    // 대기
                    iconEl.style.background = '#e0e0e0';
                    iconEl.style.color = '#999';
                    iconEl.textContent = i;
                    labelEl.style.color = '#999';
                }
            }
            
            // 상태 텍스트 업데이트
            const statusEl = document.getElementById('progressStatus');
            if (skipAdditional && currentStep >= 6) {
                statusEl.textContent = '✅ 기본 결과지 완료! (추가질문 없음)';
                statusEl.style.background = '#e8f5e9';
                statusEl.style.color = '#2e7d32';
            } else if (currentStep > 5 && steps[5]) {
                statusEl.textContent = '✅ 기본 결과지 완료! → 추가질문 처리 중';
                statusEl.style.background = '#fff3e0';
                statusEl.style.color = '#e65100';
            } else {
                statusEl.textContent = `현재: Step ${currentStep} - ${stepNames[currentStep]} 작업 중`;
                statusEl.style.background = '#f9f6ef';
                statusEl.style.color = '#666';
            }
        }
        
        // ========== Step 클릭 시 스크롤 이동 ==========
        function scrollToStep(step) {
            const cardIds = {
                1: 'copyDataCard',
                2: 'sajuResultCard',
                3: 'promptResultCard',
                4: 'resultModal', // 모달 열기
                5: 'mainResultFileCard',
                6: 'additionalPromptCard',
                7: 'resultModal', // 모달 열기
                8: 'additionalResultFileCard'
            };
            
            // 4, 7은 모달 열기
            if (step === 4 || step === 7) {
                openResultModal();
                return;
            }
            
            const cardId = cardIds[step];
            const card = document.getElementById(cardId);
            if (card && card.style.display !== 'none') {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // ========== 결과 입력 모달 ==========
        function openResultModal() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            document.getElementById('resultModalName').textContent = customer.name + '님';
            document.getElementById('mainResultTextarea').value = customer.mainResultText || '';
            document.getElementById('additionalResultTextarea').value = customer.additionalResultText || '';
            document.getElementById('mainResultStatus').textContent = customer.mainResultText ? '✅ 저장됨' : '';
            document.getElementById('additionalResultStatus').textContent = customer.additionalResultText ? '✅ 저장됨' : '';
            
            document.getElementById('resultModal').classList.add('show');
        }
        
        function closeResultModal() {
            document.getElementById('resultModal').classList.remove('show');
        }
        
        // 주요결과글 복사
        function copyMainResult() {
            const textarea = document.getElementById('mainResultTextarea');
            if (!textarea.value || !textarea.value.trim()) {
                alert('복사할 내용이 없습니다.');
                return;
            }
            navigator.clipboard.writeText(textarea.value).then(() => {
                alert('📋 주요결과글이 복사되었습니다!');
            }).catch(err => {
                console.error(err);
                alert('복사 실패: 클립보드 접근 권한을 확인해주세요.');
            });
        }
        
        // 추가질문결과글 복사
        function copyAdditionalResult() {
            const textarea = document.getElementById('additionalResultTextarea');
            if (!textarea.value || !textarea.value.trim()) {
                alert('복사할 내용이 없습니다.');
                return;
            }
            navigator.clipboard.writeText(textarea.value).then(() => {
                alert('📋 추가질문결과글이 복사되었습니다!');
            }).catch(err => {
                console.error(err);
                alert('복사 실패: 클립보드 접근 권한을 확인해주세요.');
            });
        }
        
        // 주요결과글 붙여넣기
        async function pasteMainResult() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            try {
                let text = await navigator.clipboard.readText();
                if (!text || !text.trim()) {
                    alert('클립보드가 비어있습니다.');
                    return;
                }
                
                document.getElementById('mainResultTextarea').value = text;
                document.getElementById('mainResultStatus').textContent = '⏳ 저장 중...';

                // Google Sheets에 저장 (결과 대기)
                const saveResult = await saveMainResultText(customer.orderCode, text);

                if (saveResult.success) {
                    // 저장 성공시에만 로컬 데이터 업데이트
                    customer.mainResultText = text;
                    customer.status = '변환요청';
                    localStorage.setItem('saju_customers', JSON.stringify(customers));

                    // Supabase에 status도 저장
                    if (customer.orderCode) {
                        supabaseUpdateCustomer(customer.orderCode, { status: '변환요청' }).then(result => {
                            if (result) console.log('⚡ Supabase status 변환요청 저장 완료');
                        }).catch(error => {
                            console.log('Supabase 저장 실패:', error);
                        });
                    }

                    // UI 업데이트
                    document.getElementById('mainResultStatus').textContent = '✅ 저장 완료! (상태: 변환요청)';
                    document.getElementById('statusSelect').value = '변환요청';
                    renderCustomerList();

                    // ★ 6_결과생성기용 인연상 HTML localStorage 저장
                    if (customer.inyeonHTML) {
                        localStorage.setItem('saju_inyeon_html', customer.inyeonHTML);
                        console.log('✅ 인연상 HTML localStorage 저장 완료 (6_결과생성기용)');
                    }
                } else {
                    // 저장 실패시
                    document.getElementById('mainResultStatus').textContent = '❌ 저장 실패! 다시 시도해주세요.';
                    alert('저장에 실패했습니다. 네트워크 연결을 확인하고 다시 시도해주세요.');
                }

            } catch (error) {
                console.error(error);
                alert('붙여넣기 실패: 클립보드 접근 권한을 확인해주세요.');
            }
        }
        
        // 추가질문결과글 붙여넣기
        async function pasteAdditionalResultText() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];

            try {
                const text = await navigator.clipboard.readText();
                if (!text || !text.trim()) {
                    alert('클립보드가 비어있습니다.');
                    return;
                }

                document.getElementById('additionalResultTextarea').value = text;
                document.getElementById('additionalResultStatus').textContent = '⏳ 저장 중...';

                // Google Sheets에 저장 (결과 대기)
                const saveResult = await saveAdditionalResultText(customer.orderCode, text);

                if (saveResult.success) {
                    // 저장 성공시에만 로컬 데이터 업데이트
                    customer.additionalResultText = text;
                    customer._answerStatus = '추가변환요청';
                    localStorage.setItem('saju_customers', JSON.stringify(customers));

                    // Supabase에 _answerStatus도 저장
                    if (customer.orderCode) {
                        supabaseUpdateCustomer(customer.orderCode, { _answerStatus: '추가변환요청' }).then(result => {
                            if (result) console.log('⚡ Supabase _answerStatus 추가변환요청 저장 완료');
                        }).catch(error => {
                            console.log('Supabase 저장 실패:', error);
                        });
                    }

                    // UI 업데이트
                    document.getElementById('additionalResultStatus').textContent = '✅ 저장 완료! (상태: 추가변환요청)';
                    document.getElementById('answerStatusSelect').value = '추가변환요청';
                    renderCustomerList();
                } else {
                    // 저장 실패시
                    document.getElementById('additionalResultStatus').textContent = '❌ 저장 실패! 다시 시도해주세요.';
                    alert('저장에 실패했습니다. 네트워크 연결을 확인하고 다시 시도해주세요.');
                }

            } catch (error) {
                console.error(error);
                alert('붙여넣기 실패: 클립보드 접근 권한을 확인해주세요.');
            }
        }
        
        // Step 4: 결과글 복사
        function copyMainResultDirect() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            if (!customer.mainResultText || !customer.mainResultText.trim()) {
                alert('복사할 결과글이 없습니다.');
                return;
            }
            
            navigator.clipboard.writeText(customer.mainResultText).then(() => {
                alert('📋 결과글이 복사되었습니다!');
            }).catch(err => {
                console.error(err);
                alert('복사 실패: 클립보드 접근 권한을 확인해주세요.');
            });
        }
        
        // Step 7: 답변글 복사
        function copyAdditionalResultDirect() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            if (!customer.additionalResultText || !customer.additionalResultText.trim()) {
                alert('복사할 답변글이 없습니다.');
                return;
            }
            
            navigator.clipboard.writeText(customer.additionalResultText).then(() => {
                alert('📋 답변글이 복사되었습니다!');
            }).catch(err => {
                console.error(err);
                alert('복사 실패: 클립보드 접근 권한을 확인해주세요.');
            });
        }
        
        // Step 4: 결과글 카드에서 직접 붙여넣기
        async function pasteMainResultDirect() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];

            try {
                const text = await navigator.clipboard.readText();
                if (!text || !text.trim()) {
                    alert('클립보드가 비어있습니다.');
                    return;
                }

                // 뱃지를 저장중으로 변경
                document.getElementById('mainResultCardBadge').textContent = '저장중...';
                document.getElementById('mainResultCardBadge').style.background = '#f9a825';

                // Google Sheets에 저장 (결과 대기)
                const saveResult = await saveMainResultText(customer.orderCode, text);

                if (saveResult.success) {
                    // 저장 성공시에만 로컬 데이터 업데이트
                    customer.mainResultText = text;
                    customer.status = '변환요청';
                    localStorage.setItem('saju_customers', JSON.stringify(customers));

                    // Supabase에 status도 저장
                    if (customer.orderCode) {
                        supabaseUpdateCustomer(customer.orderCode, { status: '변환요청' }).then(result => {
                            if (result) console.log('⚡ Supabase status 변환요청 저장 완료');
                        }).catch(error => {
                            console.log('Supabase 저장 실패:', error);
                        });
                    }

                    // 뱃지 업데이트
                    document.getElementById('mainResultCardBadge').textContent = '저장됨';
                    document.getElementById('mainResultCardBadge').style.background = '#4a7c59';
                    document.getElementById('statusSelect').value = '변환요청';

                    // 진행 현황 업데이트
                    updateProgressCard(customer);
                    renderCustomerList();

                    alert('📥 결과글이 저장되었습니다!');
                } else {
                    // 저장 실패시
                    document.getElementById('mainResultCardBadge').textContent = '저장실패';
                    document.getElementById('mainResultCardBadge').style.background = '#c62828';
                    alert('저장에 실패했습니다. 네트워크 연결을 확인하고 다시 시도해주세요.');
                }

            } catch (error) {
                console.error(error);
                alert('붙여넣기 실패: 클립보드 접근 권한을 확인해주세요.');
            }
        }

        // Step 7: 답변글 카드에서 직접 붙여넣기
        async function pasteAdditionalResultDirect() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];

            try {
                const text = await navigator.clipboard.readText();
                if (!text || !text.trim()) {
                    alert('클립보드가 비어있습니다.');
                    return;
                }

                // 뱃지를 저장중으로 변경
                document.getElementById('additionalResultCardBadge').textContent = '저장중...';
                document.getElementById('additionalResultCardBadge').style.background = '#f9a825';

                // Google Sheets에 저장 (결과 대기)
                const saveResult = await saveAdditionalResultText(customer.orderCode, text);

                if (saveResult.success) {
                    // 저장 성공시에만 로컬 데이터 업데이트
                    customer.additionalResultText = text;
                    customer._answerStatus = '추가변환요청';
                    localStorage.setItem('saju_customers', JSON.stringify(customers));

                    // Supabase에 _answerStatus도 저장
                    if (customer.orderCode) {
                        supabaseUpdateCustomer(customer.orderCode, { _answerStatus: '추가변환요청' }).then(result => {
                            if (result) console.log('⚡ Supabase _answerStatus 추가변환요청 저장 완료');
                        }).catch(error => {
                            console.log('Supabase 저장 실패:', error);
                        });
                    }

                    // 뱃지 업데이트
                    document.getElementById('additionalResultCardBadge').textContent = '저장됨';
                    document.getElementById('additionalResultCardBadge').style.background = '#4a7c59';
                    document.getElementById('answerStatusSelect').value = '추가변환요청';

                    // 진행 현황 업데이트
                    updateProgressCard(customer);
                    renderCustomerList();

                    alert('📥 답변글이 저장되었습니다!');
                } else {
                    // 저장 실패시
                    document.getElementById('additionalResultCardBadge').textContent = '저장실패';
                    document.getElementById('additionalResultCardBadge').style.background = '#c62828';
                    alert('저장에 실패했습니다. 네트워크 연결을 확인하고 다시 시도해주세요.');
                }

            } catch (error) {
                console.error(error);
                alert('붙여넣기 실패: 클립보드 접근 권한을 확인해주세요.');
            }
        }

        // Google Sheets에 주요결과글 저장 (iframe form 방식)
        function saveMainResultText(orderCode, text) {
            return new Promise((resolve) => {
                const webAppUrl = SAJU_CONFIG.googleSheets.webAppUrl;
                
                console.log('📤 주요결과글 저장 요청:', {
                    action: 'saveMainResultText',
                    orderCode: orderCode,
                    textLength: text.length
                });

                // 숨겨진 iframe 생성
                const iframeName = 'saveFrame_' + Date.now();
                const iframe = document.createElement('iframe');
                iframe.name = iframeName;
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                // form 생성
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = webAppUrl;
                form.target = iframeName;

                // hidden inputs
                const inputs = {
                    action: 'saveMainResultText',
                    orderCode: orderCode,
                    mainResultText: text
                };

                for (const [key, value] of Object.entries(inputs)) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                }

                document.body.appendChild(form);
                form.submit();

                // 정리 및 성공 반환
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                    console.log('✅ 주요결과글 저장 요청 완료:', orderCode);

                    // Supabase에도 저장
                    supabaseUpdateCustomer(orderCode, { mainResultText: text }).then(result => {
                        if (result) console.log('⚡ Supabase mainResultText 저장 완료');
                    }).catch(error => {
                        console.log('Supabase 저장 실패:', error);
                    });

                    resolve({ success: true });
                }, 2000);
            });
        }

        // Google Sheets에 추가질문결과글 저장 (iframe form 방식)
        function saveAdditionalResultText(orderCode, text) {
            return new Promise((resolve) => {
                const webAppUrl = SAJU_CONFIG.googleSheets.webAppUrl;

                // 숨겨진 iframe 생성
                const iframeName = 'saveFrame_' + Date.now();
                const iframe = document.createElement('iframe');
                iframe.name = iframeName;
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                // form 생성
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = webAppUrl;
                form.target = iframeName;

                // hidden inputs
                const inputs = {
                    action: 'saveAdditionalResultText',
                    orderCode: orderCode,
                    additionalResultText: text
                };

                for (const [key, value] of Object.entries(inputs)) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                }

                document.body.appendChild(form);
                form.submit();

                // 정리 및 성공 반환
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                    console.log('✅ 추가질문결과글 저장 요청 완료:', orderCode);

                    // Supabase에도 저장
                    supabaseUpdateCustomer(orderCode, { additionalResultText: text }).then(result => {
                        if (result) console.log('⚡ Supabase additionalResultText 저장 완료');
                    }).catch(error => {
                        console.log('Supabase 저장 실패:', error);
                    });

                    resolve({ success: true });
                }, 2000);
            });
        }

        // ========== 결과 링크 직접 저장 ==========
        async function saveResultLink(resultType) {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            if (!customer.orderCode) {
                alert('주문코드가 없습니다.');
                return;
            }
            
            const inputEl = resultType === 'main'
                ? document.getElementById('mainResultUrlInput')
                : document.getElementById('additionalResultUrlInput');
            const statusEl = resultType === 'main'
                ? document.getElementById('mainResultStatus')
                : document.getElementById('additionalResultStatus');
            const linkEl = resultType === 'main'
                ? document.getElementById('mainResultLink')
                : document.getElementById('additionalResultLink');
            
            const url = inputEl.value.trim();
            if (!url) {
                alert('링크를 입력해주세요.');
                return;
            }
            
            // UI 먼저 업데이트
            statusEl.textContent = '등록완료 ✅';
            statusEl.style.color = '#2e7d32';
            linkEl.href = url;
            linkEl.style.display = 'block';
            
            // 로컬 데이터 업데이트 (기본 결과지만)
            if (resultType === 'main') {
                customer.resultUrl = url;
                localStorage.setItem('saju_customers', JSON.stringify(customers));
            }
            
            // 백그라운드로 시트 저장
            try {
                const apiUrl = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=saveResultUrl&orderCode=${encodeURIComponent(customer.orderCode)}&resultType=${resultType}&url=${encodeURIComponent(url)}`;
                await fetch(apiUrl);
            } catch (error) {
                console.log('결과 링크 저장 실패:', error);
            }

            // Supabase에도 저장
            const updateData = resultType === 'main'
                ? { resultUrl: url }
                : { additionalResultUrl: url };
            supabaseUpdateCustomer(customer.orderCode, updateData).then(result => {
                if (result) console.log('⚡ Supabase 결과링크 저장 완료');
            }).catch(error => {
                console.log('Supabase 저장 실패:', error);
            });
        }

        // ========== 결과 파일 업로드 ==========
        async function uploadResultFile(resultType) {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            if (!customer.orderCode) {
                alert('주문코드가 없습니다.');
                return;
            }
            
            const fileInput = resultType === 'main' 
                ? document.getElementById('mainResultFile')
                : document.getElementById('additionalResultFile');
            const statusEl = resultType === 'main'
                ? document.getElementById('mainResultStatus')
                : document.getElementById('additionalResultStatus');
            const linkEl = resultType === 'main'
                ? document.getElementById('mainResultLink')
                : document.getElementById('additionalResultLink');
            
            const file = fileInput.files[0];
            if (!file) return;
            
            try {
                // 1단계: 파일 준비
                statusEl.innerHTML = '<span class="upload-spinner"></span> 파일 준비 중...';
                statusEl.style.color = '#f9a825';
                
                const base64 = await fileToBase64(file);
                
                // 2단계: 서버 전송
                statusEl.innerHTML = '<span class="upload-spinner"></span> 서버 전송 중...';
                
                const response = await fetch(SAJU_CONFIG.googleSheets.webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'uploadResult',
                        orderCode: customer.orderCode,
                        fileName: file.name,
                        fileData: base64,
                        resultType: resultType
                    })
                });
                
                // 3단계: 처리 중
                statusEl.innerHTML = '<span class="upload-spinner"></span> 드라이브 저장 중...';
                
                const result = await response.json();
                
                if (result.success) {
                    // 완료!
                    statusEl.innerHTML = '등록완료 ✅';
                    statusEl.style.color = '#2e7d32';
                    linkEl.href = result.fileUrl;
                    linkEl.style.display = 'block';
                    
                    // 기본 결과지면 로컬 데이터도 업데이트
                    if (resultType === 'main') {
                        customer.resultUrl = result.fileUrl;
                        localStorage.setItem('saju_customers', JSON.stringify(customers));
                    }
                    
                    // 완료 토스트
                    showUploadToast('✅ 파일 업로드 완료!');
                } else {
                    statusEl.innerHTML = '업로드 실패 ❌';
                    statusEl.style.color = '#c00';
                    alert('업로드 실패: ' + result.error);
                }
            } catch (error) {
                statusEl.innerHTML = '업로드 실패 ❌';
                statusEl.style.color = '#c00';
                alert('업로드 실패: ' + error.message);
            }
            
            // 파일 입력 초기화
            fileInput.value = '';
        }
        
        // 업로드 완료 토스트 메시지
        function showUploadToast(message) {
            const toast = document.createElement('div');
            toast.className = 'upload-toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
        
        // 파일을 base64로 변환
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // ========== 고객 정보 수정 모달 ==========
        function openEditModal() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            // 현재 값으로 폼 채우기
            document.getElementById('editName').value = customer.name || '';
            document.getElementById('editPhone').value = customer.phone || '';
            document.getElementById('editGender').value = customer.gender || 'male';
            document.getElementById('editPartnerGender').value = customer.partnerGender || '';
            document.getElementById('editBirthYear').value = customer.birthYear || '';
            document.getElementById('editBirthMonth').value = customer.birthMonth || '';
            document.getElementById('editBirthDay').value = customer.birthDay || '';
            document.getElementById('editBirthHour').value = customer.birthHour || '';
            document.getElementById('editBirthMinute').value = customer.birthMinute || '';
            document.getElementById('editIsLunar').value = customer.isLunar || 'N';
            document.getElementById('editLoveStatus').value = customer.loveStatus || '선택 안 함';
            document.getElementById('editJobStatus').value = customer.jobStatus || '선택 안 함';
            document.getElementById('editPackage').value = customer.package || 'light';
            document.getElementById('editFortuneType').value = customer.fortuneType || '';
            document.getElementById('editMainConcern').value = customer.mainConcern || '';
            document.getElementById('editRepeatPattern').value = customer.repeatPattern || '';
            document.getElementById('editCustomQuestion').value = customer.customQuestion || '';
            
            // 매칭 정보 로드
            document.getElementById('editMatchingInterest').value = customer.matchingInterest || '';
            document.getElementById('editMatchingAgeUpper').value = customer.matchingAgeUpper || '';
            document.getElementById('editMatchingAgeLower').value = customer.matchingAgeLower || '';
            
            // 추가질문 로드 (캐시에서)
            const cachedQuestions = localStorage.getItem('saju_questions_' + customer.orderCode);
            if (cachedQuestions) {
                try {
                    const parsed = JSON.parse(cachedQuestions);
                    if (parsed.questions && parsed.questions[0]) {
                        document.getElementById('editQuestionContent').value = parsed.questions[0].content || '';
                    }
                } catch(e) {}
            } else {
                document.getElementById('editQuestionContent').value = '';
            }
            
            document.getElementById('editModal').classList.add('show');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }
        
        async function saveCustomerEdit() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            // 수정된 값 가져오기
            const updates = {
                name: document.getElementById('editName').value,
                phone: document.getElementById('editPhone').value,
                gender: document.getElementById('editGender').value,
                partnerGender: document.getElementById('editPartnerGender').value,
                birthYear: document.getElementById('editBirthYear').value,
                birthMonth: document.getElementById('editBirthMonth').value,
                birthDay: document.getElementById('editBirthDay').value,
                birthHour: document.getElementById('editBirthHour').value,
                birthMinute: document.getElementById('editBirthMinute').value,
                isLunar: document.getElementById('editIsLunar').value,
                loveStatus: document.getElementById('editLoveStatus').value,
                jobStatus: document.getElementById('editJobStatus').value,
                package: document.getElementById('editPackage').value,
                fortuneType: document.getElementById('editFortuneType').value,
                mainConcern: document.getElementById('editMainConcern').value,
                repeatPattern: document.getElementById('editRepeatPattern').value,
                customQuestion: document.getElementById('editCustomQuestion').value,
                // 매칭 정보 추가
                matchingInterest: document.getElementById('editMatchingInterest').value,
                matchingAgeUpper: document.getElementById('editMatchingAgeUpper').value,
                matchingAgeLower: document.getElementById('editMatchingAgeLower').value
            };
            
            // 추가질문 내용 (별도 저장)
            const questionContent = document.getElementById('editQuestionContent').value;
            
            // 로컬 업데이트
            Object.assign(customer, updates);
            localStorage.setItem('saju_customers', JSON.stringify(customers));
            
            // 추가질문 캐시 업데이트
            if (questionContent && customer.orderCode) {
                const cachedQ = localStorage.getItem('saju_questions_' + customer.orderCode);
                let qData = { success: true, questions: [{ content: questionContent }] };
                if (cachedQ) {
                    try {
                        qData = JSON.parse(cachedQ);
                        if (qData.questions && qData.questions[0]) {
                            qData.questions[0].content = questionContent;
                        } else {
                            qData.questions = [{ content: questionContent }];
                        }
                    } catch(e) {}
                }
                localStorage.setItem('saju_questions_' + customer.orderCode, JSON.stringify(qData));
            }
            
            // UI 먼저 업데이트 (즉시!)
            closeEditModal();
            showCustomerDetail(customer);
            renderCustomerList();
            
            // Google Sheets 백그라운드 저장 (시트1)
            const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=updateCustomerBatch&orderCode=${customer.orderCode}&fields=${encodeURIComponent(JSON.stringify(updates))}`;
            fetch(url).then(() => {
                console.log('Google Sheets 고객 정보 업데이트 완료');
            }).catch(error => {
                console.log('Google Sheets 동기화 실패 (로컬에는 저장됨):', error);
            });

            // ★ Supabase도 동시에 업데이트
            supabaseUpdateCustomer(customer.orderCode, updates).then(result => {
                if (result) console.log('⚡ Supabase 고객 정보 업데이트 완료');
            }).catch(error => {
                console.log('Supabase 동기화 실패:', error);
            });
            
            // 추가질문 시트 저장 (별도 API)
            if (questionContent && customer.orderCode) {
                const qUrl = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=updateQuestionContent&orderCode=${encodeURIComponent(customer.orderCode)}&content=${encodeURIComponent(questionContent)}`;
                fetch(qUrl).then(() => {
                    console.log('추가질문 업데이트 완료');
                }).catch(error => {
                    console.log('추가질문 저장 실패:', error);
                });
            }
            
            alert('✅ 고객 정보가 수정되었습니다!');
        }
        
        // ========== 개별 고객 삭제 ==========
        async function deleteCustomer() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            
            if (!confirm(`정말 "${customer.name}"님의 데이터를 삭제할까요?\n\n이 작업은 되돌릴 수 없습니다.`)) {
                return;
            }
            
            // Google Sheets에서 먼저 삭제 시도 (GET 방식)
            try {
                const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=delete&rowIndex=${customer._rowIndex}`;
                const response = await fetch(url);
                const result = await response.json();
                console.log('Google Sheets 삭제:', result);
            } catch (error) {
                console.log('Google Sheets 삭제 실패:', error);
            }

            // Supabase에서 삭제
            if (customer.orderCode) {
                supabaseDeleteCustomer(customer.orderCode).then(result => {
                    if (result) console.log('⚡ Supabase 고객 삭제 완료');
                }).catch(error => {
                    console.log('Supabase 삭제 실패:', error);
                });
            }

            // localStorage에서 삭제
            customers.splice(selectedCustomer, 1);
            localStorage.setItem('saju_customers', JSON.stringify(customers));
            
            selectedCustomer = null;
            document.getElementById('customerDetail').classList.remove('show');
            document.getElementById('contentEmpty').style.display = 'flex';
            
            renderCustomerList();
            alert('삭제되었습니다.');
        }

        // ========== sajuResult 파싱 ==========
        function parseSajuResult(sajuResult) {
            const result = {
                year: { gan: '?', ji: '?' },
                month: { gan: '?', ji: '?' },
                day: { gan: '?', ji: '?' },
                hour: { gan: '?', ji: '?' },
                oheng: { 목: 0, 화: 0, 토: 0, 금: 0, 수: 0 }
            };
            
            try {
                // 사주 테이블에서 천간/지지 추출
                // 형식: │ 갑     │ 을     │ 병     │ 정     │ (천간)
                //       │ 자     │ 축     │ 인     │ 묘     │ (지지)
                const lines = sajuResult.split('\n');
                let ganLine = '';
                let jiLine = '';
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    // 테이블 데이터 행 찾기 (├ 다음의 │로 시작하는 행들)
                    if (line.includes('├') && line.includes('┼')) {
                        // 다음 두 줄이 천간과 지지
                        if (i + 1 < lines.length) ganLine = lines[i + 1];
                        if (i + 2 < lines.length) jiLine = lines[i + 2];
                        break;
                    }
                }
                
                // 천간 추출 (│ 사이의 문자)
                if (ganLine) {
                    const ganMatch = ganLine.match(/│\s*(\S+)\s*│\s*(\S+)\s*│\s*(\S+)\s*│\s*(\S+)\s*│/);
                    if (ganMatch) {
                        result.hour.gan = ganMatch[1].trim() || '?';
                        result.day.gan = ganMatch[2].trim() || '?';
                        result.month.gan = ganMatch[3].trim() || '?';
                        result.year.gan = ganMatch[4].trim() || '?';
                    }
                }
                
                // 지지 추출
                if (jiLine) {
                    const jiMatch = jiLine.match(/│\s*(\S+)\s*│\s*(\S+)\s*│\s*(\S+)\s*│\s*(\S+)\s*│/);
                    if (jiMatch) {
                        result.hour.ji = jiMatch[1].trim() || '?';
                        result.day.ji = jiMatch[2].trim() || '?';
                        result.month.ji = jiMatch[3].trim() || '?';
                        result.year.ji = jiMatch[4].trim() || '?';
                    }
                }
                
                // 오행 분포 추출
                // 형식: - 목(木): 2개 또는 목(木): 1.5개 (소수점 포함)
                const ohengPatterns = [
                    { name: '목', pattern: /목\(木\):\s*([\d.]+)개/ },
                    { name: '화', pattern: /화\(火\):\s*([\d.]+)개/ },
                    { name: '토', pattern: /토\(土\):\s*([\d.]+)개/ },
                    { name: '금', pattern: /금\(金\):\s*([\d.]+)개/ },
                    { name: '수', pattern: /수\(水\):\s*([\d.]+)개/ }
                ];
                
                ohengPatterns.forEach(({ name, pattern }) => {
                    const match = sajuResult.match(pattern);
                    if (match) {
                        result.oheng[name] = parseFloat(match[1]) || 0;
                    }
                });
                
            } catch (e) {
                console.error('sajuResult 파싱 오류:', e);
            }
            
            return result;
        }

        // ========== 사주 계산 ==========
        function calculateSaju(customer) {
            const year = parseInt(customer.birthYear);
            const month = parseInt(customer.birthMonth);
            const day = parseInt(customer.birthDay);
            const hour = customer.birthHour ? parseInt(customer.birthHour) : null;

            // 연주
            const yearGanjiIndex = (year - 4) % 60;
            const yearGan = CHEONGAN[yearGanjiIndex % 10];
            const yearJi = JIJI[yearGanjiIndex % 12];

            // 월주
            const monthJi = MONTH_JIJI[month - 1];
            const yearGanIndex = CHEONGAN.indexOf(yearGan);
            const monthGanBase = (yearGanIndex % 5) * 2;
            const monthGan = CHEONGAN[(monthGanBase + month - 1) % 10];

            // 일주 (간단 계산)
            const baseDate = new Date(1900, 0, 31);
            const targetDate = new Date(year, month - 1, day);
            const diffDays = Math.floor((targetDate - baseDate) / (1000 * 60 * 60 * 24));
            const dayGanjiIndex = diffDays % 60;
            const dayGan = CHEONGAN[dayGanjiIndex % 10];
            const dayJi = JIJI[dayGanjiIndex % 12];

            // 시주
            let hourGan = '', hourJi = '';
            if (hour !== null) {
                const hourJiIndex = Math.floor((hour + 1) / 2) % 12;
                hourJi = JIJI[hourJiIndex];
                const dayGanIndex = CHEONGAN.indexOf(dayGan);
                const hourGanBase = (dayGanIndex % 5) * 2;
                hourGan = CHEONGAN[(hourGanBase + hourJiIndex) % 10];
            }

            // 오행 계산
            const oheng = { 목: 0, 화: 0, 토: 0, 금: 0, 수: 0 };
            [yearGan, monthGan, dayGan, hourGan].forEach(g => {
                if (g && OHENG_CHEONGAN[g]) oheng[OHENG_CHEONGAN[g]]++;
            });
            [yearJi, monthJi, dayJi, hourJi].forEach(j => {
                if (j && OHENG_JIJI[j]) oheng[OHENG_JIJI[j]]++;
            });

            return {
                year: { gan: yearGan, ji: yearJi },
                month: { gan: monthGan, ji: monthJi },
                day: { gan: dayGan, ji: dayJi },
                hour: { gan: hourGan, ji: hourJi },
                ilgan: dayGan,
                oheng: oheng
            };
        }

        // ========== 사주 표시 렌더링 ==========
        function renderSajuDisplay(saju) {
            const pillars = [
                { label: '시주', ...saju.hour },
                { label: '일주', ...saju.day },
                { label: '월주', ...saju.month },
                { label: '연주', ...saju.year }
            ];

            document.getElementById('sajuDisplay').innerHTML = pillars.map(p => `
                <div class="saju-pillar">
                    <div class="label">${p.label}</div>
                    <div class="chars">
                        <div class="char cheongan">${p.gan || '?'}</div>
                        <div class="char jiji">${p.ji || '?'}</div>
                    </div>
                </div>
            `).join('');
        }

        // ========== 오행 바 렌더링 ==========
        function renderOhengBars(oheng) {
            const total = Object.values(oheng).reduce((a, b) => a + b, 0) || 1;
            const items = [
                { key: '목', char: '木', class: 'wood' },
                { key: '화', char: '火', class: 'fire' },
                { key: '토', char: '土', class: 'earth' },
                { key: '금', char: '金', class: 'metal' },
                { key: '수', char: '水', class: 'water' }
            ];

            document.getElementById('ohengBars').innerHTML = items.map(item => {
                const count = oheng[item.key] || 0;
                const percent = (count / total) * 100;
                return `
                    <div class="oheng-bar">
                        <div class="label">
                            <span class="char ${item.class}">${item.char}</span>
                            ${item.key}
                        </div>
                        <div class="track">
                            <div class="fill ${item.class}" style="width: ${percent}%">${count > 0 ? count : ''}</div>
                        </div>
                        <div class="count">${count}</div>
                    </div>
                `;
            }).join('');
        }

        // ========== 포함 항목 렌더링 ==========
        function renderIncludes(customer) {
            const pkg = SAJU_CONFIG.packages[customer.package] || SAJU_CONFIG.packages.light;
            const selectedOpts = (customer.selectedOptions || '').split(',').filter(Boolean);

            let items = [...pkg.includes];
            
            // 선택 항목 표시
            selectedOpts.forEach(opt => {
                const optName = SAJU_CONFIG.selectableOptions[opt];
                if (optName) {
                    items = items.map(item => 
                        item.includes('선택') ? item : item
                    );
                }
            });

            document.getElementById('includesList').innerHTML = items.map(item => {
                const isSelected = selectedOpts.some(opt => 
                    SAJU_CONFIG.selectableOptions[opt] && item.includes('선택')
                );
                return `<span class="includes-item">${item}</span>`;
            }).join('') + selectedOpts.map(opt => 
                `<span class="includes-item selected">✓ ${SAJU_CONFIG.selectableOptions[opt]}</span>`
            ).join('');
        }

        // ========== 질문지 렌더링 ==========
        function renderQuestions(customer) {
            const questions = [
                { q: '가장 궁금한 것', a: customer.mainConcern },
                { q: '연애 상태', a: customer.loveStatus },
                { q: '직업 고민', a: customer.jobConcern },
                { q: '재물 고민', a: customer.moneyConcern },
                { q: '올해 목표', a: customer.yearGoal },
                { q: '맞춤 질문 (프리미엄)', a: customer.customQuestion }
            ].filter(item => item.a);

            document.getElementById('questionsBody').innerHTML = questions.map(item => `
                <div class="question-item">
                    <div class="q">${item.q}</div>
                    <div class="a">${item.a}</div>
                </div>
            `).join('');
        }

        // ========== 추가질문 상태 확인 ==========
        async function checkQuestionStatus(orderCode) {
            const statusEl = document.getElementById('detailQuestionStatus');
            const selectEl = document.getElementById('answerStatusSelect');
            const additionalPromptCard = document.getElementById('additionalPromptCard');
            
            // 추가질문 섹션 카드들
            const additionalDivider = document.getElementById('additionalSectionDivider');
            const additionalResultCard = document.getElementById('additionalResultCard');
            const additionalFileCard = document.getElementById('additionalResultFileCard');
            
            // 추가질문 섹션 숨기기 헬퍼
            function hideAdditionalSection() {
                additionalPromptCard.style.display = 'none';
                additionalDivider.style.display = 'none';
                additionalResultCard.style.display = 'none';
                additionalFileCard.style.display = 'none';
            }
            
            // 추가질문 섹션 표시 헬퍼
            function showAdditionalSection() {
                additionalPromptCard.style.display = 'block';
                additionalDivider.style.display = 'block';
                additionalResultCard.style.display = 'block';
                additionalFileCard.style.display = 'block';
            }
            
            if (!orderCode) {
                statusEl.textContent = '-';
                selectEl.disabled = true;
                hideAdditionalSection();
                return;
            }

            // ★ 1. 캐시에서 먼저 즉시 표시 (로딩 없음!)
            try {
                const cachedStatuses = JSON.parse(localStorage.getItem('saju_question_statuses') || '{}');
                if (cachedStatuses[orderCode]) {
                    const rawStatus = cachedStatuses[orderCode].answerStatus || '';
                    let displayStatus = (!rawStatus || rawStatus === '대기') ? '제출완료' : rawStatus;
                    
                    statusEl.textContent = displayStatus;
                    statusEl.className = 'status-info-value' + (displayStatus === '전달완료' ? ' submitted' : '');
                    selectEl.value = (!rawStatus || rawStatus === '대기') ? '제출완료' : rawStatus;
                    selectEl.disabled = currentAdmin ? !currentAdmin.perm_status_other : false;
                    
                    // 추가질문 섹션 표시
                    showAdditionalSection();
                    if (selectedCustomer !== null) {
                        loadAdditionalQuestions(customers[selectedCustomer], null);
                    }
                    return; // 캐시 있으면 API 호출 안함
                }
            } catch (e) {}

            // ★ 2. 캐시 없으면 API 호출 (첫 방문 시에만)
            try {
                const response = await fetch(`${SAJU_CONFIG.googleSheets.webAppUrl}?action=getQuestions&orderCode=${encodeURIComponent(orderCode)}`);
                const result = await response.json();
                
                if (result.success && result.questions && result.questions.length > 0) {
                    const currentStatus = result.questions[0].status || '대기';
                    let displayStatus = (currentStatus === '대기') ? '제출완료' : currentStatus;
                    
                    statusEl.textContent = displayStatus;
                    statusEl.className = 'status-info-value' + (displayStatus === '전달완료' ? ' submitted' : '');
                    selectEl.value = (currentStatus === '대기') ? '제출완료' : currentStatus;
                    selectEl.disabled = currentAdmin ? !currentAdmin.perm_status_other : false;
                    
                    // 추가질문 섹션 표시
                    showAdditionalSection();
                    if (selectedCustomer !== null) {
                        loadAdditionalQuestions(customers[selectedCustomer], result);
                    }
                } else {
                    statusEl.textContent = '대기';
                    statusEl.className = 'status-info-value not-submitted';
                    selectEl.disabled = true;
                    hideAdditionalSection();
                }
            } catch (error) {
                console.error('추가질문 상태 확인 실패:', error);
                statusEl.textContent = '확인 불가';
                selectEl.disabled = true;
                hideAdditionalSection();
            }
        }

        // ========== 추가질문 상태 업데이트 ==========
        async function updateAnswerStatus() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            const newStatus = document.getElementById('answerStatusSelect').value;
            
            if (!customer.orderCode) {
                alert('주문코드가 없습니다.');
                return;
            }
            
            // API 호출 (백그라운드)
            const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=updateAnswerStatus&orderCode=${encodeURIComponent(customer.orderCode)}&status=${encodeURIComponent(newStatus)}`;
            fetch(url).then(() => {
                console.log('추가질문 상태 업데이트 완료:', newStatus);
            }).catch(error => {
                console.log('추가질문 상태 업데이트 실패:', error);
            });
            
            // 상세 정보 업데이트
            document.getElementById('detailQuestionStatus').textContent = newStatus;
        }

        // ========== 추가질문 프롬프트 로드 ==========
        async function loadAdditionalQuestions(customer, cachedQuestions = null) {
            const loadingEl = document.getElementById('additionalPromptLoading');
            const emptyEl = document.getElementById('additionalPromptEmpty');
            const listEl = document.getElementById('additionalQuestionList');
            const listCardEl = document.getElementById('additionalQuestionListCard');
            const allEl = document.getElementById('additionalPromptAll');
            const badgeEl = document.getElementById('questionCountBadge');
            const listBadgeEl = document.getElementById('questionListCountBadge');
            
            // 초기화
            loadingEl.style.display = 'none';
            emptyEl.style.display = 'none';
            listEl.style.display = 'none';
            listCardEl.style.display = 'none';
            allEl.style.display = 'none';
            
            if (!customer.orderCode) {
                emptyEl.style.display = 'block';
                return;
            }
            
            try {
                let result = cachedQuestions;
                
                // ★ 1. 캐시된 질문 내용 확인
                if (!result) {
                    try {
                        const cachedContent = localStorage.getItem('saju_questions_' + customer.orderCode);
                        if (cachedContent) {
                            result = JSON.parse(cachedContent);
                        }
                    } catch (e) {}
                }
                
                // ★ 2. 캐시 없으면 API 호출
                if (!result) {
                    const response = await fetch(`${SAJU_CONFIG.googleSheets.webAppUrl}?action=getQuestions&orderCode=${encodeURIComponent(customer.orderCode)}`);
                    result = await response.json();
                    // 캐시 저장
                    if (result.success) {
                        localStorage.setItem('saju_questions_' + customer.orderCode, JSON.stringify(result));
                    }
                }
                
                if (result.success && result.questions && result.questions.length > 0) {
                    // 질문 파싱
                    const rawContent = result.questions[0].content || '';
                    const questions = parseQuestions(rawContent);
                    
                    if (questions.length === 0) {
                        emptyEl.style.display = 'block';
                        badgeEl.textContent = '0개';
                        return;
                    }
                    
                    badgeEl.textContent = questions.length + '개';
                    
                    // 고객 정보 준비
                    const customerInfo = {
                        name: customer.name,
                        birth: formatBirthInfo(customer),
                        orderCode: customer.orderCode,
                        sajuResult: customer.sajuResult || ''
                    };
                    
                    // 질문 목록 (복사 버튼 없이 텍스트만)
                    listEl.innerHTML = questions.map((q, idx) => `
                        <div style="padding:10px 12px; background:#f9f6ef; border-radius:6px; margin-bottom:8px; border-left:3px solid var(--point-gold);">
                            <span style="font-size:12px; font-weight:600; color:var(--point-gold);">Q${idx + 1}.</span>
                            <span style="font-size:12px; color:#5a4a3a; margin-left:8px;">${escapeHtml(q)}</span>
                        </div>
                    `).join('');
                    listEl.style.display = 'block';
                    listCardEl.style.display = 'block';
                    listBadgeEl.textContent = questions.length + '개';
                    
                    // 전체 통합 프롬프트 생성
                    const allPrompt = generateAllPrompts(customerInfo, questions);
                    document.getElementById('allQuestionsPrompt').value = allPrompt;
                    allEl.style.display = 'block';
                    
                } else {
                    emptyEl.style.display = 'block';
                    badgeEl.textContent = '0개';
                }
            } catch (error) {
                console.error('추가질문 로드 실패:', error);
                emptyEl.textContent = '로드 실패';
                emptyEl.style.display = 'block';
            }
        }
        
        // ========== 질문 파싱 ==========
        function parseQuestions(rawContent) {
            if (!rawContent) return [];
            
            // "[1] 질문1 || [2] 질문2" 형식 파싱
            const parts = rawContent.split(' || ');
            return parts.map(part => {
                // "[1] " 제거
                return part.replace(/^\[\d+\]\s*/, '').trim();
            }).filter(q => q.length > 0);
        }
        
        // ========== 생년월일 정보 포맷 ==========
        function formatBirthInfo(customer) {
            const calendarType = (customer.isLunar === 'Y' || customer.isLunar === 'true') ? '음력' : '양력';
            const gender = customer.gender === 'male' ? '남자' : customer.gender === 'female' ? '여자' : customer.gender;
            
            let timeStr = '';
            if (customer.birthHour) {
                timeStr = ` ${customer.birthHour}시`;
                if (customer.birthMinute) {
                    timeStr += ` ${customer.birthMinute}분`;
                }
            }
            
            return `${customer.birthYear}년 ${customer.birthMonth}월 ${customer.birthDay}일${timeStr} (${calendarType}, ${gender})`;
        }
        
        // ========== 개별 프롬프트 생성 ==========
        function generateSinglePrompt(customerInfo, question, questionNum) {
            return `[사주 추가질문]
━━━━━━━━━━━━━━━━━━━━
주문코드: ${customerInfo.orderCode}
이름: ${customerInfo.name}
생년월일: ${customerInfo.birth}
━━━━━━━━━━━━━━━━━━━━
질문 ${questionNum}: ${question}
━━━━━━━━━━━━━━━━━━━━`;
        }
        
        // ========== 전체 통합 프롬프트 생성 ==========
        function generateAllPrompts(customerInfo, questions) {
            const questionList = questions.map((q, idx) => `[질문 ${idx + 1}] ${q}`).join('\n');
            
            // sajuResult에서 "### 질문지 응답"을 "### 이전 질문지 응답"으로 변경
            const sajuResultFormatted = customerInfo.sajuResult 
                ? customerInfo.sajuResult.replace('### 질문지 응답', '### 이전 질문지 응답')
                : '(사주 계산 결과 없음)';
            
            return `[사주 추가질문]

# ⚙️ SYSTEM MODE: AUTO ROUTE SAJU v3.1 (대화형 리딩 최적화)

─────────────────────────────
📋 고객 정보
─────────────────────────────
주문코드: ${customerInfo.orderCode}
이름: ${customerInfo.name}
생년월일: ${customerInfo.birth}
총 질문 수: ${questions.length}개
📅 현재 시점: ${new Date().getFullYear()}년 ${new Date().getMonth() + 1}월

─────────────────────────────
📊 사주 계산 결과 & 이전 질문지 응답
─────────────────────────────
${sajuResultFormatted}

─────────────────────────────
❓ 추가질문 목록
─────────────────────────────
${questionList}

─────────────────────────────
🎯 핵심 실행 규칙
─────────────────────────────
1️⃣ **각 질문마다 개별적으로 상세히 답변**하세요. 절대 뭉뚱그리지 마세요!
2️⃣ **질문 1개당 최소 400자 이상**, 2~3단락으로 리듬감 있게 구성하세요.
3️⃣ **토큰을 최대한 활용**해 풍부하고 구체적인 해석을 제공하세요.
4️⃣ 각 질문에 대해 명리/주역/택일 등 해당 루트를 적용해 답변하세요.
5️⃣ 문체는 "~할 수 있어요"를 기본으로 하되, 자연스러운 변형("~해보세요", "~좋아요", "~거든요")을 허용합니다.

─────────────────────────────
💬 상담 톤 가이드 (중요!)
─────────────────────────────
▶ 단락 사이에 **감정적 연결어**를 자유롭게 사용하세요:
  - "그런데요, 신기한 건…"
  - "그래서 이때는요…"
  - "사실 더 중요한 건요…"
  - "딱 그런 시기예요."

▶ **공감형 감탄 문장**을 각 질문당 1회 이상 포함하세요:
  - "그때 이상하게 기운이 달라지지 않았나요?"
  - "혹시 그 무렵에 마음이 복잡했던 적 있으세요?"
  - "아마 그래서 요즘 유독 그런 생각이 드셨을 거예요."

▶ 보고서처럼 딱딱하게 쓰지 말고, **친한 언니/오빠가 상담해주는 톤**으로 작성하세요.

─────────────────────────────
① 루트 자동 선택 (매우 중요!)
─────────────────────────────
**각 질문의 핵심 키워드를 분석해서 해당 루트만 출력하세요!**

| 질문 키워드 | 적용 루트 |
|------------|----------|
| 연애/궁합/사랑/상대/결혼/인연 | 명리 + 주역 |
| 사업/창업/직업/재물/투자/이직/돈 | 명리 + 주역 + 풍수 |
| 심리/마음/성장/내면/고민/불안/성격 | 명리 + 주역 |
| 건강/집/이사/공간/인테리어 | 명리 + 풍수 |
| 언제/시기/날짜/타이밍/운/계획/기회 | 명리 + 택일 |
| 운세/흐름/변화/전환/앞으로 | 명리 + 주역 |

⚠️ **절대 규칙**: 
- 택일은 "언제/시기/날짜/타이밍" 질문에만!
- 풍수는 "사업/집/공간/이사" 질문에만!
- 모든 질문에 명리+주역+택일 다 넣지 마세요!

─────────────────────────────
② 출력 형식 (HTML)
─────────────────────────────
\`\`\`html
<!-- ★ 고객 메타정보 (필수! 맨 위에 출력) -->
<div class="customer-meta">
주문코드: ${customerInfo.orderCode}
이름: ${customerInfo.name}
생년월일: ${customerInfo.birth}
</div>

<div class="additional-answer">
  <div class="answer-header">
    <span class="answer-icon">🔮</span>
    <h3>추가 질문 답변</h3>
  </div>

  <!-- ★ 질문 1 (예: 연애 질문 → 명리+주역만!) -->
  <div class="question-block">
    <div class="question-title">❓ 질문 1: [질문 내용]</div>
    
    <div class="route-section">
      <div class="route-title">💫 명리 해석</div>
      <div class="route-content">[상세 해석]</div>
    </div>
    
    <div class="route-section">
      <div class="route-title">🔮 주역 해석</div>
      <div class="route-content">[상세 해석]</div>
    </div>
    
    <!-- ⚠️ 연애 질문이므로 택일/풍수 섹션 없음! -->
    
    <div class="question-advice">
      <strong>💡 핵심 조언:</strong> [행동 지침]
    </div>
  </div>

  <!-- ★ 질문 2 (예: 시기 질문 → 명리+택일만!) -->
  <div class="question-block">
    <div class="question-title">❓ 질문 2: [질문 내용]</div>
    
    <div class="route-section">
      <div class="route-title">💫 명리 해석</div>
      <div class="route-content">[상세 해석]</div>
    </div>
    
    <div class="route-section">
      <div class="route-title">📅 택일 조언</div>
      <div class="route-content">[구체적 시기]</div>
    </div>
    
    <!-- ⚠️ 시기 질문이므로 주역/풍수 섹션 없음! -->
    
    <div class="question-advice">
      <strong>💡 핵심 조언:</strong> [행동 지침]
    </div>
  </div>

  <!-- ★ 질문 3, 4... 각 질문 키워드에 맞는 루트만 선택해서 반복 -->

  <!-- 전체 종합 -->
  <div class="final-summary">
    <div class="summary-title">🌈 전체 종합 요약</div>
    <div class="summary-content">
      [모든 질문을 아우르는 전체 흐름 요약 - 200자 이상]
      [마지막 문장은 반드시 따뜻한 감성 마무리로!]
      (예: "이 모든 흐름은 결국 당신이 빛을 되찾는 과정이에요.")
    </div>
  </div>

  <div class="luck-point">
    <span class="luck-icon">🍀</span>
    <span>행운 키워드: [키워드1], [키워드2], [키워드3]</span>
  </div>
</div>
\`\`\`

─────────────────────────────
③ 작성 지침
─────────────────────────────
1️⃣ **질문별 루트 분석**: 각 질문 키워드 확인 → 해당 루트만 출력!
2️⃣ **구체적 시기**: "2026년 3월", "을묘월", "봄이 시작될 무렵" 등
3️⃣ **공감 포인트**: 각 질문당 공감형 감탄 문장 1회 이상
4️⃣ **리듬감**: 각 답변은 2~3단락, 단락 사이에 연결어 사용
5️⃣ **감성 마무리**: 종합 요약 마지막은 따뜻한 문장으로 끝내기

─────────────────────────────
③-2. 감성 보완 규칙 (필수!)
─────────────────────────────
📌 논리만으로 끝내지 말고, 감성을 더해야 "마음에 남는 상담"이 됩니다.

1️⃣ **서론**: 바로 설명 시작 ❌ → 감정 인정 먼저!
   예: "요즘 마음이 답답하게 느껴지셨죠? 이건 단순한 고민이 아니라 운의 전환점이에요."

2️⃣ **명리 해석**: 용신/오행이 "왜" 필요한지 이유 1줄 필수
   예: "火가 많으면 흙이 마르니까, 金·水가 윤택하게 해줘요"

3️⃣ **방향/공간 해석**: 감각적 이미지로 설명
   예: "서쪽은 석양의 금 기운이 깃든 곳이에요. 새로운 기회가 모여드는 방향이죠."

4️⃣ **풍수 조언**: 체감할 수 있는 예시 1줄 추가
   예: "현관 열 때 시원하고 밝게 느껴지면, 그건 좋은 기운이 흐르는 곳이에요"

5️⃣ **택일 조언**: 날짜만 나열 ❌ → 명리적 이유 1줄 필수
   ⚠️ **현재 시점 이후의 날짜/시기만 언급하세요! 이미 지난 달/시기는 절대 예언 금지!**
   예: "8~10월은 금의 계절이라, 부족한 기운이 자연스럽게 채워지는 시기예요"

6️⃣ **결론**: 딱 끊기지 말고 감성적 여운 남기기!
   예: "이 변화는 마른 흙에 단비가 스며드는 것처럼, 새로운 기운의 시작이 될 거예요 🌿"

─────────────────────────────
④ 분량 체크
─────────────────────────────
- 질문 1개당: 최소 400자, 2~3단락 구성
- 질문 ${questions.length}개 → 총 최소 ${questions.length * 400}자 이상
- 전체 종합: 최소 200자 + 감성 마무리

⚠️ 고객이 돈을 내고 구매한 서비스입니다. 정성껏, 따뜻하게 답변해주세요.

─────────────────────────────
⑤ 검증 (VERIFY)
─────────────────────────────
- [ ] 사주 4주 먼저 계산했는가?
- [ ] 질문 ${questions.length}개 모두 개별 답변함
- [ ] 각 질문 키워드 분석 → 해당 루트만 출력 (택일은 시기 질문에만! 풍수는 공간/사업에만!)
- [ ] 각 질문당 400자 이상 + 2~3단락 구성
- [ ] 각 질문에 공감형 감탄 문장 포함
- [ ] 단락 사이 감정적 연결어 사용
- [ ] 종합 요약 마지막이 따뜻한 감성 문장으로 끝남
- [ ] 【감성 보완】 서론에서 감정 인정 먼저 했는가?
- [ ] 【감성 보완】 용신/오행 "왜 필요한지" 이유 설명했는가?
- [ ] 【감성 보완】 결론이 감성적 여운으로 마무리되는가?`;
        }
        
        // ========== 개별 질문 프롬프트 복사 ==========
        function copySinglePrompt(index) {
            const textarea = document.getElementById(`singlePrompt_${index}`);
            if (!textarea) return;
            
            navigator.clipboard.writeText(textarea.value).then(() => {
                alert(`📋 질문 ${index + 1} 프롬프트가 복사되었습니다!`);
            }).catch(() => {
                // 폴백
                textarea.style.display = 'block';
                textarea.select();
                document.execCommand('copy');
                textarea.style.display = 'none';
                alert(`📋 질문 ${index + 1} 프롬프트가 복사되었습니다!`);
            });
        }
        
        // ========== 전체 프롬프트 복사 ==========
        function copyAllQuestionsPrompt() {
            const textarea = document.getElementById('allQuestionsPrompt');
            
            navigator.clipboard.writeText(textarea.value).then(() => {
                alert('📋 전체 추가질문 프롬프트가 복사되었습니다!\n\nAI에 붙여넣기 하세요.');
            }).catch(() => {
                // 폴백
                textarea.select();
                document.execCommand('copy');
                alert('📋 전체 추가질문 프롬프트가 복사되었습니다!\n\nAI에 붙여넣기 하세요.');
            });
        }
        
        // ========== HTML 이스케이프 ==========
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== 상태 업데이트 ==========
        async function updateStatus() {
            if (selectedCustomer === null) return;
            const newStatus = document.getElementById('statusSelect').value;
            const customer = customers[selectedCustomer];
            const oldStatus = customer.status;
            const oldPaymentStatus = customer.paymentStatus;
            const oldPaymentDate = customer.paymentDate;
            
            // 권한 체크
            if (currentAdmin) {
                // 신규, 입금확인으로 변경 시 perm_status_paid 필요
                if (newStatus === '신규' || newStatus === '입금확인') {
                    if (!currentAdmin.perm_status_paid) {
                        alert('신규/입금확인 상태 변경 권한이 없습니다');
                        document.getElementById('statusSelect').value = oldStatus;
                        return;
                    }
                }
                // 작성중, 완료로 변경 시 perm_status_other 필요
                if (newStatus === '작성중' || newStatus === '완료') {
                    if (!currentAdmin.perm_status_other) {
                        alert('상태 변경 권한이 없습니다');
                        document.getElementById('statusSelect').value = oldStatus;
                        return;
                    }
                }
            }
            
            // status에 따라 paymentStatus 자동 결정
            const newPaymentStatus = (newStatus === '신규') ? '대기' : '완료';
            
            // paymentDate: 입금확인 이상이면 오늘 날짜 (이미 있으면 유지)
            let newPaymentDate = customer.paymentDate || '';
            if (newStatus !== '신규' && !newPaymentDate) {
                const today = new Date();
                newPaymentDate = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            } else if (newStatus === '신규') {
                newPaymentDate = '';
            }
            
            // ⚡ 즉시 로컬 데이터 업데이트 (낙관적 업데이트)
            customer.status = newStatus;
            customer.paymentStatus = newPaymentStatus;
            customer.paymentDate = newPaymentDate;
            
            // ⚡ 즉시 localStorage 저장
            localStorage.setItem('saju_customers', JSON.stringify(customers));
            
            // ⚡ 즉시 UI 업데이트
            updateCardVisibility(customer);
            renderCustomerList();
            
            // 🔄 백그라운드에서 Google Sheets 동기화 (기다리지 않음!)
            syncStatusToSheets(customer, newStatus, newPaymentStatus, newPaymentDate, oldStatus, oldPaymentStatus, oldPaymentDate);
        }
        
        // 백그라운드 동기화 함수
        async function syncStatusToSheets(customer, newStatus, newPaymentStatus, newPaymentDate, oldStatus, oldPaymentStatus, oldPaymentDate) {
            try {
                // status 업데이트
                const url1 = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=update&rowIndex=${customer._rowIndex}&field=status&value=${encodeURIComponent(newStatus)}`;
                const res1 = await fetch(url1);
                
                // paymentStatus 업데이트
                const url2 = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=update&rowIndex=${customer._rowIndex}&field=paymentStatus&value=${encodeURIComponent(newPaymentStatus)}`;
                const res2 = await fetch(url2);
                
                // paymentDate 업데이트
                const url3 = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=update&rowIndex=${customer._rowIndex}&field=paymentDate&value=${encodeURIComponent(newPaymentDate)}`;
                const res3 = await fetch(url3);

                console.log('✅ Google Sheets 동기화 완료');

                // ★ Supabase도 동시에 업데이트
                supabaseUpdateCustomer(customer.orderCode, {
                    status: newStatus,
                    paymentStatus: newPaymentStatus,
                    paymentDate: newPaymentDate
                }).then(() => console.log('⚡ Supabase 상태 동기화 완료'));
            } catch (error) {
                console.log('❌ Google Sheets 동기화 실패 - 롤백:', error);
                
                // 실패 시 롤백
                customer.status = oldStatus;
                customer.paymentStatus = oldPaymentStatus;
                customer.paymentDate = oldPaymentDate;
                localStorage.setItem('saju_customers', JSON.stringify(customers));
                
                // UI 롤백
                document.getElementById('statusSelect').value = oldStatus;
                updateCardVisibility(customer);
                renderCustomerList();
                
                // 실패 알림
                showSyncToast('❌ 동기화 실패 - 다시 시도해주세요');
            }
        }
        
        // 동기화 토스트 메시지
        function showSyncToast(message) {
            const toast = document.createElement('div');
            toast.className = 'sync-toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // ========== 회원가입 모달 ==========
        function showSignupModal() {
            document.getElementById('signupModal').classList.add('show');
            document.getElementById('signupId').value = '';
            document.getElementById('signupPw').value = '';
            document.getElementById('signupPwConfirm').value = '';
            document.getElementById('signupName').value = '';
            document.getElementById('signupError').style.display = 'none';
            document.getElementById('signupSuccess').style.display = 'none';
        }

        function closeSignupModal() {
            document.getElementById('signupModal').classList.remove('show');
        }

        // 모달 외부 클릭시 닫기
        if (document.getElementById('signupModal')) {
            document.getElementById('signupModal').addEventListener('click', function(e) {
                if (e.target === this) closeSignupModal();
            });
        }

        async function doSignup() {
            const id = document.getElementById('signupId').value.trim();
            const pw = document.getElementById('signupPw').value;
            const pwConfirm = document.getElementById('signupPwConfirm').value;
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            
            const errorEl = document.getElementById('signupError');
            const successEl = document.getElementById('signupSuccess');
            
            // 초기화
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            // 유효성 검사
            if (!id || !pw || !pwConfirm || !name || !email) {
                errorEl.textContent = '모든 필드를 입력해주세요.';
                errorEl.style.display = 'block';
                return;
            }
            
            if (pw !== pwConfirm) {
                errorEl.textContent = '비밀번호가 일치하지 않습니다.';
                errorEl.style.display = 'block';
                return;
            }
            
            // 이메일 형식 검사
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errorEl.textContent = '올바른 이메일 형식을 입력해주세요.';
                errorEl.style.display = 'block';
                return;
            }
            
            // 아이디 영문/숫자만 허용
            if (!/^[a-zA-Z0-9]+$/.test(id)) {
                errorEl.textContent = '아이디는 영문, 숫자만 사용 가능합니다.';
                errorEl.style.display = 'block';
                return;
            }
            
            // 비밀번호 영문/숫자만 허용
            if (!/^[a-zA-Z0-9]+$/.test(pw)) {
                errorEl.textContent = '비밀번호는 영문, 숫자만 사용 가능합니다.';
                errorEl.style.display = 'block';
                return;
            }
            
            if (pw.length < 4) {
                errorEl.textContent = '비밀번호는 4자 이상이어야 합니다.';
                errorEl.style.display = 'block';
                return;
            }
            
            // API 호출
            try {
                const signupData = { id, password: pw, name, email };
                const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=signup&data=${encodeURIComponent(JSON.stringify(signupData))}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    successEl.textContent = result.message;
                    successEl.style.display = 'block';
                    // 3초 후 모달 닫기
                    setTimeout(() => {
                        closeSignupModal();
                    }, 3000);
                } else {
                    errorEl.textContent = result.error || '가입 신청 실패';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                errorEl.textContent = '서버 연결 실패';
                errorEl.style.display = 'block';
            }
        }

        // ========== 관리자 관리 모달 ==========
        let adminList = [];

        function showAdminModal() {
            document.getElementById('adminModal').classList.add('show');
            loadAdminList();
            // 총관리자면 알림 시간 설정 표시
            if (currentAdmin && currentAdmin.perm_admin) {
                document.getElementById('notificationTimeSettings').style.display = 'block';
                loadNotificationTime();
            } else {
                document.getElementById('notificationTimeSettings').style.display = 'none';
            }
        }

        function closeAdminModal() {
            document.getElementById('adminModal').classList.remove('show');
            hideAdminForm();
        }

        // 알림 시간 설정 불러오기
        async function loadNotificationTime() {
            // ★ Supabase 우선
            try {
                const settings = await supabaseGetSetting('notification_settings');
                if (settings) {
                    const parsed = JSON.parse(settings);
                    document.getElementById('notifyStartHour').value = parsed.startHour || 10;
                    document.getElementById('notifyEndHour').value = parsed.endHour || 22;
                    document.getElementById('notifyInterval').value = parsed.interval || 1;
                    console.log('⚡ Supabase 알림 설정 로드');
                    return;
                }
            } catch (e) {}

            // Google Sheets 백업
            try {
                const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=getNotificationSettings`;
                const response = await fetch(url);
                const result = await response.json();
                if (result.success && result.settings) {
                    document.getElementById('notifyStartHour').value = result.settings.startHour || 10;
                    document.getElementById('notifyEndHour').value = result.settings.endHour || 22;
                    document.getElementById('notifyInterval').value = result.settings.interval || 1;
                    // Supabase에 동기화
                    supabaseSetSetting('notification_settings', JSON.stringify(result.settings));
                }
            } catch (e) {
                console.error('알림 설정 로드 실패:', e);
            }
        }

        // 알림 시간 설정 저장
        async function saveNotificationTime() {
            const startHour = document.getElementById('notifyStartHour').value;
            const endHour = document.getElementById('notifyEndHour').value;
            const interval = document.getElementById('notifyInterval').value;
            const settings = { startHour, endHour, interval };

            // ★ Supabase에 저장 (빠름!)
            const supabaseOk = await supabaseSetSetting('notification_settings', JSON.stringify(settings));
            if (supabaseOk) {
                console.log('⚡ Supabase 알림 설정 저장');
            }

            // Google Sheets에도 저장 (백업)
            try {
                const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=saveNotificationSettings&startHour=${startHour}&endHour=${endHour}&interval=${interval}`;
                const response = await fetch(url);
                const result = await response.json();
                if (result.success || supabaseOk) {
                    alert('알림 시간 설정이 저장되었습니다.');
                } else {
                    alert('저장 실패: ' + result.error);
                }
            } catch (e) {
                if (supabaseOk) {
                    alert('알림 시간 설정이 저장되었습니다.');
                } else {
                    alert('서버 연결 실패');
                }
            }
        }

        // 모달 외부 클릭시 닫기
        document.getElementById('adminModal').addEventListener('click', function(e) {
            if (e.target === this) closeAdminModal();
        });

        // 관리자 목록 로드
        async function loadAdminList() {
            const listEl = document.getElementById('adminList');

            // 캐시 먼저 표시
            const cached = localStorage.getItem('adminList_cache');
            if (cached) {
                adminList = JSON.parse(cached);
                renderAdminList();
            } else {
                listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">불러오는 중...</div>';
            }

            // ★ Supabase 우선 로드 (빠름!)
            try {
                const supabaseAdmins = await supabaseGetAdmins();
                if (supabaseAdmins && supabaseAdmins.length > 0) {
                    adminList = supabaseAdmins;
                    localStorage.setItem('adminList_cache', JSON.stringify(adminList));
                    renderAdminList();
                    console.log('⚡ Supabase 관리자 목록 로드:', adminList.length, '명');
                    return;
                }
            } catch (e) {
                console.log('Supabase 관리자 목록 실패, Google Sheets로...');
            }

            // Google Sheets 백업
            try {
                const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=getAdminList`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    adminList = result.admins;
                    localStorage.setItem('adminList_cache', JSON.stringify(adminList));
                    renderAdminList();
                    // ★ Supabase에 동기화
                    for (const admin of adminList) {
                        supabaseUpsertAdmin({ ...admin, status: admin.status || 'approved' });
                    }
                } else if (!cached) {
                    listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#c00;">로드 실패</div>';
                }
            } catch (error) {
                if (!cached) {
                    listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#c00;">서버 연결 실패</div>';
                }
            }
        }

        // 관리자 목록 렌더링
        function renderAdminList() {
            const listEl = document.getElementById('adminList');
            
            if (adminList.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">등록된 관리자가 없습니다</div>';
                return;
            }
            
            listEl.innerHTML = adminList.filter(a => a.status === 'approved' || !a.status).map(admin => {
                const isSuper = admin.id === 'oiah4579';
                const isSelf = currentAdmin && admin.id === currentAdmin.id;
                const showEdit = !isSuper || isSelf;  // 일반관리자이거나 본인이면 수정 가능
                const showDelete = !isSuper && !isSelf;  // 일반관리자이고 본인이 아니면 삭제 가능
                
                const perms = [];
                if (admin.perm_view) perms.push('조회');
                if (admin.perm_status_paid) perms.push('입금');
                if (admin.perm_status_other) perms.push('상태');
                if (admin.perm_result) perms.push('결과');
                if (admin.perm_delete) perms.push('삭제');
                if (admin.perm_edit) perms.push('수정');
                if (admin.perm_admin) perms.push('관리자');
                
                return `
                    <div class="admin-item ${isSuper ? 'super' : ''}">
                        <div class="admin-info">
                            <div class="admin-name">${admin.name} ${isSuper ? '👑' : ''} ${isSelf ? '<span style="background:#fff3e0; color:#e65100; padding:2px 8px; border-radius:10px; font-size:11px; margin-left:5px;">나</span>' : ''} ${admin.role ? `<span style="background:#e8f4e8; color:#2d5a2d; padding:2px 8px; border-radius:10px; font-size:11px; margin-left:5px;">${admin.role}</span>` : ''}</div>
                            <div class="admin-id">@${admin.id}</div>
                            <div class="admin-perms">${perms.join(' · ')}</div>
                        </div>
                        ${showEdit || showDelete ? `
                            <div class="admin-actions">
                                ${showEdit ? `<button class="edit-btn" onclick="showEditAdminForm('${admin.id}')">수정</button>` : ''}
                                ${showDelete ? `<button class="delete-btn" onclick="deleteAdmin('${admin.id}')">삭제</button>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // 추가 폼 보이기
        function showAddAdminForm() {
            document.getElementById('adminFormTitle').textContent = '새 관리자 추가';
            document.getElementById('adminFormMode').value = 'add';
            document.getElementById('adminFormName').value = '';
            document.getElementById('adminFormId').value = '';
            document.getElementById('adminFormId').disabled = false;
            document.getElementById('adminFormPw').value = '';
            document.getElementById('adminFormEmail').value = '';
            document.getElementById('permView').checked = true;
            document.getElementById('permStatusPaid').checked = true;
            document.getElementById('permStatusOther').checked = true;
            document.getElementById('permResult').checked = true;
            document.getElementById('permDelete').checked = false;
            document.getElementById('permEdit').checked = false;
            document.getElementById('permAdmin').checked = false;
            // 현재 비번 row 숨기기
            document.getElementById('currentPwRow').style.display = 'none';
            document.getElementById('pwLabel').textContent = '비밀번호';
            // 알림 체크박스 초기화
            document.getElementById('notify_신규').checked = false;
            document.getElementById('notify_입금확인').checked = false;
            document.getElementById('notify_작성중').checked = false;
            document.getElementById('notify_변환요청').checked = false;
            document.getElementById('notify_대기').checked = false;
            document.getElementById('notify_제작대기').checked = false;
            document.getElementById('notify_추가변환요청').checked = false;
            document.getElementById('adminFormRole').value = '';
            document.getElementById('adminForm').classList.add('show');
        }

        // 수정 폼 보이기
        function showEditAdminForm(adminId) {
            const admin = adminList.find(a => a.id === adminId);
            if (!admin) return;
            
            document.getElementById('adminFormTitle').textContent = '관리자 수정';
            document.getElementById('adminFormMode').value = 'edit';
            document.getElementById('adminFormName').value = admin.name;
            document.getElementById('adminFormId').value = admin.id;
            document.getElementById('adminFormId').disabled = true;
            document.getElementById('adminFormPw').value = '';
            document.getElementById('adminFormEmail').value = admin.email || '';
            document.getElementById('permView').checked = admin.perm_view;
            document.getElementById('permStatusPaid').checked = admin.perm_status_paid;
            document.getElementById('permStatusOther').checked = admin.perm_status_other;
            document.getElementById('permResult').checked = admin.perm_result;
            document.getElementById('permDelete').checked = admin.perm_delete;
            document.getElementById('permEdit').checked = admin.perm_edit;
            document.getElementById('permAdmin').checked = admin.perm_admin;
            // 현재 비번 표시
            document.getElementById('currentPwRow').style.display = 'flex';
            document.getElementById('adminFormCurrentPw').value = admin.password || '';
            document.getElementById('pwLabel').textContent = '새 비밀번호 (변경시만)';
            // 알림 체크박스 설정
            document.getElementById('notify_신규').checked = admin.notify_신규 === 'Y';
            document.getElementById('notify_입금확인').checked = admin.notify_입금확인 === 'Y';
            document.getElementById('notify_작성중').checked = admin.notify_작성중 === 'Y';
            document.getElementById('notify_변환요청').checked = admin.notify_변환요청 === 'Y';
            document.getElementById('notify_대기').checked = admin.notify_대기 === 'Y';
            document.getElementById('notify_제작대기').checked = admin.notify_제작대기 === 'Y';
            document.getElementById('notify_추가변환요청').checked = admin.notify_추가변환요청 === 'Y';
            document.getElementById('adminFormRole').value = admin.role || '';
            document.getElementById('adminForm').classList.add('show');
        }

        // 폼 숨기기
        function hideAdminForm() {
            document.getElementById('adminForm').classList.remove('show');
        }

        // 관리자 저장
        async function saveAdmin() {
            const mode = document.getElementById('adminFormMode').value;
            const name = document.getElementById('adminFormName').value;
            const id = document.getElementById('adminFormId').value;
            const pw = document.getElementById('adminFormPw').value;
            const email = document.getElementById('adminFormEmail').value;
            
            if (!name || !id) {
                alert('이름과 아이디를 입력하세요');
                return;
            }
            
            if (mode === 'add' && !pw) {
                alert('비밀번호를 입력하세요');
                return;
            }
            
            const adminData = {
                id: id,
                name: name,
                password: pw,
                email: email,
                perm_view: document.getElementById('permView').checked,
                perm_status_paid: document.getElementById('permStatusPaid').checked,
                perm_status_other: document.getElementById('permStatusOther').checked,
                perm_result: document.getElementById('permResult').checked,
                perm_delete: document.getElementById('permDelete').checked,
                perm_edit: document.getElementById('permEdit').checked,
                perm_admin: document.getElementById('permAdmin').checked,
                notify_신규: document.getElementById('notify_신규').checked ? 'Y' : 'N',
                notify_입금확인: document.getElementById('notify_입금확인').checked ? 'Y' : 'N',
                notify_작성중: document.getElementById('notify_작성중').checked ? 'Y' : 'N',
                notify_변환요청: document.getElementById('notify_변환요청').checked ? 'Y' : 'N',
                notify_대기: document.getElementById('notify_대기').checked ? 'Y' : 'N',
                notify_제작대기: document.getElementById('notify_제작대기').checked ? 'Y' : 'N',
                notify_추가변환요청: document.getElementById('notify_추가변환요청').checked ? 'Y' : 'N',
                role: document.getElementById('adminFormRole').value,
                requesterId: currentAdmin.id  // ★ 요청자 ID 추가
            };
            
            // UI 먼저 업데이트
            hideAdminForm();
            
            if (mode === 'add') {
                adminList.push(adminData);
            } else {
                const idx = adminList.findIndex(a => a.id === id);
                if (idx >= 0) {
                    adminList[idx] = { ...adminList[idx], ...adminData };
                }
            }
            renderAdminList();
            
            // 백그라운드에서 API 호출
            const action = mode === 'add' ? 'addAdmin' : 'updateAdmin';
            const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=${action}&data=${encodeURIComponent(JSON.stringify(adminData))}`;
            fetch(url).then(r => r.json()).then(result => {
                if (!result.success) {
                    alert('저장 실패: ' + result.error);
                    loadAdminList();
                }
            }).catch(() => {
                alert('서버 연결 실패');
                loadAdminList();
            });

            // Supabase에도 저장
            supabaseUpsertAdmin(adminData).then(result => {
                if (result) console.log('⚡ Supabase 관리자 저장 완료');
            }).catch(error => {
                console.log('Supabase 저장 실패:', error);
            });
        }

        // 관리자 삭제
        async function deleteAdmin(adminId) {
            if (!confirm('정말 이 관리자를 삭제할까요?')) return;

            // UI 먼저 업데이트
            adminList = adminList.filter(a => a.id !== adminId);
            renderAdminList();

            // 백그라운드에서 API 호출
            const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=deleteAdmin&adminId=${encodeURIComponent(adminId)}`;
            fetch(url).then(r => r.json()).then(result => {
                if (!result.success) {
                    alert('삭제 실패: ' + result.error);
                    loadAdminList();
                }
            }).catch(() => {
                alert('서버 연결 실패');
                loadAdminList();
            });

            // Supabase에서도 삭제
            supabaseDeleteAdmin(adminId).then(result => {
                if (result) console.log('⚡ Supabase 관리자 삭제 완료');
            }).catch(error => {
                console.log('Supabase 삭제 실패:', error);
            });
        }
        
        // ========== 관리자 탭 전환 ==========
        let currentAdminTab = 'approved';
        
        function switchAdminTab(tab) {
            currentAdminTab = tab;
            
            // 탭 버튼 활성화
            document.getElementById('tabApproved').classList.toggle('active', tab === 'approved');
            document.getElementById('tabPending').classList.toggle('active', tab === 'pending');
            
            // 목록 표시/숨김
            document.getElementById('adminList').style.display = tab === 'approved' ? 'block' : 'none';
            document.getElementById('pendingList').classList.toggle('show', tab === 'pending');
            document.querySelector('.add-admin-btn').style.display = tab === 'approved' ? 'block' : 'none';
            
            // 승인 대기 탭이면 목록 로드
            if (tab === 'pending') {
                renderPendingList();
            }
        }
        
        // 승인 대기 목록 렌더링
        function renderPendingList() {
            const listEl = document.getElementById('pendingList');
            const pendingAdmins = adminList.filter(a => a.status === 'pending');
            
            // 뱃지 업데이트
            const badge = document.getElementById('pendingBadge');
            if (pendingAdmins.length > 0) {
                badge.textContent = pendingAdmins.length;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
            
            if (pendingAdmins.length === 0) {
                listEl.innerHTML = '<div class="pending-empty">승인 대기 중인 관리자가 없습니다.</div>';
                return;
            }
            
            listEl.innerHTML = pendingAdmins.map(admin => `
                <div class="pending-item">
                    <div class="pending-info">
                        <div class="pending-name">${admin.name}</div>
                        <div class="pending-id">${admin.id}</div>
                        <div class="pending-date">신청일: ${admin.createdAt || '-'}</div>
                    </div>
                    <div class="pending-actions">
                        <button class="approve-btn" onclick="approveAdmin('${admin.id}')">✅ 승인</button>
                        <button class="reject-btn" onclick="rejectAdmin('${admin.id}')">❌ 거절</button>
                    </div>
                </div>
            `).join('');
        }
        
        // 관리자 승인
        async function approveAdmin(adminId) {
            if (!confirm('이 관리자를 승인할까요?')) return;
            
            // UI 먼저 업데이트
            const admin = adminList.find(a => a.id === adminId);
            if (admin) admin.status = 'approved';
            renderPendingList();
            renderAdminList();
            checkPendingAdmins();
            
            // API 호출
            const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=approveAdmin&adminId=${encodeURIComponent(adminId)}`;
            fetch(url).then(r => r.json()).then(result => {
                if (!result.success) {
                    alert('승인 실패: ' + result.error);
                    loadAdminList();
                }
            }).catch(() => {
                alert('서버 연결 실패');
                loadAdminList();
            });
        }
        
        // 관리자 거절
        async function rejectAdmin(adminId) {
            if (!confirm('이 관리자를 거절할까요?')) return;
            
            // UI 먼저 업데이트
            const admin = adminList.find(a => a.id === adminId);
            if (admin) admin.status = 'rejected';
            renderPendingList();
            checkPendingAdmins();
            
            // API 호출
            const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=rejectAdmin&adminId=${encodeURIComponent(adminId)}`;
            fetch(url).then(r => r.json()).then(result => {
                if (!result.success) {
                    alert('거절 실패: ' + result.error);
                    loadAdminList();
                }
            }).catch(() => {
                alert('서버 연결 실패');
                loadAdminList();
            });
        }
        
        // ========== 워크플로우 모달 ==========
        function showWorkflowModal() {
            document.getElementById('workflowModal').style.display = 'flex';
        }
        
        function closeWorkflowModal() {
            document.getElementById('workflowModal').style.display = 'none';
        }
        
        // 모달 외부 클릭시 닫기
        document.getElementById('workflowModal').addEventListener('click', function(e) {
            if (e.target === this) closeWorkflowModal();
        });

        // ========== 로딩 ==========
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }

        // ========== 🚀 사주 파이프라인 (iframe 자동 변환) ==========
        async function runPipeline() {
            if (selectedCustomer === null) {
                alert('❌ 먼저 고객을 선택해주세요.');
                return;
            }

            const customer = customers[selectedCustomer];

            // ★ "완료" 상태인 고객은 경고 후 확인 받기
            if (customer.status === '완료') {
                const confirmRerun = confirm(
                    '⚠️ 이 고객은 이미 "완료" 상태입니다.\n\n' +
                    '변환시작을 다시 실행하면 사주계산 결과와 프롬프트가 덮어씌워집니다.\n' +
                    '정말 다시 실행하시겠습니까?\n\n' +
                    '(상태는 "완료"로 유지됩니다)'
                );
                if (!confirmRerun) {
                    return;
                }
            }

            // ★ 현재 상태 저장 (완료 상태 보존용)
            const originalStatus = customer.status;

            const isPremium = customer.package === 'premium' || customer.package === '프리미엄';

            console.log('[Pipeline] 고객:', customer.name, '패키지:', customer.package, 'isPremium:', isPremium, '원래상태:', originalStatus);
            
            // 버튼 상태 변경
            const btn = document.getElementById('pipelineBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ 사주 계산 중...';
            btn.disabled = true;
            btn.style.opacity = '0.7';
            
            try {
                // 1. 고객 데이터 준비
                const customerData = {
                    name: customer.name || '',
                    gender: customer.gender === 'male' ? '남' : customer.gender === 'female' ? '여' : customer.gender || '여',
                    // partnerGender: 정확한 값 비교로 변환 (female.includes('male') 버그 수정)
                    partnerGender: (() => {
                        const pg = (customer.partnerGender || '').toLowerCase().trim();
                        // 쉼표로 분리해서 정확히 비교
                        const parts = pg.split(',').map(s => s.trim());
                        const hasMale = parts.includes('male');
                        const hasFemale = parts.includes('female');
                        
                        if (hasMale && hasFemale) return '남자,여자';
                        if (hasMale) return '남자';
                        if (hasFemale) return '여자';
                        // 이미 한글인 경우
                        if (pg.includes('남') && pg.includes('여')) return '남자,여자';
                        if (pg.includes('남')) return '남자';
                        if (pg.includes('여')) return '여자';
                        return pg;
                    })(),
                    birthYear: customer.birthYear || '',
                    birthMonth: customer.birthMonth || '',
                    birthDay: customer.birthDay || '',
                    birthHour: customer.birthHour || '모름',
                    birthMinute: customer.birthMinute || '0',
                    calendarType: customer.calendarType || 'solar',
                    package: customer.package || 'standard',
                    jasiType: customer.jasiType || 'split',
                    main_concern: customer.mainConcern || '',
                    repeat_pattern: customer.repeatPattern || '',
                    custom_question: customer.customQuestion || '',
                    fortune_type: customer.fortuneType ? customer.fortuneType.split(',').map(s => s.trim()) : [],
                    questions: customer.questions ? customer.questions.split(',').map(s => s.trim()).filter(s => s) : [],
                    love_status: customer.loveStatus || '',
                    job_status: customer.jobStatus || '',
                    orderCode: customer.orderCode || ''
                };
                
                // 2. 사주계산기 iframe으로 계산
                const sajuResult = await runSajuCalculator(customerData);
                
                if (!sajuResult.success) {
                    throw new Error('사주 계산 실패: ' + sajuResult.error);
                }
                
                // 사주 결과에서 일주 추출 (인연상 계산용)
                let ilju = null;
                const iljuMatch = sajuResult.result.match(/일주[:\s]*([甲乙丙丁戊己庚辛壬癸][子丑寅卯辰巳午未申酉戌亥])/);
                if (iljuMatch) {
                    ilju = iljuMatch[1];
                }
                console.log('[Pipeline] 일주 추출:', ilju, 'isPremium:', isPremium);
                
                // ★ 프리미엄일 경우: 인연상 계산 + 인연상 이미지 생성
                let inyeonCalcResult = null;
                let inyeonImageResult = null;
                
                if (isPremium && ilju) {
                    console.log('[Pipeline] 인연상 단계 시작!');
                    btn.innerHTML = '⏳ 인연상 계산 중...';
                    
                    // 3. 인연상 계산기 iframe으로 계산
                    // 인연성별 처리: 하나만 선택 (둘 다면 첫 번째 우선)
                    console.log('[Pipeline] 인연성별 원본값:', customer.partnerGender);
                    console.log('[Pipeline] customerData.partnerGender:', customerData.partnerGender);

                    let targetGender = customerData.gender === '남' ? '여' : '남';  // 기본값: 반대 성별
                    if (customerData.partnerGender) {
                        // 남자,여자 둘 다 포함하면 "둘다"
                        if (customerData.partnerGender.includes('남') && customerData.partnerGender.includes('여')) {
                            targetGender = '둘다';
                        } else if (customerData.partnerGender.includes('남')) {
                            targetGender = '남';
                        } else if (customerData.partnerGender.includes('여')) {
                            targetGender = '여';
                        }
                    }
                    console.log('[Pipeline] 최종 targetGender:', targetGender);

                    const inyeonData = {
                        ilju: ilju,
                        myGender: customerData.gender,
                        targetGender: targetGender,
                        inputText: `일주: ${ilju} | 본인성별: ${customerData.gender} | 상대성별: ${targetGender}`
                    };

                    inyeonCalcResult = await runInyeonCalculator(inyeonData);
                    console.log('[Pipeline] 인연상 계산 결과:', inyeonCalcResult.success ? '성공' : inyeonCalcResult.error);
                    
                    if (inyeonCalcResult.success) {
                        btn.innerHTML = '⏳ 인연상 이미지 생성 중...';
                        
                        // 4. 인연상 생성기 iframe으로 이미지 생성
                        inyeonImageResult = await runInyeonGenerator(inyeonCalcResult.result, customer.name);
                        console.log('[Pipeline] 인연상 이미지 결과:', inyeonImageResult.success ? '성공' : inyeonImageResult.error);
                        
                        // 인연상 결과 저장
                        customer.inyeonCalcResult = inyeonCalcResult.result;
                        if (inyeonImageResult.success) {
                            customer.inyeonHTML = inyeonImageResult.result;
                        }
                        
                        // UI 업데이트 (인연상 카드)
                        document.getElementById('inyeonCalcResultText').value = inyeonCalcResult.result;
                        document.getElementById('inyeonCalcEmpty').style.display = 'none';
                        document.getElementById('inyeonCalcContent').style.display = 'block';
                        
                        if (inyeonImageResult.success) {
                            document.getElementById('inyeonHTMLText').value = inyeonImageResult.result;
                            document.getElementById('inyeonImageEmpty').style.display = 'none';
                            document.getElementById('inyeonImageContent').style.display = 'block';
                        }
                    } else {
                        console.warn('인연상 계산 실패:', inyeonCalcResult.error);
                    }
                }
                
                btn.innerHTML = '⏳ 프롬프트 생성 중...';
                
                // 5. 프롬프트생성기 iframe으로 프롬프트 생성 (인연상 결과 포함)
                const promptResult = await runPromptGenerator(sajuResult.result, inyeonCalcResult);
                
                if (!promptResult.success) {
                    throw new Error('프롬프트 생성 실패: ' + promptResult.error);
                }
                
                btn.innerHTML = '⏳ 저장 중...';

                // 6. Google Sheets 저장 (결과 대기)
                const savePromises = [
                    saveToGoogleSheets(customer, 'sajuResult', sajuResult.result),
                    saveToGoogleSheets(customer, 'promptResult', promptResult.result)
                ];

                // 프리미엄: 인연상 결과도 저장
                if (isPremium && inyeonCalcResult && inyeonCalcResult.success) {
                    savePromises.push(saveToGoogleSheets(customer, 'inyeonCalcResult', inyeonCalcResult.result));
                }
                if (isPremium && inyeonImageResult && inyeonImageResult.success) {
                    savePromises.push(saveToGoogleSheets(customer, 'inyeonHTML', inyeonImageResult.result));
                }

                // 모든 저장 완료 대기
                const saveResults = await Promise.allSettled(savePromises);
                const failedSaves = saveResults.filter(r => r.status === 'rejected');
                if (failedSaves.length > 0) {
                    console.warn('일부 저장 실패:', failedSaves);
                }

                // 7. UI 업데이트
                document.getElementById('sajuResultText').value = sajuResult.result;
                document.getElementById('sajuResultEmpty').style.display = 'none';
                document.getElementById('sajuResultContent').style.display = 'block';
                
                // 프롬프트 통합 표시 (V6)
                document.getElementById('promptResultFull').value = promptResult.result || '';
                document.getElementById('promptResultText').value = promptResult.result;
                document.getElementById('promptResultEmpty').style.display = 'none';
                document.getElementById('promptResultContent').style.display = 'block';
                
                // customer 객체 업데이트
                customer.sajuResult = sajuResult.result;
                customer.promptResult = promptResult.result;

                // ★ 원래 상태 유지 (완료 상태가 변경되지 않도록 보장)
                if (originalStatus === '완료') {
                    customer.status = '완료';
                    console.log('[Pipeline] ★ 완료 상태 유지됨');
                }

                // localStorage 즉시 저장 (상태 포함)
                localStorage.setItem('saju_customers', JSON.stringify(customers));

                // ★ Supabase에도 사주결과/프롬프트 저장
                supabaseUpdateCustomer(customer.orderCode, {
                    sajuResult: sajuResult.result,
                    promptResult: promptResult.result,
                    status: customer.status
                }).then(() => console.log('⚡ Supabase 변환결과 동기화 완료'));
                
                // 8. 전체 프롬프트 클립보드 복사 (V6: 통합)
                let clipboardSuccess = false;
                try {
                    await navigator.clipboard.writeText(promptResult.result);
                    clipboardSuccess = true;
                } catch (clipErr) {
                    console.warn('클립보드 복사 실패 (모바일 제한):', clipErr);
                }
                
                // 9. 진행 상태 업데이트
                updateProgressCard(customer);
                
                // 10. 완료 알림
                btn.innerHTML = '✅ 변환 완료!';
                btn.style.background = 'linear-gradient(135deg, #4a7c59 0%, #6b9b7a 100%)';
                
                setTimeout(() => {
                    let message = '✅ 변환 완료!\n\n📋 사주계산 결과 저장됨\n';
                    if (isPremium && inyeonCalcResult && inyeonCalcResult.success) {
                        message += '💘 인연상 계산 완료\n';
                        if (inyeonImageResult && inyeonImageResult.success) {
                            message += '🎨 인연상 이미지 생성 완료\n';
                        }
                    }
                    message += '📝 프롬프트 저장됨\n';

                    // 저장 실패 경고
                    if (failedSaves.length > 0) {
                        message += '\n⚠️ 일부 데이터 저장 실패 (' + failedSaves.length + '건)\n새로고침 후 다시 시도해주세요.\n';
                    }

                    if (clipboardSuccess) {
                        message += '📎 프롬프트가 클립보드에 복사되었습니다.\n\nClaude에 바로 붙여넣기 하세요! 🚀';
                    } else {
                        message += '\n⚠️ 모바일에서는 자동 복사가 안 돼요.\n아래 [전체 복사] 버튼을 눌러주세요!';
                    }
                    alert(message);
                }, 100);
                
            } catch (error) {
                console.error('Pipeline error:', error);
                alert('❌ 변환 중 오류 발생:\n' + error.message);
                btn.innerHTML = originalText;
                btn.style.background = 'linear-gradient(135deg, #8b6914 0%, #c49b30 100%)';
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
                
                // 3초 후 버튼 원래대로
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(135deg, #8b6914 0%, #c49b30 100%)';
                }, 3000);
            }
        }
        
        // 사주계산기 iframe 호출
        function runSajuCalculator(customerData) {
            return new Promise((resolve, reject) => {
                // iframe 생성
                const iframe = document.createElement('iframe');
                iframe.src = '2_saju.html';
                iframe.style.cssText = 'position:absolute; left:-9999px; width:1px; height:1px;';
                document.body.appendChild(iframe);
                
                // 메시지 리스너
                const messageHandler = (event) => {
                    if (event.data && event.data.action === 'sajuResult') {
                        window.removeEventListener('message', messageHandler);
                        setTimeout(() => iframe.remove(), 1000);
                        resolve(event.data);
                    }
                };
                window.addEventListener('message', messageHandler);
                
                // iframe 로드 후 데이터 전송
                iframe.onload = () => {
                    setTimeout(() => {
                        iframe.contentWindow.postMessage({
                            action: 'calculateSaju',
                            customerData: customerData
                        }, '*');
                    }, 300);
                };
                
                // 타임아웃 (30초)
                setTimeout(() => {
                    window.removeEventListener('message', messageHandler);
                    iframe.remove();
                    reject(new Error('사주 계산 타임아웃'));
                }, 30000);
            });
        }
        
        // 프롬프트생성기 iframe 호출
        function runPromptGenerator(sajuResultText, inyeonCalcResult) {
            return new Promise((resolve, reject) => {
                // iframe 생성
                const iframe = document.createElement('iframe');
                iframe.src = '5_prompt.html?v=' + Date.now();
                iframe.style.cssText = 'position:absolute; left:-9999px; width:1px; height:1px;';
                document.body.appendChild(iframe);
                
                // 메시지 리스너
                const messageHandler = (event) => {
                    if (event.data && event.data.action === 'promptResult') {
                        window.removeEventListener('message', messageHandler);
                        setTimeout(() => iframe.remove(), 1000);
                        resolve(event.data);
                    }
                };
                window.addEventListener('message', messageHandler);
                
                // iframe 로드 후 데이터 전송
                iframe.onload = () => {
                    setTimeout(() => {
                        iframe.contentWindow.postMessage({
                            action: 'generatePrompt',
                            sajuResultText: sajuResultText,
                            inyeonCalcResult: inyeonCalcResult?.success ? inyeonCalcResult.result : null
                        }, '*');
                    }, 300);
                };
                
                // 타임아웃 (30초)
                setTimeout(() => {
                    window.removeEventListener('message', messageHandler);
                    iframe.remove();
                    reject(new Error('프롬프트 생성 타임아웃'));
                }, 30000);
            });
        }
        
        // 인연상 계산기 iframe 호출
        function runInyeonCalculator(inyeonData) {
            return new Promise((resolve, reject) => {
                // iframe 생성
                const iframe = document.createElement('iframe');
                iframe.src = '3_inyeon_calc.html';
                iframe.style.cssText = 'position:absolute; left:-9999px; width:1px; height:1px;';
                document.body.appendChild(iframe);
                
                // 메시지 리스너
                const messageHandler = (event) => {
                    if (event.data && event.data.action === 'inyeonCalcResult') {
                        window.removeEventListener('message', messageHandler);
                        setTimeout(() => iframe.remove(), 1000);
                        resolve(event.data);
                    }
                };
                window.addEventListener('message', messageHandler);
                
                // iframe 로드 후 데이터 전송
                iframe.onload = () => {
                    setTimeout(() => {
                        iframe.contentWindow.postMessage({
                            action: 'calculateInyeon',
                            inyeonData: inyeonData
                        }, '*');
                    }, 300);
                };
                
                // 타임아웃 (30초)
                setTimeout(() => {
                    window.removeEventListener('message', messageHandler);
                    iframe.remove();
                    resolve({ success: false, error: '인연상 계산 타임아웃' });
                }, 30000);
            });
        }
        
        // 인연상 생성기 iframe 호출
        function runInyeonGenerator(jsonText, customerName) {
            return new Promise((resolve, reject) => {
                // iframe 생성
                const iframe = document.createElement('iframe');
                iframe.src = '4_inyeon_gen.html';
                iframe.style.cssText = 'position:absolute; left:-9999px; width:1px; height:1px;';
                document.body.appendChild(iframe);
                
                // 메시지 리스너
                const messageHandler = (event) => {
                    if (event.data && event.data.action === 'inyeonImageResult') {
                        window.removeEventListener('message', messageHandler);
                        setTimeout(() => iframe.remove(), 1000);
                        resolve(event.data);
                    }
                };
                window.addEventListener('message', messageHandler);
                
                // iframe 로드 후 데이터 전송
                iframe.onload = () => {
                    setTimeout(() => {
                        iframe.contentWindow.postMessage({
                            action: 'generateInyeonImage',
                            jsonText: jsonText,
                            customerName: customerName || ''
                        }, '*');
                    }, 300);
                };
                
                // 타임아웃 (30초)
                setTimeout(() => {
                    window.removeEventListener('message', messageHandler);
                    iframe.remove();
                    resolve({ success: false, error: '인연상 이미지 생성 타임아웃' });
                }, 30000);
            });
        }

        // Google Sheets 저장 헬퍼 함수 (POST 방식 - 긴 데이터 지원)
        async function saveToGoogleSheets(customer, field, value) {
            if (!customer || !customer._rowIndex) return;
            
            const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=updateLongField&rowIndex=${customer._rowIndex}&field=${field}`;
            return fetch(url, {
                method: 'POST',
                body: value
            });
        }
        
        // ========== 관리자 메모 ==========
        function updateMemoCard(customer) {
            const input = document.getElementById('customerMemo');
            const badge = document.getElementById('memoSaveStatus');
            
            if (customer.memo && customer.memo.trim()) {
                input.value = customer.memo;
                badge.textContent = '✓';
                badge.style.color = '#7cb88a';
            } else {
                input.value = '';
                badge.textContent = '-';
                badge.style.color = '#a89068';
            }
        }
        
        async function saveMemo() {
            if (selectedCustomer === null) return;
            const customer = customers[selectedCustomer];
            const memo = document.getElementById('customerMemo').value.trim();
            const badge = document.getElementById('memoSaveStatus');
            
            // 변경 없으면 스킵
            if (memo === (customer.memo || '')) return;
            
            // UI 먼저 업데이트
            badge.textContent = '...';
            badge.style.color = '#f9a825';
            
            // 로컬 데이터 업데이트
            customer.memo = memo;
            localStorage.setItem('saju_customers', JSON.stringify(customers));
            
            // Google Sheets에 저장
            try {
                const url = `${SAJU_CONFIG.googleSheets.webAppUrl}?action=updateCustomer&rowIndex=${customer._rowIndex}&field=memo&value=${encodeURIComponent(memo)}`;
                await fetch(url);
                badge.textContent = memo ? '✓' : '-';
                badge.style.color = memo ? '#7cb88a' : '#a89068';

                // ★ Supabase도 동시에 업데이트
                supabaseUpdateCustomer(customer.orderCode, { memo });
            } catch (error) {
                console.error('메모 저장 실패:', error);
                badge.textContent = '✗';
                badge.style.color = '#e57373';
            }
        }
        
        function clearMemo() {
            if (!confirm('메모를 삭제할까요?')) return;
            document.getElementById('customerMemo').value = '';
            saveMemo();
        }
    </script>
</body>
</html>
