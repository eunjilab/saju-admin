# 사주 프로젝트 실행현황

> 마지막 업데이트: 2026-01-24

---

## 현재 작업: MD 자동생성 시스템

### 완료된 작업 ✅

#### Supabase 설정
- [x] Supabase MCP 연결 완료
  - 플러그인: `plugin:supabase:supabase`
  - 프로젝트: `saju-admin` (hvxacycvwfwhzfqftscx)
- [x] `customers` 테이블에 MD 컬럼 추가 (마이그레이션 완료)
  - `md_status`, `md_message`, `md_result`, `md_verify_result`, `md_updated_at`, `md_generated_at`
- [x] 테이블 통일: `orders` → `customers` (customers가 메인, 61개 데이터)

#### Google Apps Script
- [x] `updateMdResult` 액션 추가 (Code.js 1379-1418번 줄)
- [x] clasp 설정 완료 (코드 푸시/배포 CLI)
- [x] Apps Script 배포 완료 (v70)
- [x] **계정 이전 및 권한 오류 수정** (2026-01-21)
  - 소유 계정: plizlisttreeandflower@gmail.com
  - Code.js 수정: `getActiveSpreadsheet()` → `openById(SPREADSHEET_ID)` (40+ 곳)
  - SPREADSHEET_ID: `'1GLYRASMcdiIgf11rbzgXwZixtjD7AFnkxT0F3wWIgdM'`
- [x] 배포 URL: `https://script.google.com/macros/s/AKfycbzRYF_BnoFi8A-tNlGmLUTKWrIH_1NdUPctVigEwGD52kqf1spt4ryOUurLRoJTirIu7Q/exec`

#### Netlify
- [x] 환경변수 설정 완료 (2026-01-18 수정)
  - `SUPABASE_URL`: https://hvxacycvwfwhzfqftscx.supabase.co ✅ (수정됨)
  - `SUPABASE_KEY`: (ANON KEY) ✅ (수정됨)
  - `GEMINI_API_KEY`: AIzaSyA9BrQFW67xyFM10QJA-gsqV6jQMWkM5gU
  - `GOOGLE_APPS_SCRIPT_URL`: (위 URL)

#### 코드 수정
- [x] `generate-md-background.js` 수정
  - Anthropic → Gemini API로 변경
  - `promptResult` 우선 사용 (fallback 제거)
  - `orders` → `customers` 테이블로 변경
- [x] `index.html` 수정
  - `promptResult` 없으면 MD 생성 불가
  - 인연상 결과 Supabase 저장 추가 (`inyeonCalcResult`, `inyeonHTML`)
  - MD 폴링 시 `customers` 테이블 조회

---

### 해결된 문제점

#### 1. Supabase 테이블 불일치 ✅
- **문제**: `customers`(61개)와 `orders`(0개) 테이블이 분리됨
- **해결**: `customers` 테이블에 MD 컬럼 추가, 코드에서 `orders` → `customers`로 변경

#### 2. 인연상 결과 저장 안 됨 ✅
- **문제**: Supabase 업데이트 시 `inyeonCalcResult`, `inyeonHTML` 누락
- **해결**: `index.html` 8363-8377번 줄에 인연상 저장 코드 추가

#### 3. MD 생성 시 잘못된 프롬프트 사용 ✅
- **문제**: `sajuResult`를 fallback으로 사용
- **해결**: `promptResult`만 사용, 없으면 생성 불가

#### 4. Apps Script 권한 오류 ✅ (2026-01-21)
- **문제**: `SpreadsheetApp.getActiveSpreadsheet()` 권한 오류, 엑셀 데이터 조회 불가
- **원인**: 계정 변경 필요 + 잘못된 스프레드시트 접근 방식
- **해결**:
  - Apps Script 계정 이전 (beautamin1 → plizlisttreeandflower)
  - Code.js 수정: `getActiveSpreadsheet()` → `openById(SPREADSHEET_ID)` (40+ 곳)
  - SPREADSHEET_ID 상수 추가
- **결과**: 62명 고객 데이터 정상 조회

#### 5. Supabase 숫자 필드 빈 문자열 오류 ✅ (2026-01-21)
- **문제**: `invalid input syntax for type numeric: ""` - 새로고침 시 400 에러 반복
- **원인**: `birth_hour`, `birth_minute`, `phone` 등 숫자 필드에 빈 문자열("") 저장 시도
- **해결**: `convertToSupabaseFormat` 함수에 숫자 필드 빈 문자열 검증 추가
- **결과**: Supabase 동기화 에러 0개, 62건 정상 동기화

#### 6. 새로고침 시 결과 데이터 초기화 버그 ✅ (2026-01-22)
- **문제**: 변환시작으로 생성한 사주계산결과, 인연상, 프롬프트 등이 새로고침하면 사라짐
- **원인**: `syncSheetsToSupabase()` 함수가 Google Sheets 데이터로 Supabase 덮어씀
  - Google Sheets에는 결과 데이터가 없거나 오래된 상태
  - 그 데이터로 Supabase의 최신 결과를 덮어써버림
- **해결**: `syncSheetsToSupabase`에서 결과 데이터 필드 동기화 제외
  - 제외된 필드: `status`, `paymentStatus`, `paymentDate` (상태)
  - 제외된 필드: `sajuResult`, `promptResult`, `inyeonCalcResult`, `inyeonHTML` (변환 결과)
  - 제외된 필드: `mdResult`, `mdStatus`, `mdMessage`, `mdVerifyResult` (MD 결과)
  - 제외된 필드: `mainResultText`, `resultUrl`, `additionalResultText`, `additionalResultUrl` (기타 결과)
- **결과**: 새로고침해도 결과 데이터 유지됨
- **배포 완료**: 2026-01-22

#### 7. 프롬프트 해석 규칙 추가 ✅ (2026-01-23)
- **파일**: `/사주/앱/5_prompt.html`
- **추가 내용**: 프롬프트 맨 앞에 "해석 전 필수 규칙" 섹션 추가
  - 스킬 파일 먼저 읽기 (09_종합해석_원칙.md)
  - 데이터 우선순위 (프롬프트 > 스킬 파일)
  - 종합 해석 원칙 (상충되면 둘 다 언급)
  - 카테고리별 필수 체크 (격국/십성/신살/상충점)
- **배포 완료**: 2026-01-23

#### 8. 종합해석 원칙 가이드 통합 ✅ (2026-01-23)
- **파일**: `/사주/가이드/09_종합해석_원칙.md`
- **작업**: Downloads 버전 + 프로젝트 버전 합치기
- **Downloads에서 가져온 것**:
  - 데이터 우선순위 (프롬프트 > 스킬 파일)
  - 월운/신살 해석 규칙
  - 건강운 체크리스트
  - 해석 템플릿
- **프로젝트에서 유지한 것**:
  - 실전 적용 예시 (신광민 케이스)
  - 자주 상충하는 조합 3가지
  - 절대 금지 예시
  - 고급 팁
- **결과**: 382줄 통합 파일 완성 (14개 섹션)

---

### 다음 할 일
- [x] Supabase 테이블 구조 확인
- [x] 테이블 통일 - `customers`에 MD 컬럼 추가
- [x] 코드 수정 - `orders` → `customers`
- [x] **변경사항 배포** ✅ (2026-01-17 20:15 성공!)
- [x] **MD 생성 버튼 테스트** ⚠️ (2026-01-18 실행했으나 Gemini API 할당량 초과로 실패 - 신동욱 고객, 6/7 섹션 생성 후 중단)
- [x] 인연상 저장 코드 확인 ✅ (코드 정상, 변환시작 다시 실행 필요)
- [x] 자동 기록 훅 생성 ✅ (PostToolUse 훅 추가)
- [x] **재시도 로직 추가** ✅ (2026-01-20 배포 완료: 429 에러 시 최대 3번 재시도, 1분/2분/3분 대기)
- [x] **Apps Script 계정 이전 및 권한 오류 해결** ✅ (2026-01-21)
  - beautamin1@gmail.com → plizlisttreeandflower@gmail.com
  - Code.js 수정: `getActiveSpreadsheet()` → `openById(SPREADSHEET_ID)` (40+ 곳)
  - 엑셀 데이터 정상 조회 가능
- [x] **Supabase 숫자 필드 오류 수정** ✅ (2026-01-21)
  - `convertToSupabaseFormat` 함수에 빈 문자열 검증 추가
  - `invalid input syntax for type numeric: ""` 오류 해결
  - 62건 정상 동기화 완료
- [ ] MD 생성 재테스트 (재시도 로직으로 성공하는지 확인)
- [ ] 변환시작 재테스트 (프리미엄 고객으로 인연상 저장 확인)
- [ ] **입력폼 신규 신청 테스트** (Supabase 자동 저장 확인)
- [x] **🔴 프롬프트 필수 참조 파일 확인 필요** ✅ (2026-01-24 해결!)
  - `good_example_premium_v5.md` 분석 완료 → 08_프리미엄_해석방법.md에 톤앤매너 패턴 추가
  - `inyeon_guide_v8.md` 분석 완료 → 10_인연상_가이드.md 신규 생성
  - 5_prompt.html 프롬프트에도 톤앤매너 규칙 및 인연상 가이드 참조 추가
  - **결론**: 원본 파일 대신 스킬 파일로 핵심 패턴 반영 완료
- [x] **🔴 성명학 한자 임의 예측 문제** ✅ (2026-01-23)
  - 문제: MD 생성 시 성명학 해석에서 한자를 임의로 예측/추측함
  - **해결**: 5_prompt.html에 "한자 임의 추측 금지" 규칙 추가
  - 한글 초성/발음 기반 분석만 허용
- [x] **부정적 표현 교차검증 규칙 추가** ✅ (2026-01-23)
  - **수정사항.md 적용 완료**
  - 09_종합해석_원칙.md: "피해야 할 것" 작성 전 신살 체크 규칙
  - 5_prompt.html: 부정적 표현 3초 멈추기 규칙
  - 08_프리미엄_해석방법.md: 직업운 교차검증 체크리스트

---

## 수정된 파일 목록

| 파일 | 수정 내용 |
|------|----------|
| `앱/index.html` | promptResult 필수 체크, 인연상 Supabase 저장, orders→customers, **숫자 필드 빈 문자열 검증 추가 (2026-01-21)** |
| `앱/netlify/functions/generate-md-background.js` | Gemini API, promptResult 사용, orders→customers, 모델명 수정 (gemini-2.0-flash), Supabase 저장 실패 시 에러 처리, **재시도 로직 추가 (429 에러 시 최대 3번 재시도)** |
| `apps-script/Code.js` | updateMdResult 액션 추가, **권한 오류 수정 (getActiveSpreadsheet → openById, 2026-01-21)** |
| `.claude/CLAUDE.md` | API 키 + 오류해결 + 맥 명령어 통합 (API_KEYS.md, 오류해결.md 삭제됨) |
| `.claude/settings.json` | PostToolUse 훅 추가 (auto-record.sh) |
| `.claude/hooks/auto-record.sh` | 사주 프로젝트 파일 수정 시 실행현황.md 업데이트 알림 |

---

## 시스템 구조 요약

### 데이터 흐름
```
1_input.html (고객 신청)
    ↓
index.html "변환시작" 클릭
    ↓
┌─────────────────────────────────────┐
│  자동 파이프라인 (iframe)            │
│  1. 2_saju.html → sajuResult        │
│  2. 3_inyeon_calc.html → inyeonCalcResult (프리미엄)
│  3. 4_inyeon_gen.html → inyeonHTML (프리미엄)
│  4. 5_prompt.html → promptResult    │
└─────────────────────────────────────┘
    ↓
저장: Google Sheets + Supabase (customers 테이블)
    ↓
Step 6: MD 생성 버튼 클릭
    ↓
┌─────────────────────────────────────┐
│  generate-md-background.js          │
│  - promptResult를 Gemini API에 전달  │
│  - 7개 섹션 순차 생성                │
│  - 검증 후 저장                      │
└─────────────────────────────────────┘
    ↓
결과: Supabase (customers.md_result) + Google Sheets (mdResult)
```

### 저장소 구조
| 저장소 | 테이블/시트 | 용도 | 데이터 수 |
|--------|------------|------|----------|
| Google Sheets | 시트1 | 원본 데이터 | - |
| Supabase | customers | 고객+MD 데이터 (메인) | 61개 |
| Supabase | orders | 미사용 | 0개 |
| Supabase | admins | 관리자 계정 | 0개 |
| Supabase | settings | 설정 | 1개 |

---

## 환경 정보

### API 키 위치
`.claude/API_KEYS.md` 참조

### 배포 명령어
```bash
# 관리자페이지 배포
cd 사주 && npx netlify deploy --prod

# Apps Script 푸시/배포
cd 사주/apps-script
npx clasp push
npx clasp deploy
```

### MCP 서버
```bash
# 현재 연결된 MCP
claude mcp list

# Supabase 테이블 확인 (Claude Code 내에서)
# mcp__plugin_supabase_supabase__list_tables 도구 사용
```

---

## 변경 이력

| 날짜 | 시간 | 변경 내용 |
|------|------|----------|
| 2026-01-24 | 오후 | **2️⃣0️⃣ good_example_premium_v5.md 원본 파일 분석 완료** |
| 2026-01-24 | - | - **파일**: `운명을듣다 결과지 생성_프리미엄 원본 생성파일/good_example_premium_v5.md` |
| 2026-01-24 | - | - **크기**: 42,691자 (약 43KB, 42-46페이지 분량) |
| 2026-01-24 | - | - **인코딩 해결**: ftfy 패키지 설치하여 깨진 글자 복구 |
| 2026-01-24 | - | - **핵심 패턴 1: HTML 주석 태그 시스템** (감정 흐름 제어) |
| 2026-01-24 | - |   → `<!-- 공감 -->`: "이런 적 있죠?" 공감 유도 |
| 2026-01-24 | - |   → `<!-- 왜그런지 -->`: 명리학적 근거 설명 |
| 2026-01-24 | - |   → `<!-- 주의 -->`: 주의사항 |
| 2026-01-24 | - |   → `<!-- 희망 -->`: 희망적 메시지 |
| 2026-01-24 | - |   → `<!-- 조언 -->`: 실질적 조언 |
| 2026-01-24 | - |   → `<!-- 마무리멘트 -->`, `<!-- 올해핵심 -->`, `<!-- 테마색상 -->`, `<!-- 리마인더 -->` |
| 2026-01-24 | - | - **핵심 패턴 2: 문체** |
| 2026-01-24 | - |   → 종결어미: "~예요", "~거든요", "~있죠?", "~거예요" (친근) |
| 2026-01-24 | - |   → 공감 유도: "이런 적 있죠?", "맞아요. 그게 바로~" |
| 2026-01-24 | - | - **핵심 패턴 3: 공감 포인트 4개 형식** |
| 2026-01-24 | - |   → 각각 "~있죠?"로 질문 후 "맞아요. 그게 바로~"로 설명 |
| 2026-01-24 | - | - **핵심 패턴 4: 오행 막대그래프 (텍스트 아트)** |
| 2026-01-24 | - |   → `화(火) ████████████████████████ 5.9개 ⭐ 최강` |
| 2026-01-24 | - | - **핵심 패턴 5: 감정 흐름 순서** |
| 2026-01-24 | - |   → 공감 → 왜그런지(분석) → 주의점 → 희망 → 조언 |
| 2026-01-24 | - | - **용도**: 스킬 파일만으로 원본 느낌이 안 나는 문제 해결을 위한 참고 자료 |
| 2026-01-24 | - | - **상태**: ✅ 분석 완료 |
| 2026-01-24 | 오후 | **2️⃣1️⃣ 스킬 파일 강화 (톤앤매너 + 인연상 가이드)** |
| 2026-01-24 | - | - **목적**: 스킬 파일만으로 원본 느낌이 안 나는 문제 해결 |
| 2026-01-24 | - | - **작업 1**: 08_프리미엄_해석방법.md 강화 |
| 2026-01-24 | - |   → 섹션 5 "톤앤매너 핵심 패턴" 추가 |
| 2026-01-24 | - |   → HTML 주석 태그 시스템 (`<!-- 공감 -->`, `<!-- 왜그런지 -->` 등) |
| 2026-01-24 | - |   → 문체 규칙 ("~예요", "~거든요") |
| 2026-01-24 | - |   → 공감 포인트 4개 형식 |
| 2026-01-24 | - |   → 오행 막대그래프 (텍스트 아트) |
| 2026-01-24 | - |   → 감정 흐름 순서 (공감→분석→주의→희망→조언) |
| 2026-01-24 | - |   → 섹션 6 "톤앤매너 체크리스트" 추가 |
| 2026-01-24 | - | - **작업 2**: 10_인연상_가이드.md 신규 생성 |
| 2026-01-24 | - |   → 인연상 vs 배우자상 도출 공식 |
| 2026-01-24 | - |   → 오행 상생 테이블, 대표 지지 매핑 |
| 2026-01-24 | - |   → 육합 매칭표 (인연상 성격 도출용) |
| 2026-01-24 | - |   → 궁합 유형 A/B/C/D 분류표 |
| 2026-01-24 | - |   → 12지지별 성격 특성 (子~亥) |
| 2026-01-24 | - |   → 작성 템플릿 및 필수 체크리스트 |
| 2026-01-24 | - |   → 금지 표현 목록 (띠 언급 금지 등) |
| 2026-01-24 | - | - **원본 참조**: |
| 2026-01-24 | - |   → good_example_premium_v5.md (42,691자) |
| 2026-01-24 | - |   → inyeon_guide_v8.md (21,416자) |
| 2026-01-24 | - | - **스킬 파일 현황**: 01~10 (총 10개) |
| 2026-01-24 | - | - **상태**: ✅ 완료 |
| 2026-01-24 | 오후 | **2️⃣2️⃣ 5_prompt.html 프롬프트 업데이트** |
| 2026-01-24 | - | - **목적**: 새 스킬 파일(08 강화, 10 신규)에 맞춰 프롬프트 동기화 |
| 2026-01-24 | - | - **수정 1**: 스킬 파일 테이블 업데이트 |
| 2026-01-24 | - |   → 08 설명 강화: "해석 방법 + ⭐톤앤매너" |
| 2026-01-24 | - |   → 10_인연상_가이드.md 추가 (프리미엄 필수) |
| 2026-01-24 | - | - **수정 2**: 톤앤매너 필수 규칙 섹션 추가 |
| 2026-01-24 | - |   → HTML 주석 태그 5종 사용법 |
| 2026-01-24 | - |   → 문체 규칙 (~예요/~거든요) |
| 2026-01-24 | - |   → 공감 포인트 4개 형식 |
| 2026-01-24 | - |   → 오행 막대그래프 형식 |
| 2026-01-24 | - |   → 감정 흐름 순서 |
| 2026-01-24 | - | - **수정 3**: 인연상 섹션 강화 |
| 2026-01-24 | - |   → 10_인연상_가이드.md 참조 명시 |
| 2026-01-24 | - |   → 외모/성격 도출 공식 안내 |
| 2026-01-24 | - |   → 띠 언급 금지 강조 |
| 2026-01-24 | - |   → 필수 체크리스트 (외모/성격 분리표, 궁합유형, 마무리문구) |
| 2026-01-24 | - | - **배포 완료**: ✅ https://saju-admin.netlify.app
| 2026-01-24 | 오후 | **2️⃣4️⃣ 태어난곳 스텝2/스텝5 전달 문제 - 🔴 미해결** |
| 2026-01-24 | - | - **문제**: 스텝1에서는 "대전광역시, KR"로 나오지만, 스텝2 결과에서는 "서울"로 표시됨 |
| 2026-01-24 | - | - **Supabase 데이터 확인**: |
| 2026-01-24 | - |   → birth_city="대전광역시", birth_country="KR" ✅ |
| 2026-01-24 | - |   → custom_longitude=127.384902, custom_utc_offset=9 |
| 2026-01-24 | - | - **시도한 수정 1**: getLocationInfo에서 도시명 부분 매칭 추가 |
| 2026-01-24 | - |   → "대전광역시".includes("대전") 체크 |
| 2026-01-24 | - |   → 결과: ❌ 안 됨 |
| 2026-01-24 | - | - **시도한 수정 2**: 국가 코드 XX일 때 한국 도시에서 찾기 |
| 2026-01-24 | - |   → GLOBAL_CITIES['KR'].cities에서 도시명 검색 |
| 2026-01-24 | - |   → 결과: ❌ 안 됨 |
| 2026-01-24 | - | - **시도한 수정 3**: solarTimeText 기본값 수정 |
| 2026-01-24 | - |   → 시간 "모름"이어도 locationInfo 사용하도록 변경 |
| 2026-01-24 | - |   → 결과: ❌ 안 됨 |
| 2026-01-24 | - | - **시도한 수정 4**: customLng 있어도 birthCity 유지 |
| 2026-01-24 | - |   → customLng !== null && city && city !== '서울' 조건 추가 |
| 2026-01-24 | - |   → 결과: ❌ 안 됨 |
| 2026-01-24 | - | - **핵심 문제**: customLongitude가 저장되어 있으면 getLocationInfo에서 CUSTOM 모드로 처리됨 |
| 2026-01-24 | - | - **추가 확인 필요**: |
| 2026-01-24 | - |   → parseTextFormat에서 birthCity가 제대로 파싱되는지? |
| 2026-01-24 | - |   → calculateFromJSON에서 data.birthCity가 제대로 전달되는지? |
| 2026-01-24 | - |   → 브라우저 캐시 문제인지? (Cmd+Shift+R 후에도 안 되는지?) |
| 2026-01-24 | - | - **파일 수정**: 2_saju.html (getLocationInfo 함수 4번 수정) |
| 2026-01-24 | - | - **배포**: 4회 배포함 |
| 2026-01-24 | - | - **상태**: 🔴 미해결 - 디버깅 필요 |
| 2026-01-24 | 오후 | **2️⃣3️⃣ 관리자페이지에 태어난곳 필드 추가** |
| 2026-01-24 | - | - **문제**: 입력폼에서 받은 태어난곳(birthCountry, birthCity)이 관리자페이지에서 안 보임 |
| 2026-01-24 | - | - **수정 파일**: index.html |
| 2026-01-24 | - | - **수정 1: 편집 모달** |
| 2026-01-24 | - |   → 기본 정보 섹션에 "태어난 나라", "태어난 도시" 입력 필드 추가 |
| 2026-01-24 | - |   → openEditModal 함수에 birthCountry, birthCity 로드 추가 |
| 2026-01-24 | - |   → saveCustomerEdit 함수에 birthCountry, birthCity 저장 추가 |
| 2026-01-24 | - | - **수정 2: 고객 상세 표시** |
| 2026-01-24 | - |   → 생년월일 아래에 📍 태어난곳 표시 추가 (detailBirthplace) |
| 2026-01-24 | - |   → showCustomerDetail 함수에 birthplace 표시 로직 추가 |
| 2026-01-24 | - | - **표시 형식**: 📍 서울, KR (도시, 나라 순) |
| 2026-01-24 | - | - **수정 3: 2_saju.html (스텝1 기본정보)** |
| 2026-01-24 | - |   → customerInfo 표시에 "태어난 곳" 항목 추가 |
| 2026-01-24 | - | - **배포 완료**: ✅ https://saju-admin.netlify.app |
| 2026-01-23 | 오후 | **1️⃣9️⃣ 양/음 기운 분포 기능 추가** |
| 2026-01-23 | - | - **문제**: 사주계산 결과에 양/음 기운 분포가 없었음 |
| 2026-01-23 | - | - **수정 파일**: |
| 2026-01-23 | - |   → 2_saju.html: 양/음 계산 로직 + 결과 출력 추가 |
| 2026-01-23 | - |   → 5_prompt.html: 양/음 입력 필드 + 파싱 + 프롬프트 포함 |
| 2026-01-23 | - | - **계산 방식**: 사주팔자 8글자의 양/음 개수 (양천간+양지지 vs 음천간+음지지) |
| 2026-01-23 | - | - **출력 형식**: 양 N개 : 음 M개 + 에너지 특성 |
| 2026-01-23 | - | - **배포 완료**: ✅ |
| 2026-01-23 | 오후 | **1️⃣8️⃣ 부정적 표현 교차검증 규칙 추가** |
| 2026-01-23 | - | - **배경**: 격국/십성만 보고 "조직 안 맞아요" 단정하는 실수 방지 |
| 2026-01-23 | - | - **수정 파일 3개**: |
| 2026-01-23 | - |   → 09_종합해석_원칙.md: "피해야 할 것" 작성 전 신살 체크 규칙 |
| 2026-01-23 | - |   → 5_prompt.html: 부정적 표현 3초 멈추기 규칙 |
| 2026-01-23 | - |   → 08_프리미엄_해석방법.md: 직업운 교차검증 체크리스트 |
| 2026-01-23 | - | - **핵심**: 양인살/장성살/협록/반안살 있으면 단정적 부정 표현 금지 |
| 2026-01-23 | - | - **배포 완료**: ✅ |
| 2026-01-23 | 오후 | **1️⃣7️⃣ 성명학 한자 임의 예측 금지** |
| 2026-01-23 | - | - **문제**: MD 생성 시 고객 이름 한자를 임의로 추측 (치명적!) |
| 2026-01-23 | - | - **해결**: 5_prompt.html에 "한자 임의 추측 금지" 규칙 추가 |
| 2026-01-23 | - | - **허용**: 한글 초성/발음 기반 분석만 |
| 2026-01-23 | - | - **배포 완료**: ✅ |
| 2026-01-23 | 오후 | **1️⃣6️⃣ 종합해석 원칙 가이드 통합** |
| 2026-01-23 | - | - **작업**: Downloads 버전 + 프로젝트 버전 합치기 |
| 2026-01-23 | - | - **Downloads에서 가져올 것**: |
| 2026-01-23 | - |   → 데이터 우선순위 (프롬프트 > 스킬 파일) |
| 2026-01-23 | - |   → 월운 해석 규칙 |
| 2026-01-23 | - |   → 신살 해석 규칙 |
| 2026-01-23 | - |   → 건강운 체크리스트 |
| 2026-01-23 | - |   → 해석 템플릿 |
| 2026-01-23 | - | - **프로젝트에서 유지할 것**: |
| 2026-01-23 | - |   → 실전 적용 예시 (신광민 케이스) |
| 2026-01-23 | - |   → 자주 상충하는 조합 3가지 |
| 2026-01-23 | - |   → 절대 금지 예시 |
| 2026-01-23 | - |   → 고급 팁 |
| 2026-01-23 | - | - **최종 구조 (15개 섹션)**: |
| 2026-01-23 | - |   1. 핵심 원칙 / 2. 데이터 우선순위 / 3. 종합 해석 원칙 |
| 2026-01-23 | - |   4. 카테고리별 체크리스트 / 5. 상충 해석 공식 |
| 2026-01-23 | - |   6. 월운 해석 규칙 / 7. 신살 해석 규칙 / 8. 해석 템플릿 |
| 2026-01-23 | - |   9. 실전 예시 / 10. 자주 상충하는 조합 |
| 2026-01-23 | - |   11. 작성 체크리스트 / 12. 절대 금지 / 13. 고급 팁 / 14. 마무리 |
| 2026-01-23 | - | - **결과**: 382줄 통합 파일 완성 |
| 2026-01-23 | - | - **상태**: ✅ 완료 |
| 2026-01-23 | 오후 | **1️⃣5️⃣ 프롬프트 해석 규칙 추가** |
| 2026-01-23 | - | - **파일**: `/사주/앱/5_prompt.html` |
| 2026-01-23 | - | - **추가 내용**: 해석 전 필수 규칙 (맨 앞에) |
| 2026-01-23 | - |   → 스킬 파일 먼저 읽기, 데이터 우선순위, 종합 해석 원칙, 카테고리별 체크 |
| 2026-01-23 | - | - **배포 완료**: ✅ |
| 2026-01-22 | 오후 | **1️⃣4️⃣ 새로고침 시 결과 데이터 초기화 버그 수정** |
| 2026-01-22 | - | - **문제**: 변환시작으로 생성한 사주계산결과, 인연상, 프롬프트가 새로고침하면 사라짐 |
| 2026-01-22 | - | - **원인**: `syncSheetsToSupabase()`가 Google Sheets 데이터로 Supabase 덮어씀 |
| 2026-01-22 | - | - **해결**: `syncSheetsToSupabase`에서 모든 결과 데이터 필드 동기화 제외 |
| 2026-01-22 | - |   → 상태: `status`, `paymentStatus`, `paymentDate` |
| 2026-01-22 | - |   → 변환결과: `sajuResult`, `promptResult`, `inyeonCalcResult`, `inyeonHTML` |
| 2026-01-22 | - |   → MD결과: `mdResult`, `mdStatus`, `mdMessage`, `mdVerifyResult` |
| 2026-01-22 | - |   → 기타: `mainResultText`, `resultUrl`, `additionalResultText`, `additionalResultUrl` |
| 2026-01-22 | - | - **배포 완료**: ✅ 관리자페이지 배포 완료 |
| 2026-01-22 | 오전 | **1️⃣3️⃣ 새로고침 시 상태 초기화 버그 수정** |
| 2026-01-22 | - | - **문제**: 고객 상태를 "입금확인"으로 변경 후 새로고침하면 "신규"로 돌아감 |
| 2026-01-22 | - | - **해결**: `syncSheetsToSupabase`에서 status 관련 필드 동기화 제외 |
| 2026-01-22 | - | - **배포 완료**: ✅ (1️⃣4️⃣에서 함께 배포됨) |
| 2026-01-22 | 새벽 | **1️⃣2️⃣ 프롬프트에 종합해석 규칙 추가** |
| 2026-01-22 | - | - **파일**: `/사주/앱/5_prompt.html` |
| 2026-01-22 | - | - **배경**: 09_종합해석_원칙.md 가이드를 프롬프트에도 반영 |
| 2026-01-22 | - | - **추가 위치 1**: "종합 해석 공식" 뒤 (line 2066) |
| 2026-01-22 | - |   → 6단계 체크리스트 (일간→십성→오행→격국→신살→상충점) |
| 2026-01-22 | - |   → 상충 해석 규칙: 반대 방향 가리키면 둘 다 설명 |
| 2026-01-22 | - |   → 실전 예시 3가지 (상관격+양인살, 비겁+협록, 화개살+장성살) |
| 2026-01-22 | - |   → 금지/필수 표현 가이드 |
| 2026-01-22 | - | - **추가 위치 2**: 연애운/직업운/재물운 섹션 (line 2165-2210) |
| 2026-01-22 | - |   → 연애운 체크리스트 (재성/관성, 일지, 비겁, 신살, 상충점) |
| 2026-01-22 | - |   → 직업운 체크리스트 (격국, 십성, 신살, 용신, 상충점) |
| 2026-01-22 | - |   → 재물운 체크리스트 (재성, 비겁, 식상생재, 용신, 상충점) |
| 2026-01-22 | - |   → 각 카테고리별 상충 해석 예시 포함 |
| 2026-01-22 | - | - **효과**: 이제 Gemini가 MD 생성 시 종합해석 원칙 자동 적용 |
| 2026-01-22 | - | - **다음**: 관리자페이지 배포 필요 |
| 2026-01-21 | 밤 | **1️⃣1️⃣ 종합해석 원칙 가이드 생성** |
| 2026-01-21 | - | - **배경**: Claude Projects에서 더 정확한 해석을 받음 (심층사고모드 활용) |
| 2026-01-21 | - | - **문제점**: 상충하는 요소가 있을 때 하나만 선택해서 단정적으로 해석 |
| 2026-01-21 | - |   → 예: "비겁 과다"만 보고 "혼자 하는 게 좋음" 결론 |
| 2026-01-21 | - |   → 실제로는 "협록"도 있어서 "협업 시 시너지"도 있음 |
| 2026-01-21 | - | - **핵심 원칙**: 서로 다른 요소가 반대 방향을 가리키면 **둘 다 설명** |
| 2026-01-21 | - | - **생성된 가이드**: `/사주/가이드/09_종합해석_원칙.md` |
| 2026-01-21 | - |   → 상충 해석 규칙 (상관격+양인살, 비겁+협록, 화개살+장성살 등) |
| 2026-01-21 | - |   → 카테고리별 필수 체크리스트 (직업운, 연애운, 재물운) |
| 2026-01-21 | - |   → 실전 적용 예시 (잘못된 해석 vs 올바른 해석) |
| 2026-01-21 | - |   → 자주 상충하는 조합 3가지 (독립vs협업, 조직적응, 재물운) |
| 2026-01-21 | - |   → 작성 체크리스트, 절대 금지 예시, 고급 팁 |
| 2026-01-21 | - | - **적용**: 에이전트 가이드에 필수 파일로 추가 |
| 2026-01-21 | - |   → `.claude/agents/saju-result-generator.md` 업데이트 |
| 2026-01-21 | - | - ✅ 결과: 이제 MD 생성 시 양면성을 인정하고 종합적으로 해석 가능 |
| 2026-01-21 | 밤 | **🔟 월별운세 간지 오류 수정 + 가이드 생성** |
| 2026-01-21 | - | - **문제**: 월별운세 간지가 한 달씩 밀려있었음 (양력 1월을 庚寅으로 잘못 표기) |
| 2026-01-21 | - | - **원인**: 절기 기준을 제대로 반영하지 못함 (입춘 전은 아직 전년도!) |
| 2026-01-21 | - | - **정답**: 양력 1월 = 己丑 (토토의 달, 입춘 전이라 아직 2025년) |
| 2026-01-21 | - | - **해결 1**: 2026년 월별간지 가이드 파일 생성 (`/사주/가이드/2026년_월별간지.md`) |
| 2026-01-21 | - |   → 양력 기준 12개월 간지 표 (절기 포함) |
| 2026-01-21 | - |   → 용신/희신별 좋은 달 정리 |
| 2026-01-21 | - |   → 월 간지 계산 공식 및 주의사항 |
| 2026-01-21 | - | - **해결 2**: 신광민 MD 파일 월별운세 12개월 전부 수정 |
| 2026-01-21 | - |   → 1월: 庚寅 → **己丑** (토토!) |
| 2026-01-21 | - |   → 2월: 辛卯 → **庚寅** (입춘! 용신 금!) |
| 2026-01-21 | - |   → 3월: 壬辰 → **辛卯** (용신 금!) |
| 2026-01-21 | - |   → 4월: 癸巳 → **壬辰** (희신 토!) |
| 2026-01-21 | - |   → 5월: 甲午 → **癸巳** |
| 2026-01-21 | - |   → 6월: 乙未 → **甲午** (午午 자형! 번아웃 주의!) |
| 2026-01-21 | - |   → 7월: 丙申 → **乙未** (희신 토!) |
| 2026-01-21 | - |   → 8월: 丁酉 → **丙申** (용신 금!) |
| 2026-01-21 | - |   → 9월: 戊戌 → **丁酉** (용신 금! 최고의 달!) |
| 2026-01-21 | - |   → 10월: 己亥 → **戊戌** (토토!) |
| 2026-01-21 | - |   → 11월: 庚子 → **己亥** (희신 토!) |
| 2026-01-21 | - |   → 12월: 辛丑 → **庚子** (용신 금!) |
| 2026-01-21 | - | - **해결 3**: 월별 요약 수정 |
| 2026-01-21 | - |   → 최고의 달: 2월, 9월 (용신 금!) |
| 2026-01-21 | - |   → 주의할 달: 6월 (午午 자형) |
| 2026-01-21 | - | - ✅ 결과: 양력 기준으로 정확히 수정, 용신/희신과 연계 강화 |
| 2026-01-21 | - | - **추가 개선**: 2026년 전용 → 범용 가이드로 업그레이드 |
| 2026-01-21 | - |   → `2026년_월별간지.md` 삭제 |
| 2026-01-21 | - |   → `월별간지_계산법.md` 생성 (모든 년도 적용 가능!) |
| 2026-01-21 | - |   → 년간별 정월 간지 계산표 포함 (2024~2100년까지 사용 가능) |
| 2026-01-21 | - |   → 예시 5개 (2024, 2025, 2026, 2027, 2028년) |
| 2026-01-21 | - |   → 검증 방법, 실전 팁, 용신/희신 활용법 포함 |
| 2026-01-21 | - | - 📝 가이드: 다음 연도 MD 생성 시 `/사주/가이드/월별간지_계산법.md` 참고 |
| 2026-01-21 | 밤 | **9️⃣ 신살 검증 시스템 구축 완료** |
| 2026-01-21 | - | - **문제**: MD 생성 시 프롬프트에 없는 신살을 추가하는 오류 발생 (천을귀인, 원진살, 겁살) |
| 2026-01-21 | - | - **원인**: 신살 가이드에 계산법이 자세히 나와있어서 Claude가 "똑똑하게" 추가 계산함 |
| 2026-01-21 | - | - **핵심**: 프롬프트에 없는 신살은 다 거짓! 프롬프트가 이미 정확한 계산 결과 |
| 2026-01-21 | - | - **해결 1**: 신살 가이드 파일 수정 (`05_신살_48종.md`, `05_신살_검증표.md`) |
| 2026-01-21 | - |   → 맨 앞에 강력한 경고 추가: "프롬프트에 없는 신살은 다 거짓입니다" |
| 2026-01-21 | - |   → 이 가이드는 "해석용"이지 "계산용"이 아님 명시 |
| 2026-01-21 | - | - **해결 2**: 에이전트 가이드 강화 (`.claude/agents/saju-result-generator.md`) |
| 2026-01-21 | - |   → 절대 금지 사항 1순위로 명시 |
| 2026-01-21 | - |   → 검증 체크리스트 추가 (치명적 오류 / 중요 확인 / 스타일) |
| 2026-01-21 | - | - **해결 3**: 검증 스크립트 생성 (`/사주/verify-manual-md.js`) |
| 2026-01-21 | - |   → 프롬프트와 MD 파일을 비교하여 오행, 신살, 이름 검증 |
| 2026-01-21 | - |   → `--fix` 옵션으로 오행/이름 자동 수정 가능 |
| 2026-01-21 | - |   → 신살은 경고만 (수동 수정 필요) |
| 2026-01-21 | - | - **해결 4**: 신광민 MD 파일의 잘못된 신살 수정 완료 |
| 2026-01-21 | - |   → 1053줄: "비겁 강함 + 겁살" → "비겁 강함"으로 수정 |
| 2026-01-21 | - |   → 1242줄: "천을귀인: 돼지띠, 닭띠" → 용신/희신 기반으로 완전 재작성 |
| 2026-01-21 | - |   → 1258줄: "원진살: 뱀띠" → 화 기운 기반 설명으로 변경 |
| 2026-01-21 | - | - ✅ 결과: 프롬프트에 없던 신살 3개 완전 제거, 검증 시스템 완비 |
| 2026-01-21 | 밤 | **8️⃣ 프리미엄 사주 결과지 수동 생성 완료 (신광민님)** |
| 2026-01-21 | - | - **파일**: `/사주/테스트/결과물/신광민_사주결과_프리미엄.md` |
| 2026-01-21 | - | - **고객 정보**: 신광민 (남, 2002-07-17, 丙戌 일주) |
| 2026-01-21 | - | - **일간**: 丙(병화) - 태양 / **격국**: 상관격 / **용신**: 금(金) / **희신**: 토(土) |
| 2026-01-21 | - | - **오행**: 木0.25 火3.25 土1.75 金0.25 水1 (화 과다 → 번아웃 주의) |
| 2026-01-21 | - | - **작업**: 10개 가이드 파일 참조하여 42-46페이지 프리미엄 결과지 작성 |
| 2026-01-21 | - | - **구성**: 표지, 사주명식, 일간해석, 오행/십성분포, 격국/용신, 신살, 합충형파해, 2026년운세, 월별운세, 분야별운세, 대운, 귀인, 인연상/배우자상, 용신과번아웃, 종합조언, 개인테마색상, 다음운세리마인더, 마무리 |
| 2026-01-21 | - | - **핵심**: 황금기 2029년(酉년), 2041년(酉년) / 대운전환 2033년(31세) |
| 2026-01-21 | - | - **주의**: 화 기운 과다로 번아웃 예방 루틴 필수 (금/토 기운 채우기) |
| 2026-01-21 | - | - ✅ 완성: 약 42-46페이지 분량 완료 |
| 2026-01-21 | 밤 | **7️⃣ 상태 변경 저장 안 되는 문제 해결** |
| 2026-01-21 | - | - **문제**: 고객 상태를 "신규" → "입금확인"으로 변경했는데 새로고침하면 다시 "신규"로 돌아감 |
| 2026-01-21 | - | - **원인**: 상태 변경 시 백그라운드로 서버 저장 (await 없음) → 사용자가 빠르게 새로고침 → 서버 저장 완료 전에 이전 데이터 로드 → localStorage 덮어씀 |
| 2026-01-21 | - | - **해결**: `updateStatus()` 함수에서 `await syncStatusToSheets()` 추가 (index.html 7653번 줄) |
| 2026-01-21 | - | - UI는 즉시 업데이트되지만, 내부적으로는 서버 저장 완료까지 대기 |
| 2026-01-21 | - | - **추가**: Supabase 업데이트 디버깅 로그 추가 (전송 데이터, 성공/실패 여부 콘솔 표시) |
| 2026-01-21 | - | - 배포 완료: 이제 상태 변경 후 바로 새로고침해도 데이터 유지됨 ✅ |
| 2026-01-21 | 저녁 | **4️⃣ Supabase admins 테이블 문제 해결** |
| 2026-01-21 | - | - **문제**: 관리자 저장 시 Supabase에 400 에러 (email, notify_대기 등 컬럼 없음) |
| 2026-01-21 | - | - **원인**: Google Sheets "관리자" 시트와 Supabase admins 테이블 구조 불일치 |
| 2026-01-21 | - | - **해결**: Supabase admins 저장 기능 **완전 비활성화** (Google Sheets만 사용) |
| 2026-01-21 | - | - index.html 8095줄: `supabaseUpsertAdmin()` 호출 주석 처리 |
| 2026-01-21 | - | - index.html 7940줄: 관리자 목록 로드 시 Supabase 동기화 주석 처리 |
| 2026-01-21 | - | - CLAUDE.md에 Supabase admins 테이블 사용 안 함 명시 |
| 2026-01-21 | - | **5️⃣ Supabase customers 숫자 필드 추가 수정** |
| 2026-01-21 | - | - 숫자 필드에 `custom_longitude`, `custom_utc_offset` 추가 |
| 2026-01-21 | - | - null, undefined도 체크하도록 수정 |
| 2026-01-21 | - | **6️⃣ CLAUDE.md Supabase 테이블 구조 완전 문서화** |
| 2026-01-21 | - | - `customers` 테이블: 숫자 필드 주의사항 추가 |
| 2026-01-21 | - | - `admins` 테이블: 사용 안 함 + 없는 컬럼 목록 명시 |
| 2026-01-21 | - | - `settings` 테이블: 구조 및 사용 예시 추가 |
| 2026-01-21 | 오후 | **✅ 모든 문제 완전 해결 완료!** |
| 2026-01-21 | - | **1️⃣ Apps Script 계정 이전 + 권한 오류 해결** |
| 2026-01-21 | - | - Apps Script 소유권 이전 (beautamin1@gmail.com → plizlisttreeandflower@gmail.com) |
| 2026-01-21 | - | - Code.js 수정: `getActiveSpreadsheet()` → `openById(SPREADSHEET_ID)` (40+ 곳) |
| 2026-01-21 | - | - SPREADSHEET_ID 상수 추가: `'1GLYRASMcdiIgf11rbzgXwZixtjD7AFnkxT0F3wWIgdM'` |
| 2026-01-21 | - | - 테스트 결과: 62명 고객 데이터 정상 조회 ✅ |
| 2026-01-21 | - | **2️⃣ Supabase 숫자 필드 빈 문자열 오류 수정** |
| 2026-01-21 | - | - `convertToSupabaseFormat` 함수에 숫자 필드 검증 로직 추가 (index.html 4005-4015줄) |
| 2026-01-21 | - | - 숫자 필드 목록: `birth_year`, `birth_month`, `birth_day`, `birth_hour`, `birth_minute`, `phone` |
| 2026-01-21 | - | - 빈 문자열("")이면 Supabase INSERT 시 제외 처리 |
| 2026-01-21 | - | - 오류 해결: `invalid input syntax for type numeric: ""` |
| 2026-01-21 | - | - 테스트 결과: Supabase 동기화 에러 0개, 62건 정상 동기화 ✅ |
| 2026-01-21 | - | **3️⃣ 관리자페이지 배포 완료** |
| 2026-01-21 | - | - Netlify 배포 성공: https://saju-admin.netlify.app |
| 2026-01-21 | - | - 엑셀 → Supabase 동기화 정상 작동 확인 |
| 2026-01-21 | - | - 실행현황.md 업데이트 완료 |
| 2026-01-21 | - | **🚨 긴급 수정: 입력폼 Supabase 저장 실패 문제 해결** |
| 2026-01-21 | - | - Apps Script URL 업데이트 (권한 변경으로 인한 URL 변경) |
| 2026-01-21 | - | - `birth_latitude` 컬럼 제거 (Supabase 테이블에 없는 컬럼으로 INSERT 실패 원인) |
| 2026-01-21 | - | - CLAUDE.md에 Supabase `customers` 테이블 전체 구조 문서화 |
| 2026-01-21 | - | - 배포 완료: 관리자페이지 + 입력폼 (신규 고객 데이터 정상 저장 가능) |
| 2026-01-21 | - | **🔧 추가 수정: 엑셀 → Supabase 동기화 실패 문제 해결** |
| 2026-01-21 | - | - `allowedFields`에 위치 정보 컬럼 추가 (birth_country, birth_city, custom_longitude, custom_utc_offset) |
| 2026-01-21 | - | - `mapping` 및 `convertFromSupabaseFormat`에도 위치 정보 매핑 추가 |
| 2026-01-21 | - | - 관리자페이지 재배포 완료 (새로고침 시 엑셀 데이터 정상 동기화) |
| 2026-01-21 | - | **🚨 최종 수정: 관리자페이지 Google Sheets URL 업데이트** |
| 2026-01-21 | - | - `SAJU_CONFIG.googleSheets.webAppUrl` 예전 URL → 새 URL 변경 |
| 2026-01-21 | - | - 관리자페이지 최종 배포 완료 |
| 2026-01-21 | - | - **모든 문제 해결 완료 (입력폼 + 관리자페이지 + 동기화)** |
| 2026-01-20 | - | **재시도 로직 추가**: generate-md-background.js에 429 에러 자동 재시도 (최대 3번, 1분/2분/3분 대기) + 배포 완료 |
| 2026-01-20 | - | **실행현황 정정**: MD 테스트 "성공" → "실패" (Gemini API 할당량 초과), Supabase 확인 결과 성공한 MD 0개 |
| 2026-01-20 | - | **버그 수정**: `mdReviewBtn` → `mdViewBtn` ID 불일치 수정 (고객 선택 안 되는 문제) |
| 2026-01-20 | - | **버그 수정**: 데이터 상태 아이콘 null 안전 처리 (`String()` 사용) |
| 2026-01-19 | - | **📄 MD 보기 버튼 추가** (Supabase에서 저장된 MD 불러와서 미리보기) |
| 2026-01-19 | - | **고객 목록에 데이터 상태 아이콘 추가** (🔮사주 📝프롬프트 💘인연상 ✨MD) |
| 2026-01-19 | - | 자동 기록 훅 추가 (PostToolUse: auto-record.sh) |
| 2026-01-19 | - | generate-md-background.js: Supabase 저장 실패 시 에러 throw |
| 2026-01-19 | - | generate-md-background.js: Google Sheets 실패해도 completed 처리 |
| 2026-01-19 | - | 인연상 저장 코드 확인 (정상, 변환시작 재실행 필요) |
| 2026-01-18 | 22:40 | CLAUDE.md에 맥 명령어 섹션 추가 |
| 2026-01-18 | 22:30 | Gemini 모델명 수정: gemini-1.5-flash → gemini-2.0-flash |
| 2026-01-18 | 22:20 | lucky-cactus 입력폼 재배포 (index.html 복사) |
| 2026-01-18 | 22:00 | API_KEYS.md + 오류해결.md → CLAUDE.md 통합 |
| 2026-01-18 | 21:30 | Netlify 환경변수 수정 (SUPABASE_URL, SUPABASE_KEY) |
| 2026-01-18 | 21:00 | **MD 생성 테스트 성공!** (30KB 결과 Supabase 저장) |
| 2026-01-17 | 20:15 | Netlify 배포 완료 (OneDrive 동기화 문제 해결) |
| 2026-01-17 | - | 코드 수정: orders → customers |
| 2026-01-17 | - | customers 테이블에 MD 컬럼 추가 (마이그레이션) |
| 2026-01-17 | - | Supabase MCP 연결 |
| 2026-01-17 | - | 인연상 Supabase 저장 코드 추가 |
| 2026-01-17 | - | Apps Script updateMdResult 추가 (v70 배포) |
| 2026-01-17 | - | Gemini API로 변경 (Anthropic 미결제) |
| 2026-01-17 | - | MD 백그라운드 생성 시스템 구현 |

---

## 에러 기록

### 2026-01-21: Apps Script 권한 오류 ✅ 해결

**증상:**
- 관리자페이지 새로고침 시 엑셀 데이터 안 불러옴
- Apps Script URL 호출 시 에러 페이지 반환

**에러 메시지:**
```
Exception: 요청한 문서를 액세스할 권한이 없습니다.(Code 파일, 70행)
```

**원인:**
- Apps Script의 `SpreadsheetApp.getActiveSpreadsheet()` 권한 오류
- Code.js 70번 줄에서 실패
- Apps Script 계정 변경 필요 (beautamin1 → plizlisttreeandflower)

**해결:**
- [x] Apps Script 계정 이전 (plizlisttreeandflower@gmail.com)
- [x] Code.js 수정: `getActiveSpreadsheet()` → `openById(SPREADSHEET_ID)` (40+ 곳)
- [x] SPREADSHEET_ID 상수 추가: `'1GLYRASMcdiIgf11rbzgXwZixtjD7AFnkxT0F3wWIgdM'`
- [x] 저장 및 배포 완료

**결과:**
- ✅ 엑셀 데이터 정상 조회 (김성호 외 62명)
- ✅ 새로고침 버튼 정상 작동
- ✅ 권한 오류 완전 해결

---

### 2026-01-21: Supabase 숫자 필드 오류 ✅ 해결

**증상:**
- 새로고침 시 Supabase INSERT 에러 반복 발생
- `invalid input syntax for type numeric: ""`

**원인:**
- `birth_hour`, `birth_minute`, `phone` 등 숫자 필드에 빈 문자열("") 저장 시도
- Supabase는 숫자 타입 컬럼에 빈 문자열 허용 안 함

**해결:**
- [x] `convertToSupabaseFormat` 함수 수정 (index.html 4005-4020번 줄)
- [x] 숫자 필드 목록: `birth_year`, `birth_month`, `birth_day`, `birth_hour`, `birth_minute`, `phone`, `custom_longitude`, `custom_utc_offset`
- [x] 빈 문자열, null, undefined이면 제외 처리
- [x] 관리자페이지 배포 완료

**결과:**
- ✅ Supabase 동기화 오류 0개
- ✅ 62건 정상 동기화 완료

---

### 2026-01-21: Supabase admins 테이블 구조 불일치 ✅ 해결

**증상:**
- 관리자 저장 시 Supabase에 400 에러
- `Could not find the 'email' column`
- `Could not find the 'notify_대기' column`

**원인:**
- Google Sheets "관리자" 시트와 Supabase admins 테이블의 컬럼 구조가 완전히 다름
- Supabase admins 테이블에 없는 컬럼: `email`, `role`, `notify_대기` 등

**해결:**
- [x] Supabase admins 저장 기능 **완전 비활성화**
- [x] Google Sheets만 사용 (Apps Script로 관리)
- [x] index.html 8095줄: `supabaseUpsertAdmin()` 주석 처리
- [x] index.html 7940줄: 관리자 목록 Supabase 동기화 주석 처리
- [x] CLAUDE.md에 admins 테이블 사용 안 함 명시

**결과:**
- ✅ 관리자 저장/수정 400 에러 해결
- ✅ Google Sheets로 정상 작동

---

### 2026-01-21: 관리자페이지 Google Sheets URL 오류 ✅ 해결

**증상:**
- 새로고침 눌러도 엑셀 데이터 안 보임
- 입력폼은 정상 작동하지만 관리자페이지에서 안 보임

**원인:**
- `index.html` 3663번 줄: `SAJU_CONFIG.googleSheets.webAppUrl`이 예전 URL

**해결:**
```javascript
// 변경 전
webAppUrl: "https://script.google.com/macros/s/AKfycbzlnTB3d3tO...clA/exec"

// 변경 후 (2026-01-21)
webAppUrl: "https://script.google.com/macros/s/AKfycbzRYF_BnoFi8A...7Q/exec"
```
- [x] 관리자페이지 배포 완료
- [x] **하지만 Apps Script 권한 오류로 여전히 작동 안 함**

---

### 2026-01-21: 엑셀 → Supabase 동기화 실패 ✅ 해결

**증상:**
- 새로고침 시 엑셀 데이터가 Supabase에 동기화 안 됨
- 위치 정보가 누락됨

**원인:**
- `convertToSupabaseFormat` 함수의 `allowedFields`에 위치 정보 컬럼 없음
- `birth_country`, `birth_city`, `custom_longitude`, `custom_utc_offset` 매핑 누락

**해결:**
- [x] `allowedFields` 배열에 위치 정보 4개 컬럼 추가
- [x] `mapping` 객체에 camelCase → snake_case 매핑 추가
- [x] `convertFromSupabaseFormat`에도 동일하게 추가
- [x] 관리자페이지 배포 완료

---

### 2026-01-21: 입력폼 → Supabase 저장 실패 (2주간 신규 고객 누락!) ✅ 해결

**증상:**
- 신규 고객 신청 데이터가 Google Sheets에는 들어오지만 관리자페이지에 안 보임
- Supabase 최신 데이터: 2026-01-07 (신동욱) - 2주간 신규 데이터 없음
- 새로고침 버튼 눌러도 신규 고객 안 나타남

**원인 분석:**
1. **입력폼의 Supabase INSERT 실패** (조용히 실패해서 알 수 없었음)
2. `birth_latitude` 컬럼이 **Supabase 테이블에 없음**
3. 잘못된 컬럼으로 INSERT 시도 → 실패 → console.log만 하고 계속 진행

**Supabase 실제 컬럼:**
- ✅ `birth_country`, `birth_city`, `custom_longitude`, `custom_utc_offset`
- ❌ `birth_latitude` (없음!)

**해결:**
- [x] `1_input.html` 2288번 줄 `birth_latitude` 제거
- [x] `배포/input-form/index.html` 동일 수정
- [x] CLAUDE.md에 `customers` 테이블 전체 구조 문서화
- [x] 관리자페이지 + 입력폼 배포 완료

**배포 URL:**
- 관리자페이지: https://saju-admin.netlify.app
- 입력폼: https://lucky-cactus-b5f9e6.netlify.app

---

### 2026-01-20: MD 테스트 결과 확인 - 실제로는 실패했음

**증상:**
- 실행현황.md에 "MD 생성 테스트 성공! 30KB 저장"이라고 기록되어 있었음
- 하지만 Supabase에 성공한 MD 데이터가 없음

**실제 상황 (Supabase 확인 결과):**
- 신동욱 (id: 507) - md_status: "error"
- 에러: Gemini API 할당량 초과 (429 Too Many Requests)
- 7개 섹션 중 6개 생성 후 "맞춤답변+마무리" 섹션에서 중단
- 생성 시도: 2026-01-18 13:38

**통계:**
- MD 성공 (completed): 0개
- MD 실패 (error): 1개
- MD 미시도: 60개

**문제점:**
- Gemini API Rate Limit (분당 요청 수 제한)
- 7개 섹션을 빠르게 연속 요청하면 6번째 이후 차단됨

**해결 방법:** ✅ (2026-01-20)
- [x] 재시도 로직 추가 (429 에러 감지 시 자동 재시도)
- [x] 최대 3번 재시도, 대기 시간: 1분 → 2분 → 3분
- [x] Netlify 배포 완료

---

### 2026-01-18: Netlify 환경변수 + Gemini 모델 오류

**증상 1: MD 생성 시 Supabase 연결 실패**
- `null` 상태로 md_status가 변경되지 않음

**원인:**
- Netlify 환경변수에 이전 Supabase 프로젝트 URL/KEY가 저장되어 있었음
- `lgebgmchjmceyzrqawzl` (X) → `hvxacycvwfwhzfqftscx` (O)

**해결:**
```bash
npx netlify env:set SUPABASE_URL "https://hvxacycvwfwhzfqftscx.supabase.co"
npx netlify env:set SUPABASE_KEY "새_ANON_KEY"
```

---

**증상 2: Gemini API 모델 오류**
- `models/gemini-1.5-flash is not found for API version v1beta`

**원인:**
- `gemini-1.5-flash` 모델이 deprecated 됨

**해결:**
- `generate-md-background.js`에서 모델명 변경: `gemini-1.5-flash` → `gemini-2.0-flash`

---

### 2026-01-18: lucky-cactus 사이트 잘못된 콘텐츠 배포

**증상:**
- https://lucky-cactus-b5f9e6.netlify.app 에 관리자페이지가 배포됨

**원인:**
- netlify.toml의 base path가 `사주/앱`으로 되어 있어서 deploy 시 관리자페이지 폴더가 배포됨

**해결:**
```bash
# 최신 입력폼 복사
cp 사주/앱/1_input.html 사주/배포하는곳/input-form/index.html

# 입력폼 폴더에서 직접 배포
cd 사주/배포하는곳/input-form && npx netlify deploy --prod --dir=.
```

---

### 2026-01-17: OneDrive 동기화 + Netlify 배포 문제

**증상:**
- `npx netlify deploy --prod` 실행 시 `ETIMEDOUT` 에러
- `cat`, 파일 읽기 시 `Operation timed out`

**원인:**
1. OneDrive 동기화 불안정 - `.netlify/state.json` 파일이 클라우드에만 있고 로컬에 없음
2. `.netlify/state.json`에 잘못된 siteId 저장됨

**해결:**
1. `state.json` 삭제 후 재생성
2. 올바른 siteId 확인: `npx netlify sites:list`
3. siteId 수정: `e8e114d5-fcee-477a-ac3c-cfe253dc2ea3`

**명령어:**
```bash
# siteId 확인
npx netlify sites:list | grep -A3 "saju-admin"

# state.json 재생성
echo '{"siteId":"e8e114d5-fcee-477a-ac3c-cfe253dc2ea3"}' > .netlify/state.json
```
